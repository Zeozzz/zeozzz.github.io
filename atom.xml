<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>澈崽子 | 家有网工初长成</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zeozzz.github.com/"/>
  <updated>2020-08-07T13:31:57.992Z</updated>
  <id>https://zeozzz.github.com/</id>
  
  <author>
    <name>澈崽子</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>新征程</title>
    <link href="https://zeozzz.github.com/2020/08/07/77/"/>
    <id>https://zeozzz.github.com/2020/08/07/77/</id>
    <published>2020-08-07T13:27:19.000Z</published>
    <updated>2020-08-07T13:31:57.992Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>新征程马上起航！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>TCP的几个状态 (SYN, FIN, ACK, PSH, RST, URG)</title>
    <link href="https://zeozzz.github.com/2019/09/09/76/"/>
    <id>https://zeozzz.github.com/2019/09/09/76/</id>
    <published>2019-09-09T07:46:18.000Z</published>
    <updated>2020-01-21T02:11:42.281Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在TCP层，有个FLAGS字段，这个字段有以下几个标识：SYN, FIN, ACK, PSH, RST, URG.</p><p>其中，对于我们日常的分析有用的就是前面的五个字段。</p><p>它们的含义是：</p><p>SYN表示建立连接，</p><p>FIN表示关闭连接，</p><p>ACK表示响应，</p><p>PSH表示有 DATA数据传输，</p><p>RST表示连接重置。</p><p>其中，ACK是可能与SYN，FIN等同时使用的，比如SYN和ACK可能同时为1，它表示的就是建立连接之后的响应，</p><p>如果只是单个的一个SYN，它表示的只是建立连接。</p><p>TCP的几次握手就是通过这样的ACK表现出来的。</p><p>但SYN与FIN是不会同时为1的，因为前者表示的是建立连接，而后者表示的是断开连接。</p><p>RST一般是在FIN之后才会出现为1的情况，表示的是连接重置。</p><a id="more"></a><p>一般地，当出现FIN包或RST包时，我们便认为客户端与服务器端断开了连接；而当出现SYN和SYN＋ACK包时，我们认为客户端与服务器建立了一个连接。</p><p>PSH为1的情况，一般只出现在 DATA内容不为0的包中，也就是说PSH为1表示的是有真正的TCP数据包内容被传递。</p><p>TCP的连接建立和连接关闭，都是通过请求－响应的模式完成的。</p><p>概念补充-TCP三次握手：</p><p>TCP(Transmission Control Protocol)传输控制协议</p><p>TCP是主机对主机层的传输控制协议，提供可靠的连接服务，采用三次握手确认建立一个连接：</p><p>位码即tcp标志位，有6种标示：SYN(synchronous建立联机) ACK(acknowledgement 确认) PSH(push传送) FIN(finish结束) RST(reset重置) URG(urgent紧急)Sequence number(顺序号码) Acknowledge number(确认号码)</p><p>第一次握手：主机A发送位码为syn＝1，随机产生seq number=1234567的数据包到服务器，主机B由SYN=1知道，A要求建立联机；</p><p>第二次握手：主机B收到请求后要确认联机信息，向A发送ack number=(主机A的seq+1)，syn=1，ack=1，随机产生seq=7654321的包；</p><p>第三次握手：主机A收到后检查ack number是否正确，即第一次发送的seq number+1，以及位码ack是否为1，若正确，主机A会再发送ack number=(主机B的seq+1)，ack=1，主机B收到后确认seq值与ack=1则连接建立成功。</p><p>完成三次握手，主机A与主机B开始传送数据。</p><p>在TCP/IP协议中，TCP协议提供可靠的连接服务，采用三次握手建立一个连接。<br>第一次握手：建立连接时，客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；<br>第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；<br>第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。完成三次握手，客户端与服务器开始传送数据.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在TCP层，有个FLAGS字段，这个字段有以下几个标识：SYN, FIN, ACK, PSH, RST, URG.&lt;/p&gt;
&lt;p&gt;其中，对于我们日常的分析有用的就是前面的五个字段。&lt;/p&gt;
&lt;p&gt;它们的含义是：&lt;/p&gt;
&lt;p&gt;SYN表示建立连接，&lt;/p&gt;
&lt;p&gt;FIN表示关闭连接，&lt;/p&gt;
&lt;p&gt;ACK表示响应，&lt;/p&gt;
&lt;p&gt;PSH表示有 DATA数据传输，&lt;/p&gt;
&lt;p&gt;RST表示连接重置。&lt;/p&gt;
&lt;p&gt;其中，ACK是可能与SYN，FIN等同时使用的，比如SYN和ACK可能同时为1，它表示的就是建立连接之后的响应，&lt;/p&gt;
&lt;p&gt;如果只是单个的一个SYN，它表示的只是建立连接。&lt;/p&gt;
&lt;p&gt;TCP的几次握手就是通过这样的ACK表现出来的。&lt;/p&gt;
&lt;p&gt;但SYN与FIN是不会同时为1的，因为前者表示的是建立连接，而后者表示的是断开连接。&lt;/p&gt;
&lt;p&gt;RST一般是在FIN之后才会出现为1的情况，表示的是连接重置。&lt;/p&gt;
    
    </summary>
    
    
      <category term="wireshark" scheme="https://zeozzz.github.com/categories/wireshark/"/>
    
    
      <category term="wireshark" scheme="https://zeozzz.github.com/tags/wireshark/"/>
    
  </entry>
  
  <entry>
    <title>wireshark分析网站打开过程</title>
    <link href="https://zeozzz.github.com/2019/08/28/75/"/>
    <id>https://zeozzz.github.com/2019/08/28/75/</id>
    <published>2019-08-28T07:22:53.000Z</published>
    <updated>2020-01-21T09:30:14.811Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近在看数字证书，https相关的知识，发现之前也是模棱两可的了解，一点都不深入，这篇文章从DNS解析开始，分析打开https的网站从开始到结束的过程。</p><p><img src="https://image01.zhang-zhe.cn/20190904105254.png" loading="lazy"></p><p>在从地址栏敲入域名之后，首先进行DNS的域名解析，抓包如下：</p><p><img src="https://image01.zhang-zhe.cn/20190904105458.png" loading="lazy"></p><p>1、DNS请求&amp;DNS解析阶段</p><p>​    1.1、本机向DNS服务器发起DNS解析请求，使用UDP协议，报文结构如下：</p><p>​    <img src="https://image01.zhang-zhe.cn/20190904105608.png" loading="lazy"></p><p>​    1.2、服务器向客户端发送请求的结果，同样使用UDP协议，报文结构如下：</p><p><img src="https://image01.zhang-zhe.cn/20190904105909.png" loading="lazy"></p><p>​    <a id="more"></a></p><p>​    1.3、answers结果如下：</p><p>​    由于网站托管在又拍云上，部署了CDN，所以先回返回一个cname的解析结果到我绑定的域名。</p><p><img src="C:\Users\zhangzhe23\AppData\Roaming\Typora\typora-user-images\1567566039341.png" alt="1567566039341" loading="lazy"></p><p>至此，DNS解析的阶段已经完成，只有两个包，客户端得到了服务端的IP地址，61.179.240.145</p><p>接下来就是客户端与服务端的交换。</p><p>3、开始进行TCP三次握手，抓包如下：</p><p><img src="https://image01.zhang-zhe.cn/20190904110407.png" loading="lazy"></p><p>图中可以看到，TCP三次握手已经完成，连接建立，在此大概说一下TCP三次握手的流程，可以参考下文链接。</p><p>原文链接：<a href="https://juejin.im/post/5b29d2c4e51d4558b80b1d8c">https://juejin.im/post/5b29d2c4e51d4558b80b1d8c</a> </p><p>4、建立过后，开始进行数据的传输</p><p>因为网站使用了https加密，在wireshark中使用追踪TLS流的功能进行过滤，所以可以看到如下报文：</p><p><img src="https://image01.zhang-zhe.cn/20190904140335.png" loading="lazy"></p><p>我们关注图中TLSV1.2的报文即可，报文记录了SSL握手从开始到结束的全过程，这也是笔者最近学习的，下面只是个人的理解，如有纰漏还请指出。</p><p><img src="https://image01.zhang-zhe.cn/20190904112100.png" loading="lazy"></p><p>​        4.1、客户端发起client hello请求。</p><p>​        <img src="https://image01.zhang-zhe.cn/20190904112246.png" loading="lazy"></p><p>​        其中包括了，浏览器给出协议的版本号为TLS 1.2，一个客户端生成的random随机数</p><p>​        <img src="https://image01.zhang-zhe.cn/20190904112708.png" loading="lazy"></p><p>​        支持下列加密算法。</p><p>​        <img src="https://image01.zhang-zhe.cn/20190904112642.png" loading="lazy"></p><p>​        其他相关参数。</p><p>​        <img src="https://image01.zhang-zhe.cn/20190904140238.png" loading="lazy"></p><p>​        签名算法，服务器名称等等。</p><p>​        </p><p>​        汇总来说，这一步进行了下列操作。</p><p>​        TLS的版本</p><p>​        随机数：这个是用来生成最后加密密钥的影响因子之一，包含两部分：时间戳（4-Bytes）和随机数（28-Bytes）</p><p>​        session-id：用来表明一次会话，第一次建立没有。如果以前建立过，可以直接带过去。后面的扩展内容会详细讲到。</p><p>​        加密算法套装列表：客户端支持的加密-签名算法的列表，让服务器去选择。</p><p>​        压缩算法：似乎一般都不用扩展字段：比如密码交换算法的参数、请求主机的名字等等</p><p>​    4.2、服务端响应Server hello给客户端。</p><p>​    <img src="https://image01.zhang-zhe.cn/20190904140420.png" loading="lazy"></p><p>​    其中包含的信息和client hello有异曲同工之妙。</p><p>​    4.3、服务端server hello完成。</p><p>​    <img src="https://image01.zhang-zhe.cn/20190904141337.png" loading="lazy"></p><p>​    这个报文中包含了两方面的信息，一个是</p><p>​    </p><p>​    写一半太忙，不想写了，这篇文章写得比我好。</p><p>​    <a href="https://www.jianshu.com/p/a3a25c6627ee">https://www.jianshu.com/p/a3a25c6627ee</a></p><p><img src="https://image01.zhang-zhe.cn/20190904144256.png" loading="lazy"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在看数字证书，https相关的知识，发现之前也是模棱两可的了解，一点都不深入，这篇文章从DNS解析开始，分析打开https的网站从开始到结束的过程。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://image01.zhang-zhe.cn/20190904105254.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;在从地址栏敲入域名之后，首先进行DNS的域名解析，抓包如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://image01.zhang-zhe.cn/20190904105458.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;1、DNS请求&amp;amp;DNS解析阶段&lt;/p&gt;
&lt;p&gt;​    1.1、本机向DNS服务器发起DNS解析请求，使用UDP协议，报文结构如下：&lt;/p&gt;
&lt;p&gt;​    &lt;img src=&quot;https://image01.zhang-zhe.cn/20190904105608.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;​    1.2、服务器向客户端发送请求的结果，同样使用UDP协议，报文结构如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://image01.zhang-zhe.cn/20190904105909.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;​
    
    </summary>
    
    
      <category term="wireshark" scheme="https://zeozzz.github.com/categories/wireshark/"/>
    
    
      <category term="wireshark" scheme="https://zeozzz.github.com/tags/wireshark/"/>
    
  </entry>
  
  <entry>
    <title>无线AP上线中需要的option</title>
    <link href="https://zeozzz.github.com/2019/08/27/74/"/>
    <id>https://zeozzz.github.com/2019/08/27/74/</id>
    <published>2019-08-27T08:50:15.000Z</published>
    <updated>2020-01-21T09:30:44.453Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p> 　　华三AP支持的Option 43属性：</p><p>　　在L3 Switch上启用DHCP Server，正确配置Option43，例如AP属于VLAN100，是192.168.100.0/24网段，AC的IP地址为192.168.10.100/24，只支持16进制，DHCP Server配置如下：</p><p>　　[AC] dhcp server ip-pool vlan100</p><p>　　[AC-dhcp-pool-vlan100] network 192.168.100.0 mask 255.255.255.0</p><p>　　[AC-dhcp-pool-vlan100] gateway-list 192.168.100.254</p><p>　　[AC-dhcp-pool-vlan100] option 43 hex 80070000 01 C0A80A64</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">　　#80：选项类型，固定为80，1个字节。</span><br><span class="line"></span><br><span class="line">　　#07：选项长度，表示其后内容的长度(十六进制数的个数，这里表示后面有7个十六进制数，0B表示后面有11个十六进制数)，一个字节。</span><br><span class="line"></span><br><span class="line">　　#0000：Server type，固定配为0000两个字节。</span><br><span class="line"></span><br><span class="line">　　#01：后面IP地址的个数，一个字节。</span><br><span class="line"></span><br><span class="line">　　# C0A80A64： AC的IP地址192.168.10.100的十六进制表示。</span><br><span class="line"></span><br><span class="line">　　注意：dhcp server option 43的选项中最多支持下发14个ip地址，且为了满足这个最大的规格，option43的选项配置参照以下方式(每段最大4个字节，最小1个字节，大小写都可以)：</span><br><span class="line"></span><br><span class="line">　　option 43 hex 803f0000 0e c0a80a60 c0a80a61 c0a80a62 c0a80a63 c0a80a64 c0a80a65 c0a80a66 c0a80a67 c0a80a68 c0a80a69 c0a80a70 c0a80a71 c0a80a72 c0a80a73</span><br></pre></td></tr></table></figure><p>　　华为AP支持的Option 43属性：</p><p>　　AC的IP地址为192.168.10.100/24,既支持16进制又支持10进制</p><p>　　[Dhcp-hw] ip pool ap</p><p>　　[Dhcp-hw-ip-pool-huawei]network 192.168.100.0 255.255.255.0</p><p>　　[Dhcp-hw-ip-pool-huawei]gateaway-list 192.168.100.254</p><p>　　[Dhcp-hw-ip-pool-huawei]option 43 sub-option 3 hex 3139322e3136382e31302e313030 or option 43 sub-option 3 ascii 192.168.10.100</p><p>　　Sub-option 3为option 43的子类型，后面跟的16进制包含小数点一起，16进制数31对应字符“1”的ASCII值，32对应“2”的ASCII值，以此类推，2e代表“.”的值，2c代表“,”的值。</p><p>　　如果有两个AC地址的话，中间要用逗号隔开(asicc码：2c)，比如AC的IP地址为192.168.10.100和192.168.1.100.option 43属性如下：</p><p>　　[Dhcp-hw-ip-pool-huawei]option 43 sub-option 3 hex 3139322e3136382e31302e3130302c</p><p>　　3139322e3136382e312e313030 or option 43 sub-option 3 ascii 192.168.10.100，192.168.1.100</p><p>​    <a id="more"></a></p><p>　　思科AP支持的Option 43属性：</p><p>　　AC的IP地址为192.168.10.100/24,只支持16进制。</p><p>　　Dhcp-sw(config)#ip dhcp pool AP</p><p>　　Dhcp-sw(dhcp-config)#network 192.168.100.0 /24</p><p>　　Dhcp-sw(dhcp-config)#default-route 102.168.100.254</p><p>　　Dhcp-sw(dhcp-config)#option 43 hex f1040c0a80a64</p><p>　　Hex是固定的，标识为16进制，f1是固定type,04代表地址长度，一个地址4位，如果两个地址则为08，c0a80a64标识192.168.10.100</p><p>　　如果华为的交换机和思科的交换机不支持我们AP支持的option 43格式，那么我们AP就没办法识别，从而完成不了注册。</p><p>　　现场华为交换机下发的为自己AP支持的option 43的属性，而我们AP不识别，导致我们AP没有获取到AC的IP地址，出现注册不上的情况。</p><p><strong>在做WLAN工程时AP需要使用option 43方式注册到AC,下面讲解一下简单案例</strong><br><strong>注册一个192.168.1.2的AP此时option 43 hex应填数据为：80 07 00 00 01 c0 a8 01  02</strong><br><strong>下面解释一下这个结果是如何得出：</strong><br><strong>80 ：固定端口，不能改变</strong><br><strong>07：表示其后内容长度（16进制表示），这个后位是7位，16进制时还是7</strong><br><strong>0000：固定配置</strong><br><strong>01：表示只有一个IP</strong><br><strong>C0 A8 01 02：192.168.1.2的十六进制表示</strong></p><p><img src="https://s3.51cto.com/wyfs02/M01/33/E4/wKiom1OqlzrD8wuYAAFSflpEGcA131.jpg" alt="option 43.jpg" loading="lazy"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt; 　　华三AP支持的Option 43属性：&lt;/p&gt;
&lt;p&gt;　　在L3 Switch上启用DHCP Server，正确配置Option43，例如AP属于VLAN100，是192.168.100.0/24网段，AC的IP地址为192.168.10.100/24，只支持16进制，DHCP Server配置如下：&lt;/p&gt;
&lt;p&gt;　　[AC] dhcp server ip-pool vlan100&lt;/p&gt;
&lt;p&gt;　　[AC-dhcp-pool-vlan100] network 192.168.100.0 mask 255.255.255.0&lt;/p&gt;
&lt;p&gt;　　[AC-dhcp-pool-vlan100] gateway-list 192.168.100.254&lt;/p&gt;
&lt;p&gt;　　[AC-dhcp-pool-vlan100] option 43 hex 80070000 01 C0A80A64&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;　　#80：选项类型，固定为80，1个字节。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;　　#07：选项长度，表示其后内容的长度(十六进制数的个数，这里表示后面有7个十六进制数，0B表示后面有11个十六进制数)，一个字节。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;　　#0000：Server type，固定配为0000两个字节。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;　　#01：后面IP地址的个数，一个字节。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;　　# C0A80A64： AC的IP地址192.168.10.100的十六进制表示。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;　　注意：dhcp server option 43的选项中最多支持下发14个ip地址，且为了满足这个最大的规格，option43的选项配置参照以下方式(每段最大4个字节，最小1个字节，大小写都可以)：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;　　option 43 hex 803f0000 0e c0a80a60 c0a80a61 c0a80a62 c0a80a63 c0a80a64 c0a80a65 c0a80a66 c0a80a67 c0a80a68 c0a80a69 c0a80a70 c0a80a71 c0a80a72 c0a80a73&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;　　华为AP支持的Option 43属性：&lt;/p&gt;
&lt;p&gt;　　AC的IP地址为192.168.10.100/24,既支持16进制又支持10进制&lt;/p&gt;
&lt;p&gt;　　[Dhcp-hw] ip pool ap&lt;/p&gt;
&lt;p&gt;　　[Dhcp-hw-ip-pool-huawei]network 192.168.100.0 255.255.255.0&lt;/p&gt;
&lt;p&gt;　　[Dhcp-hw-ip-pool-huawei]gateaway-list 192.168.100.254&lt;/p&gt;
&lt;p&gt;　　[Dhcp-hw-ip-pool-huawei]option 43 sub-option 3 hex 3139322e3136382e31302e313030 or option 43 sub-option 3 ascii 192.168.10.100&lt;/p&gt;
&lt;p&gt;　　Sub-option 3为option 43的子类型，后面跟的16进制包含小数点一起，16进制数31对应字符“1”的ASCII值，32对应“2”的ASCII值，以此类推，2e代表“.”的值，2c代表“,”的值。&lt;/p&gt;
&lt;p&gt;　　如果有两个AC地址的话，中间要用逗号隔开(asicc码：2c)，比如AC的IP地址为192.168.10.100和192.168.1.100.option 43属性如下：&lt;/p&gt;
&lt;p&gt;　　[Dhcp-hw-ip-pool-huawei]option 43 sub-option 3 hex 3139322e3136382e31302e3130302c&lt;/p&gt;
&lt;p&gt;　　3139322e3136382e312e313030 or option 43 sub-option 3 ascii 192.168.10.100，192.168.1.100&lt;/p&gt;
&lt;p&gt;​
    
    </summary>
    
    
      <category term="无线" scheme="https://zeozzz.github.com/categories/%E6%97%A0%E7%BA%BF/"/>
    
    
      <category term="无线" scheme="https://zeozzz.github.com/tags/%E6%97%A0%E7%BA%BF/"/>
    
  </entry>
  
  <entry>
    <title>理解wireshark中的length字段含义</title>
    <link href="https://zeozzz.github.com/2019/08/22/73/"/>
    <id>https://zeozzz.github.com/2019/08/22/73/</id>
    <published>2019-08-22T02:25:04.000Z</published>
    <updated>2020-01-21T09:34:19.066Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>原文链接：<a href="https://www.louxiaohui.com/2018/06/29/understanding-the-length-field-in-wireshark/">https://www.louxiaohui.com/2018/06/29/understanding-the-length-field-in-wireshark/</a></p><p>主要介绍wireshark中的length计算方法，主要涉及MTU、MSS、常见协议头大小。</p><h2 id="length含义"><a href="#length含义" class="headerlink" title="length含义"></a>length含义</h2><p>Wireshark is showing you the length of the Ethernet frame that is handed to it, which may or may not include the FCS.</p><p>wireshark显示的长度为以太网帧的长度，不包括FCS(Frame check sequence)[帧校验序列]</p><h2 id="常见协议头大小"><a href="#常见协议头大小" class="headerlink" title="常见协议头大小"></a>常见协议头大小</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Ethernet header: 14 bytes # 数据链路层帧头大小，一般为14bytes,其为源MAC(6bytes&#x2F;48bits)+目的MAC(6bytes&#x2F;48bits)+类型&#x2F;长度(2bytes)</span><br><span class="line">IP header (standard): 20 bytes # IP头部大小</span><br><span class="line">ICMP header: 8 bytes     # ICMP头部大小</span><br><span class="line">ICMP payload: 32 bytes   # ICMP缓冲区大小，可以通过ping的-l选项指定大小，默认为32。</span><br><span class="line">FCS 4 bytes of Ethernet checksum # 帧尾CRC校验</span><br></pre></td></tr></table></figure><h2 id="length计算"><a href="#length计算" class="headerlink" title="length计算"></a>length计算</h2><p>MTU=MSS+IP header(20 bytes)+tcp header(20 bytes)</p><p>length=MTU+Ethernet header(14bytes)</p><p>其中MSS为Maximum Segment Size，即最大报文段长度，其受MTU大小影响，这里的MTU指的是三层的，二层的MTU固定为1500，不能修改。</p><p>MTU为Maximum Transmission Unit,即最大传输单元，需要注意MTU如果太小会影响收到数据包的速度，表现为下载过慢。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">三层收到大数据包时，要将数据包分片后再往下层传输，这就是IP分片原理。既然IP分片可以改变一个IP数据包的大小 ，那么IP分片怎么设置呢？</span><br><span class="line">这也是网上人们所谓的修改MTU值达到最佳网速的方法，而这里所说的修改“MTU”大小其实是IP分片的大小。</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/06/29/5b351f365f656.png" alt="2.png" loading="lazy"><img src="https://i.loli.net/2018/06/29/5b351195a1754.png" alt="1.png" loading="lazy"></p><p>从截图中可以看到MSS为1460，MTU计算后为1500，1460 + 20(IP header) + 20(tcp header) = 1500</p><h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ul><li>问题</li></ul><p>同一局域网中，同样的操作系统，同样的URL链接，同样的端口，使用ESXI虚拟出来的两台虚机，分别绑定host，使用wget测试下载速度，一个下载200K/s，一个10M/s。</p><table><thead><tr><th align="center">url</th><th align="center">IP</th><th align="center">下载速度</th><th align="center">截图</th></tr></thead><tbody><tr><td align="center"><a href="http://192.168.28.210:8989/mac_3.4.196_1530084415522.zip">http://192.168.28.210:8989/mac_3.4.196_1530084415522.zip</a></td><td align="center">192.168.28.210</td><td align="center">10M/s</td><td align="center"><img src="https://i.loli.net/2018/06/29/5b352a1874907.png" alt="1.png" loading="lazy"></td></tr><tr><td align="center"><a href="http://192.168.28.41:8989/mac_3.4.196_1530084415522.zip">http://192.168.28.41:8989/mac_3.4.196_1530084415522.zip</a></td><td align="center">192.168.28.41</td><td align="center">200K/s</td><td align="center"><img src="https://i.loli.net/2018/06/29/5b352a188d348.png" alt="2.png" loading="lazy"></td></tr></tbody></table><ul><li>解决</li></ul><a id="more"></a><p>抓包后发现：</p><p>28.41的Length为1294，MSS为1240,推断其MTU为1280</p><p>28.210的Length为1514，MSS为1460，推断其MTU为1500</p><p>猜测其网卡设置不同，进入宿主机看网卡设置，28.41的网卡类型不是E1000，28.210的E1000，将28.41的网卡类型改为E1000后测试，恢复。</p><p><img src="https://i.loli.net/2018/06/29/5b352a189d02c.png" alt="3.png" loading="lazy"> <img src="https://i.loli.net/2018/06/29/5b352a18a2889.png" alt="4.png" loading="lazy"><img src="https://i.loli.net/2018/06/29/5b352a18a4726.png" alt="5.png" loading="lazy"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://osqa-ask.wireshark.org/questions/44865/length-field">length field</a></p><p><a href="http://www.hackingarticles.in/understanding-guide-icmp-protocol-wireshark/">Understanding Guide to ICMP Protocol with Wireshark</a></p><p><a href="https://blog.csdn.net/chiyuwei1766/article/details/50762894">ireshark实战之：MTU、MSS及计算方法</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;原文链接：&lt;a href=&quot;https://www.louxiaohui.com/2018/06/29/understanding-the-length-field-in-wireshark/&quot;&gt;https://www.louxiaohui.com/2018/06/29/understanding-the-length-field-in-wireshark/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;主要介绍wireshark中的length计算方法，主要涉及MTU、MSS、常见协议头大小。&lt;/p&gt;
&lt;h2 id=&quot;length含义&quot;&gt;&lt;a href=&quot;#length含义&quot; class=&quot;headerlink&quot; title=&quot;length含义&quot;&gt;&lt;/a&gt;length含义&lt;/h2&gt;&lt;p&gt;Wireshark is showing you the length of the Ethernet frame that is handed to it, which may or may not include the FCS.&lt;/p&gt;
&lt;p&gt;wireshark显示的长度为以太网帧的长度，不包括FCS(Frame check sequence)[帧校验序列]&lt;/p&gt;
&lt;h2 id=&quot;常见协议头大小&quot;&gt;&lt;a href=&quot;#常见协议头大小&quot; class=&quot;headerlink&quot; title=&quot;常见协议头大小&quot;&gt;&lt;/a&gt;常见协议头大小&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Ethernet header: 14 bytes # 数据链路层帧头大小，一般为14bytes,其为源MAC(6bytes&amp;#x2F;48bits)+目的MAC(6bytes&amp;#x2F;48bits)+类型&amp;#x2F;长度(2bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;IP header (standard): 20 bytes # IP头部大小&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ICMP header: 8 bytes     # ICMP头部大小&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ICMP payload: 32 bytes   # ICMP缓冲区大小，可以通过ping的-l选项指定大小，默认为32。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FCS 4 bytes of Ethernet checksum # 帧尾CRC校验&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;length计算&quot;&gt;&lt;a href=&quot;#length计算&quot; class=&quot;headerlink&quot; title=&quot;length计算&quot;&gt;&lt;/a&gt;length计算&lt;/h2&gt;&lt;p&gt;MTU=MSS+IP header(20 bytes)+tcp header(20 bytes)&lt;/p&gt;
&lt;p&gt;length=MTU+Ethernet header(14bytes)&lt;/p&gt;
&lt;p&gt;其中MSS为Maximum Segment Size，即最大报文段长度，其受MTU大小影响，这里的MTU指的是三层的，二层的MTU固定为1500，不能修改。&lt;/p&gt;
&lt;p&gt;MTU为Maximum Transmission Unit,即最大传输单元，需要注意MTU如果太小会影响收到数据包的速度，表现为下载过慢。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;三层收到大数据包时，要将数据包分片后再往下层传输，这就是IP分片原理。既然IP分片可以改变一个IP数据包的大小 ，那么IP分片怎么设置呢？&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;这也是网上人们所谓的修改MTU值达到最佳网速的方法，而这里所说的修改“MTU”大小其实是IP分片的大小。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2018/06/29/5b351f365f656.png&quot; alt=&quot;2.png&quot;&gt;&lt;img src=&quot;https://i.loli.net/2018/06/29/5b351195a1754.png&quot; alt=&quot;1.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;从截图中可以看到MSS为1460，MTU计算后为1500，1460 + 20(IP header) + 20(tcp header) = 1500&lt;/p&gt;
&lt;h2 id=&quot;遇到的问题&quot;&gt;&lt;a href=&quot;#遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;遇到的问题&quot;&gt;&lt;/a&gt;遇到的问题&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;问题&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;同一局域网中，同样的操作系统，同样的URL链接，同样的端口，使用ESXI虚拟出来的两台虚机，分别绑定host，使用wget测试下载速度，一个下载200K/s，一个10M/s。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;url&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;IP&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;下载速度&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;截图&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;http://192.168.28.210:8989/mac_3.4.196_1530084415522.zip&quot;&gt;http://192.168.28.210:8989/mac_3.4.196_1530084415522.zip&lt;/a&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;192.168.28.210&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10M/s&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&lt;img src=&quot;https://i.loli.net/2018/06/29/5b352a1874907.png&quot; alt=&quot;1.png&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;http://192.168.28.41:8989/mac_3.4.196_1530084415522.zip&quot;&gt;http://192.168.28.41:8989/mac_3.4.196_1530084415522.zip&lt;/a&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;192.168.28.41&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;200K/s&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&lt;img src=&quot;https://i.loli.net/2018/06/29/5b352a188d348.png&quot; alt=&quot;2.png&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;解决&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="wireshark" scheme="https://zeozzz.github.com/categories/wireshark/"/>
    
    
      <category term="wireshark" scheme="https://zeozzz.github.com/tags/wireshark/"/>
    
  </entry>
  
  <entry>
    <title>路由协议的优先级，以及管理距离AD和metric的区别</title>
    <link href="https://zeozzz.github.com/2019/08/14/72/"/>
    <id>https://zeozzz.github.com/2019/08/14/72/</id>
    <published>2019-08-14T11:29:23.000Z</published>
    <updated>2020-01-21T09:34:35.635Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>路由协议的优先级（Preference，即<strong>管理距离**</strong>Administrative Distance**）一般为一个0到255之间的数字，数字越大则优先级越低。表一是通常情况下各路由协议的优先级规定：</p><p>表一：一般路由协议优先级</p><table><thead><tr><th>路由协议</th><th>优先级</th></tr></thead><tbody><tr><td>DIRECT</td><td>0</td></tr><tr><td>OSPF</td><td>10</td></tr><tr><td>IS-IS Level 1</td><td>15</td></tr><tr><td>IS-IS Level 2</td><td>18</td></tr><tr><td>NSFnet主干的SPF</td><td>19</td></tr><tr><td>缺省网关和EGP缺省</td><td>20</td></tr><tr><td>重定向路由</td><td>30</td></tr><tr><td>由route socket得到的路由</td><td>40</td></tr><tr><td>由网关加入的路由</td><td>50</td></tr><tr><td>路由器发现的路由</td><td>55</td></tr><tr><td>静态路由</td><td>60</td></tr><tr><td>CISCO IGRP</td><td>80</td></tr><tr><td>DCN HELLO</td><td>90</td></tr><tr><td>Berkeley RIP</td><td>100</td></tr><tr><td>点对点接口聚集的路由</td><td>110</td></tr><tr><td>Down状态的接口路由</td><td>120</td></tr><tr><td>聚集的缺省路由</td><td>130</td></tr><tr><td>OSPF的扩展路由</td><td>140</td></tr><tr><td>BGP</td><td>170</td></tr><tr><td>EGP</td><td>200</td></tr></tbody></table><p>各产品厂商可能对路由协议的优先级有不同的规定，表二、表三分别列出了华为、思科路由器路由优先级列表：</p><p>表二：华为路由器路由优先级</p><table><thead><tr><th>路由协议</th><th>优先级</th></tr></thead><tbody><tr><td>DIRECT</td><td>0</td></tr><tr><td>OSPF</td><td>10</td></tr><tr><td>STATIC</td><td>60</td></tr><tr><td>IGRP</td><td>80</td></tr><tr><td>RIP</td><td>110</td></tr><tr><td>OSPFASE</td><td>150</td></tr><tr><td>BGP</td><td>170</td></tr></tbody></table><p>表三：思科路由器路由协议优先级</p><table><thead><tr><th>路由协议</th><th>优先级</th></tr></thead><tbody><tr><td>DIRECT</td><td>0</td></tr><tr><td>STATIC</td><td>1</td></tr><tr><td>EIGRP Summary</td><td>5</td></tr><tr><td>EBGP</td><td>20</td></tr><tr><td>内部EIGRP</td><td>90</td></tr><tr><td>IGRP</td><td>100</td></tr><tr><td>OSPF</td><td>110</td></tr><tr><td>IS-IS</td><td>115</td></tr><tr><td>RIP</td><td>120</td></tr><tr><td>EGP</td><td>140</td></tr><tr><td>外部EIGRP</td><td>170</td></tr><tr><td>IBGP</td><td>200</td></tr><tr><td>未知</td><td>255</td></tr></tbody></table><p>路由的优先级的概念是优先级高的新路由协议可替代优先级低的同信宿路由，反之，则不然。</p> <a id="more"></a><p>需要区别的是路由开销（metric）和路由优先级（preference）这两个概念。metric是针对同一种路由协议而言，对不同的路由协议，由于代表的含义不同，比较不同协议的metric是无意义的，所以要在两条不同协议的同信宿路由中作出选择，只能比较路由协议的优先级。相反，preference是针对不同路由协议而言，同协议的路由的preference优先级是一般情况下一样的，这时metric是在两条同信宿路由中作出选择的标准。</p><p><strong>总结：路由优先级在不同协议时候，比较preference**</strong>的大小，而在路由协议相同时候由于preference**<strong>相同，则再比较metric**</strong>的大小，进而确定最终选择的路由。**</p><p><strong>一般在ip route**</strong>命令中静态路由中的参数“Distance metric for this route**<strong>“都是指metric**</strong>参数，而Administrative Distance**<strong>在使用不同路由协议间比较时候，都使用默认值，如上表。一般Administrative Distance**</strong>值不单独写出来，除非要更改其默认值。**</p><p>PS：对于小规模的网络，使用静态路由方式很合适，以下为cisco的静态路由配置命令：</p><p>Static Routing</p><p>　　静态路由:手动填加路由线路到路由表中,优点是:<br>1.没有额外的router的CPU负担<br>2.节约带宽<br>3.增加安全性</p><p>　　缺点是:<br>1.网络管理员必须了解网络的整个拓扑结构<br>2.如果网络拓扑发生变化,管理员要在所有的routers上手动修改路由表<br>3.不适合在大型网络中<br>　　静态路由的配置命令:ip route [dest-network] [mask] [next-hop address或exit interface][administrative distance] [permanent]<br>ip route:创建静态路由<br>dest-network:决定放入路由表的路由表<br>mask:掩码<br>next-hop address:下1跳的router地址<br>exit interface:如果你愿意的话可以拿这个来替换next-hop address,但是这个是用于点对点(point-to-point)连接上,比如广域网(WAN)连接,这个命令不会工作在LAN上<br>administrative distance:默认情况下,静态路由的管理距离是1,如果你用exit interface代替next-hop address,那么管理距离是0 <strong>（不同协议是**</strong>AD**<strong>，但是对于相同路由协议时候，是指**</strong>metric**<strong>）</strong>permanent:如果接口被shutdown了或者router不能和下1跳router通信,这条路由线路将自动从路由表中被删除.使用这个参数保证即使出现上述情况,这条路线仍然保持在路由表中。</p><p><strong>路由表中的管理距离（**</strong>Administrative Distance**<strong>）和度量值（**</strong>Metric**<strong>）</strong></p><p>R1#show ip route<br>…省略<br><strong>R    10.2.0.0[120/1] via 10.1.1.2,00:00:21,Serial0/0</strong><br>C    10.3.0.0 is directly connected,Serial0/1<br>#####################################################################<br>在输出中，首先显示路由条目各种类型的简写，如“C”为直连网络，“S”为静态路由。<br>以上面粗体的路由为例：<br>“R”————————-表示这条路由是“RIP”协议学习得到的；<br>“10.2.0.0”—————–是目的网络；<br>“[120/1]”——————-是管理距离（Administrative Distance,AD）/ 度量值（Metric）；<br>“via 10.1.1.2”————-是指到达目的网络的下一跳路由器IP地址；<br>“00:00:21”—————–是指路由器最近一次得知路由到现在的时间；<br>“Serial 0/0”—————-是指到达下一跳应从哪个端口出去。</p><p>技术要点：<br><strong>管理距离（**</strong>AD**<strong>，**</strong>Administrative Distance**<strong>）：</strong><br>       用来表示路由器可能从多种途径获得同一路由，例如，一个路由器要获得“10.2.0.0/24”网络的路由，可以来自RIP，也可以是静态路由。不同途径获得的路由可能采取不同的路径到达目的网络，为了区分不同路由协议的可信度，用管理距离加以表示。<br>       管理距离越小，说明路由的可信度越高；静态路由的管理距离为1，说明手工输入的路由优先级高于其他的路由。</p><table><thead><tr><th>路由协议</th><th>优先级</th></tr></thead><tbody><tr><td>DIRECT</td><td>0</td></tr><tr><td>STATIC</td><td>1</td></tr><tr><td>EIGRP Summary</td><td>5</td></tr><tr><td>EBGP</td><td>20</td></tr><tr><td>内部EIGRP</td><td>90</td></tr><tr><td>IGRP</td><td>100</td></tr><tr><td>OSPF</td><td>110</td></tr><tr><td>IS-IS</td><td>115</td></tr><tr><td>RIP</td><td>120</td></tr><tr><td>EGP</td><td>140</td></tr><tr><td>外部EIGRP</td><td>170</td></tr><tr><td>IBGP</td><td>200</td></tr><tr><td>未知</td><td>255</td></tr></tbody></table><p> <strong>度量值（**</strong>Metric**<strong>）：</strong><br>       某一个路由协议（相同路由协议）判别到达目的的网络的最佳的方法。当一路由器有多条路径到达某一目的网络时，路由协议必须判断其中哪一条是最佳的并把它放到路由表中，路由协议会给每一条路径计算出一个数，这个数就是度量值，通常这个值是没有单位的。<br>       度量值越小，这条路径越佳。然而不同的路由协议定义度量值的方法不是一样的，所以不同的路由协议选择出的最佳距离可能也是不一样的。</p><p>重分发进rip或eigrp的其他协议若不指定metric的话，默认为无穷大。</p><p>重分发进ospf的其他协议若不指定metric的话，除了BGP为1外，默认为20.</p><p>重分发进BGP的其他协议的metric值为其本身的metric值不变<br>-————————————————————————————————————————–</p><p> <strong>度量值（**</strong>Metric**<strong>）指明了路径的优先权，而管理距离（**</strong>AD**<strong>）指明了发现路由方式的优先权**</strong>。**</p><p>同一种路由协议比较<a href="http://wenwen.soso.com/z/Search.e?sp=S%E5%BA%A6%E9%87%8F%E5%80%BC&ch=w.search.yjjlink&cid=w.search.yjjlink">度量值</a>，而不同路由协议比较<a href="http://wenwen.soso.com/z/Search.e?sp=S%E7%AE%A1%E7%90%86%E8%B7%9D%E7%A6%BB&ch=w.search.yjjlink&cid=w.search.yjjlink">管理距离</a>，OSPF还有E1 2之分 cost也不同</p><p>外部协议路由重分布进OSPF 默认是E2  默认是20 bgp除外 E1的话要把经过cost都计算在内 。</p><p><strong>同种协议管理距离一样**</strong>，所以比较**<strong>metric</strong> <strong>，不同协议比较管理距离**</strong>越小越优先** <strong>。</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;路由协议的优先级（Preference，即&lt;strong&gt;管理距离**&lt;/strong&gt;Administrative Distance**）一般为一个0到255之间的数字，数字越大则优先级越低。表一是通常情况下各路由协议的优先级规定：&lt;/p&gt;
&lt;p&gt;表一：一般路由协议优先级&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;路由协议&lt;/th&gt;
&lt;th&gt;优先级&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;DIRECT&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OSPF&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IS-IS Level 1&lt;/td&gt;
&lt;td&gt;15&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IS-IS Level 2&lt;/td&gt;
&lt;td&gt;18&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;NSFnet主干的SPF&lt;/td&gt;
&lt;td&gt;19&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;缺省网关和EGP缺省&lt;/td&gt;
&lt;td&gt;20&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;重定向路由&lt;/td&gt;
&lt;td&gt;30&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;由route socket得到的路由&lt;/td&gt;
&lt;td&gt;40&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;由网关加入的路由&lt;/td&gt;
&lt;td&gt;50&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;路由器发现的路由&lt;/td&gt;
&lt;td&gt;55&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;静态路由&lt;/td&gt;
&lt;td&gt;60&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CISCO IGRP&lt;/td&gt;
&lt;td&gt;80&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DCN HELLO&lt;/td&gt;
&lt;td&gt;90&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Berkeley RIP&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;点对点接口聚集的路由&lt;/td&gt;
&lt;td&gt;110&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Down状态的接口路由&lt;/td&gt;
&lt;td&gt;120&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;聚集的缺省路由&lt;/td&gt;
&lt;td&gt;130&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OSPF的扩展路由&lt;/td&gt;
&lt;td&gt;140&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;BGP&lt;/td&gt;
&lt;td&gt;170&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;EGP&lt;/td&gt;
&lt;td&gt;200&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;各产品厂商可能对路由协议的优先级有不同的规定，表二、表三分别列出了华为、思科路由器路由优先级列表：&lt;/p&gt;
&lt;p&gt;表二：华为路由器路由优先级&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;路由协议&lt;/th&gt;
&lt;th&gt;优先级&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;DIRECT&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OSPF&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;STATIC&lt;/td&gt;
&lt;td&gt;60&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IGRP&lt;/td&gt;
&lt;td&gt;80&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RIP&lt;/td&gt;
&lt;td&gt;110&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OSPFASE&lt;/td&gt;
&lt;td&gt;150&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;BGP&lt;/td&gt;
&lt;td&gt;170&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;表三：思科路由器路由协议优先级&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;路由协议&lt;/th&gt;
&lt;th&gt;优先级&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;DIRECT&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;STATIC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;EIGRP Summary&lt;/td&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;EBGP&lt;/td&gt;
&lt;td&gt;20&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;内部EIGRP&lt;/td&gt;
&lt;td&gt;90&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IGRP&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OSPF&lt;/td&gt;
&lt;td&gt;110&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IS-IS&lt;/td&gt;
&lt;td&gt;115&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RIP&lt;/td&gt;
&lt;td&gt;120&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;EGP&lt;/td&gt;
&lt;td&gt;140&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;外部EIGRP&lt;/td&gt;
&lt;td&gt;170&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IBGP&lt;/td&gt;
&lt;td&gt;200&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;未知&lt;/td&gt;
&lt;td&gt;255&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;路由的优先级的概念是优先级高的新路由协议可替代优先级低的同信宿路由，反之，则不然。&lt;/p&gt;
    
    </summary>
    
    
      <category term="路由" scheme="https://zeozzz.github.com/categories/%E8%B7%AF%E7%94%B1/"/>
    
    
      <category term="路由" scheme="https://zeozzz.github.com/tags/%E8%B7%AF%E7%94%B1/"/>
    
  </entry>
  
  <entry>
    <title>无题</title>
    <link href="https://zeozzz.github.com/2019/08/09/71/"/>
    <id>https://zeozzz.github.com/2019/08/09/71/</id>
    <published>2019-08-09T09:00:03.000Z</published>
    <updated>2019-08-09T11:05:27.141Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>好久没来哔哔了。。。唉，静心静心。。。</p><p>nodejs挂了 重新装了一下可以用了。最近进步还是很慢。。。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="自嘲" scheme="https://zeozzz.github.com/categories/%E8%87%AA%E5%98%B2/"/>
    
    
      <category term="自嘲" scheme="https://zeozzz.github.com/tags/%E8%87%AA%E5%98%B2/"/>
    
  </entry>
  
  <entry>
    <title>再谈双向NAT</title>
    <link href="https://zeozzz.github.com/2019/07/18/70/"/>
    <id>https://zeozzz.github.com/2019/07/18/70/</id>
    <published>2019-07-18T02:48:11.000Z</published>
    <updated>2020-01-21T09:34:49.216Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="出现背景"><a href="#出现背景" class="headerlink" title="出现背景:"></a>出现背景:</h3><p><a href="https://www.tuchuang001.com/image/K83AW"><img src="https://www.tuchuang001.com/images/2017/06/09/0a5b4b39c301b479.png" alt="0a5b4b39c301b479.png" loading="lazy"></a><br>在防火墙上部署了NATserver后，外网用户可以访问内部服务器。一般内部服务器都会通过一个域名进行解析。但如果内网用户也想通过此域名访问服务器就会出现问题。</p><h3 id="原因分析："><a href="#原因分析：" class="headerlink" title="原因分析："></a>原因分析：</h3><ol><li>内网用户要想访问internet,需要在防火墙上做个源NAT，将内网用户的网段转换为公网ip</li><li>假设pc通过公网ip 200.1.1.100 访问服务器，在出防火墙时防火墙做可源NAT会将PC的原地址转换为200.1.1.100将数据包交出去。</li><li>防火墙上配置了NATserver，将公网ip 200.1.1.100映射为服务器的私网地址192.168.1.100。数据包会交给服务器。</li><li>去时的数据包走向没有问题，分析回来的，回来时就会出现问题。</li><li>由于服务器和PC处于同一网段（防火墙以放行PC所在区域和服务器所在区域的数据），回包时服务器发送ARP报文找到了PC的MAC地址，三层封装时源IP地址为：192.168.1.100，目的IP地址为192.168.1.1。源目MAC地址分别为服务器的MAC地址和PC的MAC地址。数据包直接走二层过去。</li><li>PC和服务进行通信需要建立TCP的三次握手,第一次握手时的目的IP地址为200.1.1.100，但此时却收到了192.168.1.100的回包。怎么办，凌乱了，握手不成功。TCP连接无法建立。</li></ol><a id="more"></a><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案:"></a>解决方案:</h3><blockquote><p>上述问题产生的根本原因是PC访问服务器的数据包来回路径不一致，要解决这个问题只要使服务器访问PC的数据包经过防火墙即可。</p></blockquote><p>防火墙的内网接口地址为192.168.1.254，在防火墙上在做一个策略将PC访问服务器的源地址也做一个转换，将192.168.1.1转换为192.168.1.254。</p><p><strong>转换过后在分析：</strong></p><ol><li>过去的数据包走向和上述相同，不在分析。只不过在服务器看来访问自己的地址变成了192.168.1.254</li><li>回来时，服务器会把数据包交给192.168.1.254，此时由于防火墙上做了NAT srver,会将服务器的地址转换为200.1.1.100，将目的地址192.168.1.254转换为192.168.1.1。此时就与之前的TCP三次握手对应上了，PC一看与我握手的是200.1.1.100，成功握手。</li><li>数据包来回路径一致，成功解救问题。</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;出现背景&quot;&gt;&lt;a href=&quot;#出现背景&quot; class=&quot;headerlink&quot; title=&quot;出现背景:&quot;&gt;&lt;/a&gt;出现背景:&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://www.tuchuang001.com/image/K83AW&quot;&gt;&lt;img src=&quot;https://www.tuchuang001.com/images/2017/06/09/0a5b4b39c301b479.png&quot; alt=&quot;0a5b4b39c301b479.png&quot;&gt;&lt;/a&gt;&lt;br&gt;在防火墙上部署了NATserver后，外网用户可以访问内部服务器。一般内部服务器都会通过一个域名进行解析。但如果内网用户也想通过此域名访问服务器就会出现问题。&lt;/p&gt;
&lt;h3 id=&quot;原因分析：&quot;&gt;&lt;a href=&quot;#原因分析：&quot; class=&quot;headerlink&quot; title=&quot;原因分析：&quot;&gt;&lt;/a&gt;原因分析：&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;内网用户要想访问internet,需要在防火墙上做个源NAT，将内网用户的网段转换为公网ip&lt;/li&gt;
&lt;li&gt;假设pc通过公网ip 200.1.1.100 访问服务器，在出防火墙时防火墙做可源NAT会将PC的原地址转换为200.1.1.100将数据包交出去。&lt;/li&gt;
&lt;li&gt;防火墙上配置了NATserver，将公网ip 200.1.1.100映射为服务器的私网地址192.168.1.100。数据包会交给服务器。&lt;/li&gt;
&lt;li&gt;去时的数据包走向没有问题，分析回来的，回来时就会出现问题。&lt;/li&gt;
&lt;li&gt;由于服务器和PC处于同一网段（防火墙以放行PC所在区域和服务器所在区域的数据），回包时服务器发送ARP报文找到了PC的MAC地址，三层封装时源IP地址为：192.168.1.100，目的IP地址为192.168.1.1。源目MAC地址分别为服务器的MAC地址和PC的MAC地址。数据包直接走二层过去。&lt;/li&gt;
&lt;li&gt;PC和服务进行通信需要建立TCP的三次握手,第一次握手时的目的IP地址为200.1.1.100，但此时却收到了192.168.1.100的回包。怎么办，凌乱了，握手不成功。TCP连接无法建立。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="华为" scheme="https://zeozzz.github.com/categories/%E5%8D%8E%E4%B8%BA/"/>
    
    
      <category term="NAT" scheme="https://zeozzz.github.com/tags/NAT/"/>
    
  </entry>
  
  <entry>
    <title>IPv6 auto config 原理详解之-----前缀公告</title>
    <link href="https://zeozzz.github.com/2019/07/17/68/"/>
    <id>https://zeozzz.github.com/2019/07/17/68/</id>
    <published>2019-07-17T12:03:22.000Z</published>
    <updated>2020-01-21T09:35:00.928Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>人们常说，IPv6的一大特性就是移动性。</p><p>那么对于IP终端来说，如何去理解他的移动性呢？</p><p>其实就是IPv6的无状态自动配置。</p><p>前段时间有幸一个同事给我演示了一下这个功能，但是更多的疑问产生了。</p><p>IPv4中，比如说电脑，在网卡中设置自动获取IP地址和DNS.那么就可以自动从DHCP服务器上面获得IP地址和DNS还有网关了。</p><p>下面是IPv4的设置界面：</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151463aDzX.jpg" alt="clip_p_w_picpath002" loading="lazy"></strong></p><p>那么按照这个逻辑，IPv6就应该是没有这些选项，最终达到即插即用的目的嘛？答案是否，下面的截图IPv6也有：</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151470ZoVk.jpg" alt="clip_p_w_picpath004" loading="lazy"></strong></p><p>那么为什么还需要自动配置？</p><p>意义在哪里？</p><p>如何实现呢？</p><p>带着这些问题，我们慢慢来看看IPv6这个自动配置auto config到底是个什么原理。</p><a id="more"></a><p><strong>RFC2462上面写到，无状态自动配置是IPv6最有吸引力和最有用的新特性之一。他允许本地链路上得节点根据路由器在本地链路上公告信息自己配置单播IPv6地址。</strong></p><p><strong>PS:路由器可是不能用无状态自动配置来实现，无状态自动配置仅仅适用于IP终端.这点一定要记得。</strong></p><p><strong>所以换句话说，路由器上面是不能实现这个功能的，这个是RFC上面定义的。没有原因。可能主要的目的是统一规划，方便管理的目的。</strong></p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151478ff9T.jpg" alt="clip_p_w_picpath006" loading="lazy"></strong></p><p>这个就是从auto config延伸出来的几个子工作机制。</p><p><strong>第一个知识点是前缀公告。</strong></p><p>前缀公告是无状态自动配置中的初始机制。前缀公告机制使用路由器公告信息ICMPv6 type=134和所有节点的多播地址FF02::1，路由器公告机制在本地链路上周期性的发送到所有节点的多播地址。</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151483WIIy.jpg" alt="clip_p_w_picpath008" loading="lazy"></strong></p><p>在CISCO路由器上面公告IPv6前缀.</p><p>只要在接口上面配置了一个本地站点或者全球可聚合单播IPv6地址还有掩码，实际上就启用了cisco路由器上面的IPv6前缀公告。</p><p><strong>IPv6前缀公告原理：</strong></p><p>路由器周期性的发送ICMPv6 type=134的路由器前缀公告，用她得本地链路地址link-local FE80::250:3EFF:FEE4:4C00作为源，所有节点的多播地址FF02::1作为目的。</p><p>路由器公告消息公告的前缀是FEC0:0:0:1::/64,生存周期首选无穷大.</p><p>当本地链路多播地址FF02::1的节点A和B得到路由器公告消息，可以自己配置他们的IPv6地址.</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_13131514908wzt.jpg" alt="clip_p_w_picpath010" loading="lazy"></strong></p><p>这里我犯了一个错误，感觉这个是IPv6 前缀通告是配置了地址以后就自己有的一个机制。</p><p>实验结果并不是这样,我在R1和R2之间抓包，没有抓到ICMPv6 type = 134的报文，然后我又在网上查阅相关资。</p><p>为什么会这样，因为我忽略了一点很重要的，自动配置这个功能是仅仅限于路由器对PC终端之间的行为，路由器都不能支持这个auto config，所以为什么路由器要发前缀通告给邻居直连路由器呢？</p><p>后来我用路由器直连PC,得到了我想要的结果，PC自动获取到了IP地址，并且前缀和2012::/64是一样的.</p><p>:) 到这个时候我的心才稳下来。呵呵。下面是详细的实验结果：</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151497GaSV.jpg" alt="clip_p_w_picpath012" loading="lazy"></strong></p><p>在R1上面，用命令<strong>show ipv6 interface giga 1/0 prefix</strong>:</p><p>可以看到，R1有一个AD,是自己的前缀2012::/64:</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151506o0CW.jpg" alt="clip_p_w_picpath014" loading="lazy"></strong></p><p>呵呵，特意把giga 1/0的配置也show出来，2012::/64就是接口1/0的前缀。</p><p>在cisco上面，默认情况下有效生存期是30天.首选生存期是7天(604800s).</p><p>然后我做了一个实验，用迈普的路由器连接一个PC.</p><p>然后在PC机上面使能IPv6的功能(xp需要安装相关IPv6协议，默认是没有的，win7默认就加载了IPv6的协议栈了)</p><p>图谱图：</p><p>MAIPU router————PC</p><p>后来在PC上面成功获取到了IP地址，前缀为2012::/64,可以ping通路由器接口FE0 : 2012::1</p><p>我在路由器上面FE0配置的地址是：2012::1/64.</p><p>最后在PC机上获得的地址是:</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151513Glqz.jpg" alt="clip_p_w_picpath016" loading="lazy"></strong></p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151517KyLU.jpg" alt="clip_p_w_picpath018" loading="lazy"></strong></p><p>在PC机接电脑以前，我就一直用wireshark进行抓包。抓到了ICMPv6 type=134的报文，下面是报文的具体格式：</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151529SyCj.jpg" alt="clip_p_w_picpath020" loading="lazy"></strong></p><p>当然也可以用一个命令来修改前缀公告：</p><p>ipv6 nd prefix.</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151534uw3q.jpg" alt="clip_p_w_picpath022" loading="lazy"></strong></p><p>还有一个小功能就是在接口上面禁止路由器公告。</p><p>在cisco 2011年1月的IOS上面，这个命令有点不一样：</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151538h3DK.jpg" alt="clip_p_w_picpath024" loading="lazy"></strong></p><p>命令是: <strong>ipv6 nd ra suppress</strong>.</p><p>而以前老得IOS上面，命令却是：</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_1313151542jE75.jpg" alt="clip_p_w_picpath026" loading="lazy"></strong></p><p>其实无所谓，我们关注的是原理，命令行只是实现原理的一个手段罢了。</p><p>其实这里关于auto config还有几个参数，下面把几个参数都融合进行了一个接口中。</p><p><strong><img src="https://s1.51cto.com/attachment/201108/12/351531_13131515494vCl.jpg" alt="clip_p_w_picpath028" loading="lazy"></strong></p><p>关于DAD和前缀重新编址，将在后续的文档中做实验进行验证。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;人们常说，IPv6的一大特性就是移动性。&lt;/p&gt;
&lt;p&gt;那么对于IP终端来说，如何去理解他的移动性呢？&lt;/p&gt;
&lt;p&gt;其实就是IPv6的无状态自动配置。&lt;/p&gt;
&lt;p&gt;前段时间有幸一个同事给我演示了一下这个功能，但是更多的疑问产生了。&lt;/p&gt;
&lt;p&gt;IPv4中，比如说电脑，在网卡中设置自动获取IP地址和DNS.那么就可以自动从DHCP服务器上面获得IP地址和DNS还有网关了。&lt;/p&gt;
&lt;p&gt;下面是IPv4的设置界面：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;img src=&quot;https://s1.51cto.com/attachment/201108/12/351531_1313151463aDzX.jpg&quot; alt=&quot;clip_p_w_picpath002&quot;&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;那么按照这个逻辑，IPv6就应该是没有这些选项，最终达到即插即用的目的嘛？答案是否，下面的截图IPv6也有：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;img src=&quot;https://s1.51cto.com/attachment/201108/12/351531_1313151470ZoVk.jpg&quot; alt=&quot;clip_p_w_picpath004&quot;&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;那么为什么还需要自动配置？&lt;/p&gt;
&lt;p&gt;意义在哪里？&lt;/p&gt;
&lt;p&gt;如何实现呢？&lt;/p&gt;
&lt;p&gt;带着这些问题，我们慢慢来看看IPv6这个自动配置auto config到底是个什么原理。&lt;/p&gt;
    
    </summary>
    
    
      <category term="IPv6" scheme="https://zeozzz.github.com/categories/IPv6/"/>
    
    
      <category term="IPv6" scheme="https://zeozzz.github.com/tags/IPv6/"/>
    
  </entry>
  
  <entry>
    <title>企业园区网络建设技术方案（华为）</title>
    <link href="https://zeozzz.github.com/2019/07/16/67/"/>
    <id>https://zeozzz.github.com/2019/07/16/67/</id>
    <published>2019-07-16T01:35:08.000Z</published>
    <updated>2020-01-21T09:35:10.450Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>原文链接：<a href="https://zhuanlan.zhihu.com/p/53512258">https://zhuanlan.zhihu.com/p/53512258</a></p><h2 id="1-项目概述"><a href="#1-项目概述" class="headerlink" title="1 项目概述"></a>1 项目概述</h2><p>根据实际情况增加项目介绍</p><h2 id="1-1-项目背景"><a href="#1-1-项目背景" class="headerlink" title="1.1 项目背景"></a>1.1 项目背景</h2><h2 id="1-2-项目目标"><a href="#1-2-项目目标" class="headerlink" title="1.2 项目目标"></a>1.2 项目目标</h2><h2 id="2-园区总体系统规划设计"><a href="#2-园区总体系统规划设计" class="headerlink" title="2 园区总体系统规划设计"></a>2 园区总体系统规划设计</h2><h2 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a>2.1 需求分析</h2><p>随着企业信息化建设不断深入，企业的生产业务系统、经营管理系统、办公自动化系统均得到大力发展，对于企业园区网的建设要求越来越高。传统园区网建设初期往往面临如下问题：</p><p><strong>(一)</strong> <strong>网络架构较为混乱，不便于扩容和维护管理：</strong>园区网在建设初期，设备和光纤/电缆随意布放，缺乏统一的网络分层规划管理，网络拓扑相对混乱，不便于对网络性能瓶颈进行正确评估和有效扩容，给日常网络管理也带来很大难度。</p><p><strong>(二)</strong> <strong>网络可靠性规划不合理，影响企业生产和经营管理、造成投资浪费：</strong>由于缺乏有效的园区网规划，对于网络可靠性考虑不够，网络中既存在单点故障导致网络可靠性低、影响企业生产和经营管理行为，同时也存在网络过度冗余、造成投资浪费的现象。</p><p><strong>(三)</strong> <strong>网络信息安全存在隐患：</strong>网络安全性是园区网建设的重中之重，传统园区网安全漏洞较多，无法应对内外部用户日益猖獗的网络攻击行为（例如：对园区网设备进行攻击、消耗网络带宽、窃取企业核心电子资产信息），对于内部和外部用户缺乏有效的身份认证手段、用户可随意接入网络，网络层面的安全保证和防御措施也不到位，造成园区网的脆弱和易攻击。</p><p><strong>(四)</strong> <strong>无法满足日益增长的网络业务需求：</strong>随着企业的业务发展，出现了基于园区网基础设施的丰富增值业务需求，例如：网络接入形式要求多样化，支持WLAN无线接入，满足移动办公、大区域无线缆覆盖等特殊要求；对于企业用户访问外网进行计费，计费策略可灵活设置（时长计费、流量计费、按目的地址计费）；企业多出口链路场景下的负载均衡、灵活选路需求。传统园区网建设缺乏有效满足这些增值业务需求的统一解决方案考虑，支持这些业务存在园区网络分散建设、重复投资的问题。</p><p><strong>(五)</strong> <strong>缺乏简单有效的网络管理系统，企业IT网络运维部门面临很大压力：</strong>当前，企业网IT运维部门面临很大的网络运维压力，来自于园区网内外部的安全事件频发、网络可靠性低引起的网络业务中断现象，网络故障诊断、分析定位过程对于IT运维人员的技术能力和经验水平要求较高，缺乏简单有效/低成本的图形化网管工具、进行实时网络拓扑显示、状态监控和各种故障事件预警/告警展示。另外，IT运维部门也需要实施统计园区网各路径的流量信息，便于对网络带宽进行管理和规划，给后续网络扩容提供参考。</p><h2 id="2-2-设计原则"><a href="#2-2-设计原则" class="headerlink" title="2.2 设计原则"></a>2.2 设计原则</h2><p><strong>(一)</strong> <strong>安全性：</strong>安全性是企业园区网建设中的关键，它包括物理空间的安全控制及网络的安全控制。需要有完整的安全策略控制体系来实现企业园区网的安全控制。</p><p><strong>(二)</strong> <strong>可靠性、可用性：</strong>高可靠性是园区网提供使用的关键，其可靠性设计包括：关键设备冗余、链路/网络冗余和重要业务模块冗余。</p><p>关键设备均采用电信级全冗余设计，可实现单板热拔插、冗余的控制模块设计、冗余电源设计。采用冗余网络设计，每个层次均采用双机方式，层次与层次之间采用全冗余连接。提供多种冗余技术，采用高效、负载均衡的双机备份。</p><p>可采用交换机的集群或者堆叠技术，在不降低网络可靠性的前提下，减化网络架构。</p><p><strong>(三)</strong> <strong>可扩展性：</strong>园区网方案设计中，采用分层的网络设计；每个层次的设计所采用的设备本身都应具足够高的端口密度，为后续园区网扩展奠定基础。</p><p>在园区出口层、核心层、汇聚层的设备都采用模块化设计，可根据园区网的发展进行灵活扩展。</p><p>功能的可扩展性是园区网随着发展提供增值业务的基础。实现防火墙、负载均衡、WLAN接入、认证计费等功能，为园区网增值业务的扩展提供基础。</p><p><strong>(四)</strong> <strong>可维护、可管理性：</strong>网络可管理性是园区网成功运维的基础。应提供低成本、简单有效的园区网统一网管系统，对园区网所有网络设备进行管理，包括网络拓扑显示、网络状态监控、故障事件实时预警和告警、网络流量统计。</p><a id="more"></a><h2 id="3-园区网络架构规划设计"><a href="#3-园区网络架构规划设计" class="headerlink" title="3 园区网络架构规划设计"></a>3 园区网络架构规划设计</h2><h2 id="3-1-园区网络总体网络架构规划设计"><a href="#3-1-园区网络总体网络架构规划设计" class="headerlink" title="3.1 园区网络总体网络架构规划设计"></a>3.1 园区网络总体网络架构规划设计</h2><h2 id="3-1-1-典型园区网网络架构"><a href="#3-1-1-典型园区网网络架构" class="headerlink" title="3.1.1 典型园区网网络架构"></a>3.1.1 典型园区网网络架构</h2><p><img src="https://pic1.zhimg.com/80/v2-d1590ffcea82b0fe3068edc687ac18dc_hd.jpg" alt="img" loading="lazy">图 3‑1 典型园区网网络架构</p><p>典型园区网方案采用层次化、模块化的设计思路，按照接入层、汇聚层、核心层和出口层进行网络设备设计部署，在汇聚层交换机，通过模块化（业务单板）方式提供WLAN AC控制器、防火墙、负载均衡器等增值业务功能，满足企业日益增长的业务需求。</p><p>典型园区网的重要特征是不存在网络单点故障，交换机设备和链路都存在冗余备份，接入交换机与核心交换机通过双规或环网相连接，汇聚交换机双规接入核心交换机，交换机之间采用TRUNK链路保证链路级可靠性。</p><h2 id="3-1-2-经济型园区网网络架构"><a href="#3-1-2-经济型园区网网络架构" class="headerlink" title="3.1.2 经济型园区网网络架构"></a>3.1.2 经济型园区网网络架构</h2><p><img src="https://pic3.zhimg.com/80/v2-ffa4d15431ded70c16cff9f15017968a_hd.jpg" alt="img" loading="lazy">图 3‑2 经济型园区网网络架构</p><p>考虑到节省园区网网络建设投资成本，允许网络存在单点故障，不再部署冗余交换机设备，交换机之间互联采用TRUNK链路，保证链路级可靠性，但是园区网交换机设备故障，会导致网络故障和业务中断。</p><p>经济型的园区网汇聚层交换机仍然可通过模块化（业务单板）方式提供WLAN AC控制器、防火墙、负载均衡器等增值业务功能。</p><h2 id="3-1-3-虚拟交换园区网网络架构"><a href="#3-1-3-虚拟交换园区网网络架构" class="headerlink" title="3.1.3 虚拟交换园区网网络架构"></a>3.1.3 虚拟交换园区网网络架构</h2><p>图 3‑3 虚拟交换园区网网络架构</p><p><img src="https://pic1.zhimg.com/80/v2-744e089d67b0cf05a87b327b1af520f0_hd.jpg" alt="img" loading="lazy">图 3‑3 虚拟交换园区网网络架构</p><p>园区网仍然按照分层结构建设，园区交换机分为接入层交换机、汇聚层交换机和核心层交换机。为了增加园区网可靠性、降低园区网组网复杂度，园区网未来向虚拟化、扁平化方向发展，同层次交换机可以多台虚拟成一台，接入交换机通过堆叠（Stack）特性，将多台接入交换机虚拟成一台接入交换机，汇聚/核心交换机通过CSS（Cluster Switch ）将两台交换机虚拟成一台交换机。</p><p>园区网接入层/汇聚层/核心层交换机虚拟化后，可以减少网络节点、简化网络拓扑，二层网络不需要部署RSTP/MSTP/RRPP/Smart Link等复杂的环网协议和可靠性保护协议，实现无二层环路网络构建，提高二层网络可靠性和链路故障收敛性能，三层网络虚拟化的多台设备间路由表统一计算、路由收敛速度快，</p><p>通过交换机虚拟化设计，交换机互联的两条链路就可以作为Trunk链路进行管理，对于虚拟交换机而言，实现跨设备的链路聚合（TRUNK），大大增强链路可靠性，另外可实现链路的流量负载均衡，构建无二层环路网络，网络可靠性（链路故障自收敛性能）和带宽利用率都得到提高。</p><p><img src="https://pic4.zhimg.com/80/v2-92948290e3947c9f34c68a3eeb56d803_hd.jpg" alt="img" loading="lazy">图 3‑4 交换机集群（堆叠）方案</p><h2 id="3-2-园区网络分层网络规划设计"><a href="#3-2-园区网络分层网络规划设计" class="headerlink" title="3.2 园区网络分层网络规划设计"></a>3.2 园区网络分层网络规划设计</h2><p>园区网的网络层次采用业界成熟的三层架构：接入、汇聚和核心，最后企业园区通过出口层网络设备（路由器或交换机）连接到外网通过。</p><p>这种分层的网络架构，可以保证根据的业务需求，分别对不同层次进行扩容。</p><h2 id="3-2-1-接入层"><a href="#3-2-1-接入层" class="headerlink" title="3.2.1 接入层"></a>3.2.1 接入层</h2><p>接入层交换机一般部署在楼道的网络机柜中，接入园区网用户（PC机或服务器），提供二层交换机功能，也支持三层接入功能（接入交换机为三层交换机）。</p><p>由于接入层交换机直接接园区网用户，根据用户接入信息点数目和类型（GE/FE），对接入交换机的GE/FE接口密度有较高的要求。另外接入交换机部署在楼道网络机柜，数量大，对于成本、功耗和易管理维护等特性要求较高。</p><p>高用户密度的园区接入场景推荐使用S5300/S9300作为接入交换机，低用户密度的场景推荐使用S2300/S3300作为接入交换机。</p><h2 id="3-2-2-汇聚层"><a href="#3-2-2-汇聚层" class="headerlink" title="3.2.2 汇聚层"></a>3.2.2 汇聚层</h2><p>园区汇聚层交换机一般部署在楼宇独立的网络汇聚机柜中，汇聚园区接入交换机的流量，一般提供三层交换机功能，汇聚层交换机作为园区网的网关，终结园区网用户的二层流量，进行三层转发。</p><p>根据需要，可以在汇聚交换机上集成增值业务板卡（如防火墙，负载均衡器、WLAN AC控制器）或者旁挂独立的增值业务设备，为园区网用户提供增值业务。</p><p>汇聚交换机需要提供高密度的GE接口，汇聚接入交换机的流量，通过10GE接口接到核心交换机，推荐使用S9300系列交换机作为园区汇聚层交换机。</p><h2 id="3-2-3-核心层"><a href="#3-2-3-核心层" class="headerlink" title="3.2.3 核心层"></a>3.2.3 核心层</h2><p>园区核心层交换机部署在园区核心机房中，汇聚各楼宇/区域之间的用户流量，提供三层交换机功能，连接园区外部网络到内部用户的“纵向流量”和不同汇聚区域用户之间的“横向流量”要求高密10GE、高转发性能。</p><p>推荐使用S9300作为园区核心层交换机。</p><h2 id="3-2-4-出口层"><a href="#3-2-4-出口层" class="headerlink" title="3.2.4 出口层"></a>3.2.4 出口层</h2><p>园区出口路由器，连接Internet/WAN广域网和园区内部局域网。推荐华为AR和SRG系列路由器作为企业出口路由器。</p><p>对于中小型企业园区网，核心层和出口层可进行合并，通过核心交换机（S9300）的WAN接口板的广域网接口（POS等）直接与外网相连。 3.3 二三层网络分界点设计</p><p><strong>二三层网络分界点（用户网关）设置在汇聚交换机</strong></p><p>汇聚交换机作为用户的网关设备，接入交换机与汇聚交换机之间是二层网络，通过STP/RSTP/MSTP/RRPP保证网络可靠性和防止二层网络环路产生，汇聚交换机与核心交换机之间是三层网络，运行OSPF等路由协议，通过等价路由、IP FRR保证三层网络可靠性、加快路由收敛时间。</p><p>【优点】</p><ol><li><p>接入交换机是二层交换机，成本低，并且可保护客户现有低端二层交换机的投资；</p></li><li><p>高可靠性，二层网络故障收敛速度快；</p></li></ol><p>【缺点】</p><ol><li><p>接入交换机和汇聚交换机之间存在二层环路风险，需要配置保证；</p></li><li><p>接入交换机与汇聚交换机之间链路利用率低，需要启用二层协议负载均担多实例以提高链路利用率。</p></li></ol><p>本方案的缺点可以通过接入交换机堆叠/汇聚交换机集群（交换机虚拟化）方案来解决。园区汇聚交换机作为二三层网络分界点（用户网关设备）是经典的园区网架构，推荐使用。</p><p><strong>二三层网络分界点（用户网关）设置在接入交换机</strong></p><p>接入交换机作为用户的二三层分界点（网关设备），即三层到边缘的园区网架构，接入交换机到汇聚交换机、汇聚交换机到核心交换机之间都是三层网络，运行OSPF等路由协议，整个企业园区是全路由型网络。</p><p>【优点】</p><ol><li><p>网络易扩展：园区网架构对物理网络拓扑依赖度低，可以任意网络拓扑形式扩展；</p></li><li><p>网络易维护：全网为三层网络、无二层环路网络风险，无需配置生成树协议、RRPP和VRRP，降低网络配置和维护工作量。</p></li></ol><p>【缺点】</p><ol><li><p>交换机成本相对较高：相对与二层接入交换机，成本较高；</p></li><li><p>接入层为三层网络，网络故障路由收敛速度相对较慢。</p></li></ol><h2 id="4-园区网络高可靠性规划设计"><a href="#4-园区网络高可靠性规划设计" class="headerlink" title="4 园区网络高可靠性规划设计"></a>4 园区网络高可靠性规划设计</h2><h2 id="4-1-园区网络高可靠性规划设计"><a href="#4-1-园区网络高可靠性规划设计" class="headerlink" title="4.1 园区网络高可靠性规划设计"></a>4.1 园区网络高可靠性规划设计</h2><p>园区网高可靠性设计总体方案如下图所示：</p><p><img src="https://pic3.zhimg.com/80/v2-df3c4a7cd992bd1267be40be41f73bea_hd.jpg" alt="img" loading="lazy">图 4‑1 园区网高可靠性设计方案总览</p><p>针对二层接入（接入交换机是二层交换机、汇聚交换机作为用户网关）典型园区网架构，从接入层、汇聚层、核心层来分层考虑网络可靠性设计。</p><p>接入层网络是二层网络，接入交换机与汇聚交换机之间通过Smart Link/STP/RSTP/MSTP/RRPP保证网络可靠性，同时解决二层网络环路问题；汇聚层交换机之间通过VRRP（BFD for VRRP）协议确定用户的主备网关，交换机互联通过TRUNK链路，保证链路级可靠性，汇聚交换机与接入交换机之间可通过DLDP协议检测光纤单向故障（单通故障）。</p><p>园区网接入/汇聚/核心交换机通过虚拟化技术进行集群（或堆叠），将两台/多台交换机虚拟化成一台交换机，降低网络拓扑复杂度的同时，提高网络可靠性，是未来高可靠性园区网的发展趋势。</p><p>典型园区网可靠性组网设计方案有：口子型组网、三角型组网、U子型组网。 </p><p><strong>可靠性组网方案1：口子型组网</strong></p><p><img src="https://pic3.zhimg.com/80/v2-018f448a3251ad1f49542e718dfbb802_hd.jpg" alt="img" loading="lazy">图 4‑2 口子型组网</p><p>接入交换机与汇聚交换机之间是二层网络，汇聚交换机作为用户网关设备，两台汇聚交换机之间通过二层TRUNK链路互连，多台接入交换机与两台汇聚交换机之间组成口子型二层环网，并且通过部署STP/RSTP/MSTP/RRPP等协议进行二层环网阻断、环网故障检测和保护倒换功能。两台汇聚交换机运行VRRP（BFD+VRRP）协议确定主备用户网关，VRRP报文直接在汇聚交换机直连的TRUNK链路上收发。注意：两台汇聚交换机链路需要保证绝对可靠，必须采用TRUNK链路、包含两条以上物理链路，因为汇聚交换机间链路DOWN，两台汇聚交换机VRRP状态都为主（VRRP双主情况产生），此时接入二层环网阻塞在汇聚交换机之间的直连链路上，这样接入用户同时感知两个处于VRRP主用状态的网关设备（汇聚交换机），出现问题。</p><p>口子型组网方案的优点是，园区网各个楼层接入交换机可以串在一起，与汇聚交换机组成二层环网，汇聚交换机统一为各楼层接入交换机下的用户分配IP地址，实现园区不同楼层的用户可以共用同一个IP地址网段； 该组网方案的缺点是接入层网络需要部署较为复杂的二层环网协议、网络配置和维护较为复杂。</p><p>口子型组网方案是园区网非常经典的可靠性设计方案，适合各种规模的园区网应用场景。</p><p><strong>可靠性组网方案2：三角型组网</strong></p><p><img src="https://pic1.zhimg.com/80/v2-17997fcaaceda05f154de148900df07c_hd.jpg" alt="img" loading="lazy">图 4‑3 三角型组网</p><p>汇聚交换机作为用户网关设备，两台汇聚交换机之间通过二层链路互连，每台接入交换机上行有两条链路接入到两台汇聚交换机，接入交换机上行两条链路的主备关系由运行的Smart Link协议确定。两台汇聚交换机运行VRRP（BFD+VRRP）协议确定主备用户网关，VRRP报文直接在汇聚交换机直连链路上收发。注意：两台汇聚交换机链路需要保证绝对可靠，必须采用TRUNK链路。口子型组网场景下，多个楼层之间可以共用VRRP组，不受汇聚交换机VRRP组数量限制，可实现不同楼层间的园区用户可以共享一个IP地址网段。</p><p>三角型组网方案的优点是：二层接入网不存在环路，不需要配置相对复杂的环网保护协议（STP/RSTP/MSTP/RRPP）；Smart Link故障检测和保护倒换速度快（200～400ms）；支持园区网园区不同楼层的用户可以共用同一个IP地址网段。</p><p>三角型组网方案的缺点是每台接入交换机上行需要部署主备两条链路，增加布线成本，对汇聚交换机的端口密度有较高要求。</p><p><strong>可靠性组网方案3：U字型组网</strong></p><p><img src="https://pic3.zhimg.com/80/v2-f103961d2a1c7fb70c8dd312f6913976_hd.jpg" alt="img" loading="lazy">图 4‑4 U字型组网</p><p>园区网汇聚交换机之间通过纯三层链路互连，无直连二层链路。汇聚交换机作为园区用户网关，与接入交换机组成二层网络，汇聚交换机的主备通过VRRP（BFD for VRRP）协议协商，VRRP协议通过接入交换机转发，每组接入交换机与两台汇聚交换机组成的一个物理U型网络需要启用一组VRRP，汇聚交换机通过多个物理端口会接入多个二层U型网络，这样汇聚交换机间需要运行多个VRRP组（每个二层U型接入网络运行一个VRRP组），一般一个U型二层接入网覆盖的是同一个楼层的接入交换机。由于不同VRRP组的网关IP网段不能相同，因此每个U型接入网下的所有园区用户需要独占一个IP网段，不同U型接入网的用户（不同楼层的园区用户）之间不能共享一个IP网段，这是此方案应用的最大缺点。</p><p>U子型方案的优点：二层接入网不存在环路，不需要配置相对复杂的环网保护协议（STP/RSTP/MSTP/RRPP）。</p><p><strong>可靠性设计目标方案（发展趋势）：园区网交换机虚拟化</strong></p><p><img src="https://pic1.zhimg.com/80/v2-0cc406480699395a23b35c186680bfa8_hd.jpg" alt="img" loading="lazy">图 4‑5 可靠性设计目标方案组网</p><p>园区网可靠性方案设计的目标方案或发展趋势是各层次园区网交换机都进行虚拟化，通过集群/堆叠技术将两台或多台交换机虚拟成一台交换机。可以提高单节点设备可靠性，一台交换机故障，另外一台交换机自动接管故障设备上的所有业务，可以做到业务无损切换。设备虚拟化通过跨设备的TRUNK链路，提升链路级可靠性，并且流量可以均匀分布在TRUNK成员链路上，提高链路带宽利用率，条或多条链路故障后,流量自动切换到其他正常的链路。</p><p>该方案另外一个优点网络配置和维护简单，园区二层接入网，不需要配置复杂的二层环网和保护倒换协议，二层链路故障直接感知快速切换，三层网络中多个设备间共享路由表，网络故障路由收敛速度快。网络管理和维护难度大大降低，此方案适应面广，扩展性强，是未来园区网的发展趋势。</p><h2 id="4-2-园区网络设备高可靠性规划设计"><a href="#4-2-园区网络设备高可靠性规划设计" class="headerlink" title="4.2 园区网络设备高可靠性规划设计"></a>4.2 园区网络设备高可靠性规划设计</h2><h2 id="4-2-1-重要部件冗余"><a href="#4-2-1-重要部件冗余" class="headerlink" title="4.2.1 重要部件冗余"></a>4.2.1 重要部件冗余</h2><p>设备本身要具有电信级5个9的可靠性，需要网络设备支持:</p><p>主控1:1备份</p><p>交换网1+1/1:1两种方式</p><p>DC电源1+1备份；AC电源1+1/2+2备份</p><p>模块化的风扇设计，高端配置支持单风扇失效</p><p>无源背板，高可靠性</p><p>独立的设备监控单元，和主控解耦</p><p>所有模块热插拔</p><p>完善的各种告警功能</p><p>设备管理1:1备份</p><h2 id="4-2-2-设备自身安全"><a href="#4-2-2-设备自身安全" class="headerlink" title="4.2.2 设备自身安全"></a>4.2.2 设备自身安全</h2><p>如下图所示,随着黑客工具的泛滥和使用的方便,使的网络攻击的成本越来越来,但危害越来越大.</p><p><img src="https://pic2.zhimg.com/80/v2-4888f5bb80b393f464eb7d731d65a1ad_hd.jpg" alt="img" loading="lazy">图 4‑6 黑客工具的危害性</p><p>这就要求具有强大灵活的自身防护功能,以不变应万变的方法,才能抵挡日益泛滥的网络攻击。</p><p>华为公司全系列园区网交换机（S9300/S5300/S3300/S2300）提供攻击防范功能，能够检测出多种类型的网络攻击，并能采取相应的措施保护设备自身及其所连接的内部网络免受恶意攻击，保证内部网络及设备的正常运行。</p><p>华为全系列交换机支持的攻击防范功能包括防DDOS攻击、IP欺骗攻击、Land攻击、Ping of Death攻击、Teardrop攻击、ICMP Flood攻击、SYN FLOOD攻击等。</p><p>另外，以太网交换机的MAC地址表作为二层报文转发的核心，在受到攻击的时候，直接导致交换机无法正常工作。发生MAC地址攻击的时候，攻击者通过不停的发送MAC地址来刷新，填充交换机的MAC地址表，由于MAC地址表的规格有限，导致正常流量由于没有正确的转发表项而无法正常转发。ARP攻击与此类似，通过攻击报文来更改MAC与IP地址的绑定，从而重新定向流量。</p><p>华为全系列交换机可以通过MAC地址与端口的绑定以及限制端口/VLAN/VSI下MAC地址的最大学习个数可防止MAC扫描，并通过VLAN、IP、MAC之间的任意绑定可防范ARP攻击（SAI/DAI功能）。</p><p>华为全系列交换机支持黑洞MAC功能，园区交换机收到报文时比较报文目的MAC地址，若与黑洞MAC表项相同则丢弃该报文。当用户察觉到某MAC地址的报文具有一定攻击性，则可以在园区交换机上配置黑洞MAC，从而将具有该MAC地址的报文过滤掉，避免遭受攻击。</p><h2 id="4-3-园区网络交换机虚拟化规划设计"><a href="#4-3-园区网络交换机虚拟化规划设计" class="headerlink" title="4.3 园区网络交换机虚拟化规划设计"></a>4.3 园区网络交换机虚拟化规划设计</h2><h2 id="4-3-1-汇聚交换机的集群CSS-Cluster-Switch-Switching"><a href="#4-3-1-汇聚交换机的集群CSS-Cluster-Switch-Switching" class="headerlink" title="4.3.1 汇聚交换机的集群CSS(Cluster Switch Switching)"></a>4.3.1 汇聚交换机的集群CSS(Cluster Switch Switching)</h2><p>所谓集群，就是把物理的多台服务器连接在一起，对外表现为一台逻辑的服务器，提供服务。</p><p>因为企业园区网为了增加可靠性，都是双节点备份，特别适合集群技术。如下图所示：</p><p><img src="https://pic4.zhimg.com/80/v2-1350c0781e69a3f6d037f6d39d1b2037_hd.jpg" alt="img" loading="lazy">图 4‑7 集群组网的优势</p><p>采用集群技术，对企业园区网络，有四大优势：</p><ol><li>减化管理和配置</li></ol><p>首先，集群后需要管理的设备节点减少一半以上。</p><p>其次，组网变得简洁，不需要配置复杂的协议，包括STP/SmartLink/VRRP等。</p><ol start="2"><li>快速的故障收敛</li></ol><p>故障收敛时间可以控制在&lt; 1ms, 大大降低了网络链路/节点的故障，对业务的影响。</p><ol start="3"><li>带宽利用率高</li></ol><p>采用链路Trunk的方式，带宽利用率可以达到100％。</p><ol start="4"><li>扩容方便</li></ol><p>保护用户投资。随着业务的增加，当用户进行网络升级时，采用集群的方式，只需要增加新设备既可，不需要更改网络配置的情况下，平滑扩容，很好的保护了用户投资。</p><p>目前，业界有两种堆叠的方式，一种是采用业务接口堆叠，一种是采用专用的堆叠线；</p><p><img src="https://pic2.zhimg.com/80/v2-78493c57b0a8348b7d93149242b19fb9_hd.jpg" alt="img" loading="lazy">图 4‑8 两种集群方式比较</p><p>华为的S93系列交换机采用堆叠线的方式，通过在主板板上插入堆叠卡，连接多台设备。如下图所示，这种方式有如下的优势：</p><p><img src="https://pic2.zhimg.com/80/v2-d1a5d87863061b5546c7abadfe5a8fb5_hd.jpg" alt="img" loading="lazy">图 4‑9 华为CSS集群技术</p><p>采用交换机网集群的方式，相比接口板集群，有如下的优势：</p><p><strong>堆叠带宽高</strong></p><p>交换机网集群一般采用专用的接口线，堆叠带宽高。</p><p>S93系列的堆叠带宽高达128G(单向)；并且可平滑升级到200G(单向)； 相对于业界的80G（单向）的互联带宽，具有明显的优势。</p><p><strong>不占用业务槽位</strong></p><p>S93系列采用在主控板预留的灵活插卡槽位，插入堆叠卡互联的方式，不占用接口槽位。相对于接口堆叠的方式，节省了1～2个接口槽位。</p><p><strong>可靠性高</strong></p><p>S93系列采用堆叠线连接，实际上是对交换网的延伸。从上图可以看出，接口板堆叠方式需要经过两个堆叠接口板转发，处理复杂度增加；另外，接口板的硬件可靠性也比交换网低。</p><p>总体来看，交换网堆叠在软件和硬件方面，可靠性都高于接口堆叠的方式。</p><h2 id="4-3-2-接入交换机的堆叠iStack"><a href="#4-3-2-接入交换机的堆叠iStack" class="headerlink" title="4.3.2 接入交换机的堆叠iStack"></a>4.3.2 接入交换机的堆叠iStack</h2><p>iStack堆叠就是将多台设备通过堆叠口连接起来形成一台虚拟的逻辑设备。一个园区网用户上行的2个网络接口，对于堆叠后的设备，可以看作Trunk接口。</p><p>多台设备堆叠成一台设备后，从功能和管理方面，都可以作为一台设备来看待。</p><p>华为的iStack堆叠技术有如下的优势： </p><p>ü <strong>简化管理</strong></p><p>堆叠设备的角色分为Master和Slave；通过对Master 设备的配置达到管理整个iStack 堆叠以及堆叠内所有成员设备的效果，而不用物理连接到每台成员设备上分别对它们进行配置和管理。</p><p><strong>简化网络运行</strong></p><p>iStack 形成的虚拟设备中运行的各种控制协议也是作为单一设备统一运行的，例如路由协议会作为单一设备统一计算。这样省去了设备间大量协议报文的交互，简化了网络运行，缩短了网络动荡时的收敛时间。</p><p><strong>强大的网络扩展能力</strong></p><p>通过增加成员设备，可以轻松自如的扩展堆叠系统的端口数、带宽和处理能力。</p><p><strong>高可靠性</strong></p><p>堆叠的高可靠性体现在多个方面，比如：成员设备之间堆叠物理端口支持聚合功能，堆叠系统和上、下层设备之间的物理连接也支持聚合功能，这样通过多链路备份提高了堆叠系统的可靠性；堆叠系统由多台成员设备组成，Master 设备负责堆叠的运行、管理和维护，Slave 设备在作为备份的同时也可以处理业务，一旦Master 设备故障，系统会迅速自动选举新的Master，以保证通过堆叠的业务不中断，从而实现了设备级的1:N 备份。</p><p><strong>高性能</strong></p><p>由于iStack 设备是由多个支持iStack 特性的单机设备堆叠而成的，iStack设备的交换容量和端口数量就是iStack 内部所有单机设备交换容量和端口数量的总和。因此，iStack 技术能够通过多个单机设备的堆叠，轻易的将设备的交换能力、用户端口的密度扩大数倍，从而大幅度提高了设备的性能。</p><h2 id="5-园区网络安全方案规划设计"><a href="#5-园区网络安全方案规划设计" class="headerlink" title="5 园区网络安全方案规划设计"></a>5 园区网络安全方案规划设计</h2><h2 id="5-1-园区网安全方案总体规划设计"><a href="#5-1-园区网安全方案总体规划设计" class="headerlink" title="5.1 园区网安全方案总体规划设计"></a>5.1 园区网安全方案总体规划设计</h2><p><img src="https://pic2.zhimg.com/80/v2-9b29f3528db581a98619c2bdeb98f9f5_hd.jpg" alt="img" loading="lazy">图 5‑1 园区网安全方案总体设计</p><p>从园区接入、网络监管/监控、边界防御、园区出口传输安全等多纬度、多层次进行安全设计和安全防御，对内部员工进行身份认证和网络访问权限控制，对企业内部进行安全区域划分、隔离和权限控制，对企业外部用户访问进行安全控制、数据加密，防止恶意攻击。园区网全方位的</p><p>安全设计方案保证内部、外部用户访问园区网资源的安全性。</p><h2 id="5-2-园区接入安全规划设计"><a href="#5-2-园区接入安全规划设计" class="headerlink" title="5.2 园区接入安全规划设计"></a>5.2 园区接入安全规划设计</h2><p><img src="https://pic2.zhimg.com/80/v2-527ba6b04b5c60ed944efa2e520d2529_hd.jpg" alt="img" loading="lazy">图 5‑2 网络准入控制NAC</p><p>企业网交换机与华为赛门铁克的NAC方案配套，实现对接入用户的身份认证、终端健康检查，并实现基于用户角色的差异化权限控制。NAC解决方案包含三个关键组件：通信代理、网络访问控制设备（园区交换机）和认证策略服务器组：</p><p>通信代理也就是安全客户端，是安装在用户终端系统上的软件，是对用户终端进行身份认证、安全状态评估检查以及安全策略实施的主体，其主要功能包括：</p><p>支持802.1x、Portal、MAC等多种认证方式，可以与园区网交换机实现接入、汇聚层的端点准入控制。</p><p>检查用户终端的安全状态，包括操作系统版本、系统补丁等信息；同时提供与防病毒客户端联动的接口，实现与第三方防病毒客户端的联动，检查用户终端的防病毒软件版本、病毒库版本、以及病毒查杀信息，这些信息将被传递到安全策略服务器，执行端点准入的判断与控制。</p><p>安全策略实施，接收安全策略服务器下发的安全策略并强制用户终端执行，包括设置安全策略（是否监控邮件、注册表）、系统修复通知与实施（自动或手工升级补丁和病毒库）等功能。不按要求实施安全策略的用户终端将被限制在隔离区。</p><p>实时监控系统安全状态，包括是否更改安全设置、是否发现新病毒等，并将安全事件定时上报到安全策略服务器，用于事后进行安全审计。</p><p>网络访问控制设备是企业网络中安全策略的实施点，起到强制用户准入认证、隔离不合格终端、为合法用户提供网络服务的作用。园区网的网络访问控制设备推荐为华为交换机，可分别实现不同认证方式（如802.1x、MAC认证和Portal等）的端点准入控制,具备以下功能：</p><p>强制网络接入终端进行身份认证和安全状态评估。</p><p>隔离不符合安全策略的用户终端，园区交换机接收到安全策略服务器下发的隔离指令后，可以通过 VLAN 或 ACL 方式限制用户的访问权限；同样，收到解除用户隔离的指令后也可以在线解除对用户终端的隔离。</p><p>提供基于身份的网络服务，园区交换机可以根据安全策略服务器下发的策略，为用户提供个性化的网络服务，如提供不同的 QoS、ACL、VLAN 等。</p><p>根据用户接入安全控制范围需要，作为NAC网络访问控制设备的交换机可以部署在园区接入层、汇聚层，设置可部署在核心层、仅控制用户访问园区外部网络的权限。</p><p>策略服务器也就是管理服务器，NAC方案的核心是整合与联动，其中的安全策略服务器是NAC方案中的管理与控制中心，兼具用户管理、安全策略管理、安全状态检查评估、安全联动控制以及安全事件审计等功能。</p><p><strong>802.1x接入认证</strong></p><p><img src="https://pic1.zhimg.com/80/v2-c5086aa8281c1dbbb44ee4846fa86d50_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑3 802.1x接入认证流程</p><p><strong>802.1x认证过程如下：</strong></p><ol><li><p>用户在802.1x客户端输入用户名、密码，发起802.1x认证请求至园区交换机； 2) 交换机作为Radius客户端将用户名、密码发送到认证服务器进行Radius认证；</p></li><li><p>认证服务器将携带VLAN或二三层ACL的Radius属性下发至园区交换机，根据用户认证结果控制其网络访问权限；</p></li><li><p>用户获取IP地址，NAC客户端软件与策略服务器联动，按照预先定制的安全检查策略，对用户终端健康状态进行检查，检查不通过Radius COA下发VLAN或ACL，限制用户网络访问权限；</p></li><li><p>用户通过802.1x身份认证和终端健康检查后，获取业务网络访问权限。</p></li></ol><p><strong>用户MAC认证</strong></p><p><img src="https://pic4.zhimg.com/80/v2-e949721a660854fbf1d774dbd273b8cb_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑4 MAC认证流程</p><p><strong>用户MAC认证过程如下：</strong></p><ol><li><p>用户终端上电（无802.1x认证客户端），用户发起ARP或DHCP请求等报文；</p></li><li><p>园区交换机收到用户终端的数据报文，触发Radius认证请求至认证服务器，根据MAC地址生成用户名和密码；</p></li><li><p>认证服务器将携带VLAN或二三层ACL的Radius属性下发至园区交换机，根据用户认证结果控制其网络访问权限；</p></li><li><p>用户获取IP地址，NAC客户端软件与策略服务器联动，按照预先定制的安全检查策略，对用户终端健康状态进行检查，检查不通过Radius COA下发VLAN或ACL，限制用户网络访问权限；</p></li><li><p>用户通过802.1x身份认证和终端健康检查后，获取业务网络访问权限。</p></li></ol><p><strong>802.1X MAC旁路认证</strong></p><p><img src="https://pic3.zhimg.com/80/v2-11e14d7a5a1afc3f7fe9fa4b30ee4176_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑5 802.1x MAC旁路认证流程</p><p><strong>802.1x MAC旁路认证过程如下：</strong></p><ol><li><p>用户终端上电，用户发起ARP或DHCP请求等报文；</p></li><li><p>园区交换机先向用户终端发起EAP探测报文，如果用户终端已经安装802.1x认证客户端，则触发用户802.1x接入认证过程，否则进行MAC认证过程；</p></li><li><p>认证服务器将携带VLAN或二三层ACL的Radius属性下发至园区交换机，根据用户认证结果控制其网络访问权限；</p></li><li><p>用户获取IP地址，NAC客户端软件与策略服务器联动，按照预先定制的安全检查策略，对用户终端健康状态进行检查，检查不通过Radius COA下发VLAN或ACL，限制用户网络访问权限；</p></li><li><p>用户通过802.1x身份认证和终端健康检查后，获取业务网络访问权限。</p></li></ol><p><strong>WEB Portal认证</strong></p><p><img src="https://pic3.zhimg.com/80/v2-5661bc9f8207e04faa4de1987d91aae6_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑6 WEB Portal认证流程</p><p><strong>WEB Portal认证过程如下：</strong></p><ol><li><p>用户终端打开WEB页面，发起HTTP请求至园区交换机；</p></li><li><p>园区交换机进行HTTP重定向，将用户的打开的WEB页面重定向至Portal服务器；</p></li><li><p>用户访问WEB Portal页面，输入用户名和密码进行认证；</p></li><li><p>Portal服务器通过Portal 2.0协议将用户输入的用户名和密码信息发送给交换机，交换机到认证服务器进行Radius认证；</p></li><li><p>认证服务器将携带VLAN或二三层ACL的Radius属性下发至园区交换机，根据用户认证结果控制其网络访问权限；</p></li><li><p>NAC客户端软件与策略服务器联动，按照预先定制的安全检查策略，对用户终端健康状态进行检查，检查不通过Radius COA下发VLAN或ACL，限制用户网络访问权限； 7) 用户通过802.1x身份认证和终端健康检查后，获取业务网络访问权限。</p></li></ol><h2 id="5-3-园区网络监管-监控-规划设计"><a href="#5-3-园区网络监管-监控-规划设计" class="headerlink" title="5.3 园区网络监管/监控 规划设计"></a>5.3 园区网络监管/监控 规划设计</h2><h2 id="5-3-1-防IP-MAC地址盗用和ARP中间人攻击"><a href="#5-3-1-防IP-MAC地址盗用和ARP中间人攻击" class="headerlink" title="5.3.1 防IP/MAC地址盗用和ARP中间人攻击"></a>5.3.1 防IP/MAC地址盗用和ARP中间人攻击</h2><p><strong>防IP/MAC地址盗用</strong></p><p>DHCP Snooping技术是DHCP安全特性，通过建立和维护DHCP Snooping绑定表过滤不可信任的DHCP信息，这些信息是指来自不信任区域的DHCP信息。DHCP Snooping绑定表包含不信任区域的用户MAC地址、IP地址、租用期、VLAN-ID 接口等信息，DHCP Snooping绑定表可以基于DHCP过程动态生成，也可以通过静态配置生成，此时需预先准备用户的IP 地址、MAC地址、用户所属VLAN ID、用户所属接口等信息。</p><p>园区交换机开启DHCP-Snooping后，会对DHCP报文进行侦听，并可以从接收到的DHCP Request或DHCP Ack报文中提取并记录IP地址和MAC地址信息。另外，DHCP-Snooping允许将某个物理端口设置为信任端口或不信任端口。信任端口可以正常接收并转发DHCP Offer报文，而不信任端口会将接收到的DHCP Offer报文丢弃。这样，可以完成交换机对假冒DHCP Server的屏蔽作用，确保客户端从合法的DHCP Server获取IP地址。</p><p><strong>防ARP中间人攻击</strong></p><p><img src="https://pic1.zhimg.com/80/v2-7fb633ba9f33f9cba422880adfda6280_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑7 ARP中间人攻击防御</p><p>Dynamic ARP Inspection (DAI)在交换机上基于DHCP Snooping技术提供用户网关IP地址和MAC地址、VLAN和接入端口的绑定， 并动态建立绑定关系。对于用户终端没有使用DHCP动态获取IP地址的场景，可采用静态添加用户网关相关信息的静态绑定表。此时园区交换机检测过滤ARP请求响应报文中的源MAC、源IP是否可以匹配上述绑定表，不能匹配则认为是仿冒网关回应的ARP响应报文，予以丢弃，从而可以有效实现防御ARP中间人/网关ARP仿冒欺骗攻击行为。</p><h2 id="5-3-2-防IP-MAC地址扫描攻击"><a href="#5-3-2-防IP-MAC地址扫描攻击" class="headerlink" title="5.3.2 防IP/MAC地址扫描攻击"></a>5.3.2 防IP/MAC地址扫描攻击</h2><p><strong>防IP扫描攻击</strong></p><p>地址扫描攻击是攻击者向攻击目标网络发送大量的目的地址不断变化的IP报文。当攻击者扫描网络设备的直连网段时，触发ARP miss，使网络设备给该网段下的每个地址发送ARP报文，地址不存在的话，还需要发送目的主机不可达报文。如果直连网段较大，攻击流量足够大时，会消耗网络设备较多的CPU和内存资源，可引起网络中断。</p><p>园区交换机支持IP地址扫描攻击的防护能力，收到目的IP是直连网段的报文时，如果该目的地址的路由不存在，会发送一个ARP请求报文，并针对目的地址下一条丢弃表项（弃后续所有目的地址为该直连网段的ARP报文），以防止后续报文持续冲击CPU。如果有ARP应答，则立即删除相应的丢弃表项，并添加正常的路由表项；否则，经过一段时间后丢弃表项自动老化。这样，既防止直连网段扫描攻击对交换机造成影响，又保证正常业务流程的畅通。</p><p>在上述基础上，交换机还支持基于接口设置ARP miss的速率。当接口上触发的ARP miss超过设置的阈值时，接口上的ARP miss不再处理，直接丢弃。</p><p>如果用户使用相同的源IP进行地址扫描攻击，交换机还可以基于源IP做ARP miss统计。如果ARP miss的速率超过设定的阈值，则下发ACL将带有此源IP的报文进行丢弃，过一段时间后再允许通过。</p><p><strong>防MAC地址扫描攻击</strong></p><p>以太网交换机的MAC地址转发表作为二层报文转发的核心，在受到攻击的时候，直接导致交换机无法正常工作。发生MAC地址攻击的时候，攻击者向攻击目标网络发送大量的源MAC地址不断变化以太报文，园区交换机收到以太报文会基于报文的源MAC学习填充二层MAC转发表项，由于MAC地址转发表的规格有限，会因为MAC扫描攻击而很快填充满，无法再学习生成新的MAC转发表，已学习的MAC表条目需通过老化方式删除，这样途径园区交换机大量的单播报文会因为按照目的MAC找不到转发表项而不得不进行广播发送，导致园区网络中产生大量的二层广播报文，消耗网络带宽、引发网络业务中断异常。</p><p>交换机二层MAC转发表是全局共享资源，单板内各端口/VLAN共享一份MAC转发表，华为园区交换机支持基于端口/VLAN的MAC学习数目限制，同时支持MAC表学习速率限制，有效防御MAC地址扫描攻击行为。MAC学习数目达到端口/VLAN上设置的阈值时，会进行丢弃/转发/告警等动作（动作策略可定制、可叠加）。另外通过园区交换机的MAC地址与端口绑定来限制跨端口的MAC扫描攻击。</p><h2 id="5-3-3-广播-组播报文抑制"><a href="#5-3-3-广播-组播报文抑制" class="headerlink" title="5.3.3 广播/组播报文抑制"></a>5.3.3 广播/组播报文抑制</h2><p>攻击者不停地向园区网发送大量恶意的广播报文，恶意广播报文占据了大量的带宽，传统的广播风暴抑制无法识别用户VLAN，将导致正常的广播流量一并被交换机丢弃。园区网交换机需要识别恶意广播流量的VLAN ID，通过基于VLAN的广播风暴抑制丢弃恶意广播报文而不影响正常广播报文流量转发。可基于端口或VLAN限制广播报文流量百分比或速率阈值。</p><p>同时园区网交换机支持组播报文抑制，可基于端口限制组播报文流量百分比或速率阈值。</p><h2 id="5-4-园区网边界防御-规划设计"><a href="#5-4-园区网边界防御-规划设计" class="headerlink" title="5.4 园区网边界防御 规划设计"></a>5.4 园区网边界防御 规划设计</h2><h2 id="5-4-1-防火墙部署规划设计"><a href="#5-4-1-防火墙部署规划设计" class="headerlink" title="5.4.1 防火墙部署规划设计"></a>5.4.1 防火墙部署规划设计</h2><p><img src="https://pic4.zhimg.com/80/v2-5d55ac60b912355a4b4eaa4ab66a055f_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑8 园区网防火墙功能部署</p><p>企业园区网边界防御分为两个部分：园区出口边界防御、园区内部边界防御。</p><p>园区出口连接Internet和企业WAN网的接入，企业外部网络尤其Internet网络，是各种攻击行为、病毒传播、安全事件引入的风险点，通过在企业出口部署高性能防火墙设备、或者在核心交换机内置防火墙模块，可以很好的缓解风险的传播，阻挡来自Internet/企业外部网络攻击行为的发生。企业园区出口位置部署的独立防火墙设备（或核心交换机内置的防火墙模块），需要满足高性能、高可靠、高安全的要求，是企业园区网的第一道安全屏障。</p><p>园区内部边界防御是将企业内部划分为多个区域，分为信任区域和非信任区域，分别实施不同的安全策略，包括部署区域间隔离、受限访问、防止来自区域内部的DOS攻击等安却措施。建议通过汇聚交换机上集成防火墙模块（单板）来实现园区内部的边界防御功能。</p><p>园区网中防火墙功能无论是独立设备部署还是集成在核心/汇聚交换机内部，都必须支持灵活的业务流控制策略配置，能把特定的流量引到防火墙进行处理，其他流量进行旁路。</p><p>防火墙本身需要保证高可靠性，需要考虑防火墙的冗余设计，支持Active/Active HA 设计方式，即交换机内集成的多块防火墙板卡支持负载分担和主备模式，不同交换机内的防火墙支持Active/Active模式，同时能够处理流量。</p><h2 id="5-4-2-防火墙功能规划设计"><a href="#5-4-2-防火墙功能规划设计" class="headerlink" title="5.4.2 防火墙功能规划设计"></a>5.4.2 防火墙功能规划设计</h2><p>网络隔离：能够对网络区域进行分割，对不同区域之间的数据流进行控制，通过对数据包的源地址、目的地址、源端口、目的端口、网络协议等参数的检查，实现对数据流的精细控制，把可能的安全风险控制在相对独立的区域内；</p><p>包过滤：支持基于ACL的基本包过滤，支持基于FTP、HTTP等应用层协议包过滤（ASPF）；</p><p>攻击防范：对常见的ICMP重定向/不可达、TCP SYN/ARP FLOOD、Land、Smurf、TearDrop、网络端口扫描、畸形报文、拒绝服务（DoS/DDoS）等攻击行为，能够提供有效的检测和防范措施。</p><p>NAT/PAT：支持园区外部公网地址到内部私网地址的代理转换，支持应用层网关ALG功能。</p><h2 id="5-4-3-防火墙性能选择"><a href="#5-4-3-防火墙性能选择" class="headerlink" title="5.4.3 防火墙性能选择"></a>5.4.3 防火墙性能选择</h2><p>园区网防火墙的选择首先是安全防护能力，对于每秒新建连接数，并发连接数和吞吐量，ACL匹配速度，DDOS识别均要进行重点考察。</p><p>防火墙的性能主要取决于以下参数：</p><p>转发性能：从吞吐量方面考虑,决定设备的防护性能</p><p>并发连接数： 从数据流数目方面考虑,决定设备的防护性能</p><p>每秒新建连接数：决定单位时间的防护能力</p><p>ACL匹配速度：决定规则匹配的可靠和性能</p><p>华为S93系列集成的防火墙单板在性能方面有突出的表现：</p><p>转发性能：每单板支持10Gbps (256Bytes)的吞吐量</p><p>并发连接数：每单板达到400万的并发连接</p><p>每秒新建连接数：每单板达到10万/，,同级别产品通常不足3万</p><p>ACL匹配速度：采用智能匹配算法，万条匹配速度和单条速度一致，即ACL匹配动作不影响防火墙整体转发性能</p><p>华为S93系列交换机集成的防火墙模块，每单板支持8Gbps的转发能力，400万的并发连</p><p>接，每秒钟15万的新建流速度；并且支持1K的虚拟化多实例。</p><h2 id="5-4-4-虚拟防火墙规划设计"><a href="#5-4-4-虚拟防火墙规划设计" class="headerlink" title="5.4.4 虚拟防火墙规划设计"></a>5.4.4 虚拟防火墙规划设计</h2><p>企业内部不同的部门具备不同的安全属性，部门内部需要进行独自的安全区域划分、并应用不同的安全策略。如下图所示，可以通过防火墙支持虚拟化实现上述需求，一个物理防火墙对资源进行划分和隔离，分配给企业内不同的部门使用，虚拟防火墙直接互相独立，就好像独立物理的防火墙一样，进行独立配置和控制。</p><p><img src="https://pic2.zhimg.com/80/v2-50302d7131326557fd277713b91f6df9_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑9 虚拟防火墙设计</p><p>总结一下，虚拟防火墙具备如下特征：</p><p>同物理防火墙一样独立管理、独立设置、每个虚拟防火墙专用的系统日志和攻击日志，以及每个虚拟防火墙的各种内部组件——例如独立路由表、转换数据库、ACL等 </p><p>可通过VLAN划分园区网用户（PC机/服务器）属于那个虚拟防火墙 </p><p>一台物理防火墙虚拟成多个逻辑防火墙，节省投资和维护成本 </p><p>适合于大型企业园区各分支部门对防火墙相对独立使用和维护的场景</p><h2 id="5-4-5-NAT规划设计"><a href="#5-4-5-NAT规划设计" class="headerlink" title="5.4.5 NAT规划设计"></a>5.4.5 NAT规划设计</h2><p>考虑到园区内网安全和企业公网地址缺乏等原因，会有一些企业选择通过采用私网IP地址来建设园区网，可以隐藏企业园区内部网络拓扑，需要在企业出口通过NAT设备进行IP地址转换。为了进行安全防护，NAT功能一般部署在防火墙设备上。NAT的应用一般主要有如下的应用场景：</p><p><strong>1) PAT方式</strong></p><p>它通过使用“IP地址＋端口号”的形式进行转换，使多个私网用户可共用一个公网IP地址访问外网，是地址转换实现的主要形式。</p><p><strong>2) NAT Server方式</strong></p><p>一般情况下，Internet/WAN上的用户，无法直接访问NAT后的私网地址服务器的； 但实际应用中，需要给公网用户提供一个访问私网服务器(如DNS服务器)的机会。 NAT Server方式就可以解决这个问题——通过静态配置“公网IP地址＋端口号”与“私网IP地址＋端口号”间的映射关系，NAT设备可以将公网地址“反向”转换成私网地址。</p><p>在部署NAT时，需要考虑应用级ALG， 因为通常情况下，NAT只改变IP报文头部地址信息，而不对报文载荷进行分析，这对于普通的应用层协议（如Telnet）来说，并不会影响其业务的开展；然而有一些应用层协议，其报文载荷中可能也携带有数据通道的地址或端口信息，若这些信息不能被有效转换，就可能导致问题。所以，NAT需要采用ALG机制处理多种应用层协议。</p><p>华为S9300交换机内置防火墙模块上的NAT功能， 支持上述企业园区网NAT需求，包括： </p><p>1对1的IP地址转换</p><p>PAT方式的多对多的IP地址转换：每板地址池：1K，地址池中地址个数：255 </p><p>NAT Server功能,支持每板1K个Server</p><p>ALG功能包括DNS、FTP、TFTP、ICMP、RTSP、SIP、QQ、MSN 等 </p><p>NAT多实例</p><h2 id="5-5-园区网出口安全规划设计"><a href="#5-5-园区网出口安全规划设计" class="headerlink" title="5.5 园区网出口安全规划设计"></a>5.5 园区网出口安全规划设计</h2><p>随着现代社会网络经济的发展，企业日益发展扩大，办事处、分支机构以及商业合作伙伴逐步增多，如何将这些小型的办公网络和企业总部网络进行经济灵活而有效的互联，并且与整个企业网络安全方案有机融合，提高企业信息化程度，优化商业运作效率，成为企业IT网络设计亟待解决的问题；大量普及的SOHO网络、小型办公网络、智能家居网络也越来越注重接入的便捷性和网络安全性。</p><p><img src="https://pic3.zhimg.com/80/v2-277788db4419b1426820ffb7179f834e_hd.jpg" alt="img" loading="lazy"></p><p>图 5‑10 园区网出口安全设计</p><p>企业园区网出口设备是企业内部网络与外部网络的连接点，其安全保证能力非常重要，企业在信息化的过程中面临核心技术、商业机密泄密等信息安全问题，VPN技术是企业传输数据非常理想的选择，因为VPN技术正式是为了解决在不安全的Internet上安全传输机密信息，保证信息的完整性、可用性以及保密性，包括IPSec VPN和SSL VPN。企业办事处、分支机构以及商业合作伙伴如果采用主机VPN客户端接入企业总部网络，那么分之机构网络中的每个主机需要单独拨号接入，VPN接入不可控造成内部网络安全隐患，同时也大量消耗企业总部VPN网关隧道资源；如果采用单独的VPN网关与企业总部网关建立VPN隧道，又面临投资过大的问题。需要有效解决企业分支机构VPN接入灵活性、安全性和经济性之间的矛盾。</p><p>园区出口设备形态推荐：</p><p><strong>接入路由器</strong></p><p>针对企业办事处、分支机构、商业合作伙伴以及SOHO办公、智能家居等园区网络要求，采用华为SRG列业务路由网关（SRG1210/1220/2210/2220等多款产品）或AR系列接入路由器（AR18/28/46、AR19/29/49）作为园区网出口设备，集路由、交换、无线与数据安全于一体，能够提供灵活的宽带接入、WLAN解决方案、3G无线上网、NAT/PAT地址转换、攻击防范、状态检测等特性，全面满足客户自由安全联网需求。</p><p><strong>交换机</strong></p><p>针对部分小型园区网，可采用华为S9300交换机作为园区出口设备，考虑到降低设备投资成本，园区出口设备和核心交换机可以合一，通过S9300的WAN接口板提供POS/GE/10GE等广域网接口与企业外部网络互联，同时S9300作为园区核心交换机，下连各个汇聚交换机，S9300通过增值业务单板提供IPsec VPN和SSL VPN，满足企业分支机构安全互联以及企业员工或外部访客远程访问园区网的需求。</p><h2 id="6-园区网络网管系统方案规划设计"><a href="#6-园区网络网管系统方案规划设计" class="headerlink" title="6 园区网络网管系统方案规划设计"></a>6 园区网络网管系统方案规划设计</h2><h2 id="6-1-网管系统概述"><a href="#6-1-网管系统概述" class="headerlink" title="6.1 网管系统概述"></a>6.1 网管系统概述</h2><p>网管系统 提供了“无缝式IT运维管理”功能，其系统架构清晰，采用模块化的设计理念，各功能模块既可独立运行、松散耦合；亦可整体功能无缝衔接覆盖整个业务系统，灵活的自由组合真正实现个性化的IT无忧运维。</p><p>网管系统主要由网络管理、流量管理、认证计费等几个产品组成。</p><p><strong>网络管理：</strong>实现了对交换机、路由器、防火墙等设备的全方位管理，提供了丰富的拓扑、配置、资产、故障、性能、事件、流量、报表等网络管理功能。</p><p><strong>流量管理：</strong>提供网络流量监测、流量门限、协议分析、Web上网行为审计等功能。结合NetFlow网络流量分析器实现更为细化、便捷的全网流量分析功能。</p><p><strong>认证计费：</strong>提供灵活多样的计费策略，支持多种认证方式，满足组性化的用户管理，实现多样化的控制策略。</p><p>通过网管系统模块可以实现对IT资源的全面、可视化、统一管理。</p><p><img src="https://pic2.zhimg.com/80/v2-ca94d77f5504c02fb071a3249dc97879_hd.jpg" alt="img" loading="lazy"></p><p>图 6‑1 企业网网管系统组件</p><h2 id="6-2-系统优势介绍"><a href="#6-2-系统优势介绍" class="headerlink" title="6.2 系统优势介绍"></a>6.2 系统优势介绍</h2><p><strong>多角度管理:</strong></p><p>面向基础设施：提供全面的IT资源管理，实现对网络、主机、存储设备、安全设备、数据库、中间件及应用软件等IT资源的全面监控和管理；同时对网络和业务应用等IT资源的性能进行监控，定期性能报表和趋势报表，为IT系统性能优化提供科学依据。</p><p>面向维护管理人员：将人、技术与流程进行有效地融合，实现日常运维工作的自动化、信息化和标准化，实时展现当前企业IT系统的运行状态及趋势，帮助管理人员快速定位问题，修复故障，保障业务系统的稳定性，知识库能降低IT运维管理对个人的依赖。</p><p>面向领导决策者：可及时汇总系统运行状态信息，帮助领导全面了解IT系统状况和趋势，为其提供科学依据。同时可借助自动生成的多种工作记录，实现对运维人员的绩效考核，提高团队技术水平，建立以客户为中心的运维模式，提供低成本、高质量的IT服务，提高客户满意度</p><p>立体化分级管理：可根据不同用户的组织结构、地理分布及业务关系，实施跨地域、层次化的统一管理模式，使责权管理更加明确，拓扑图更加清晰，提高系统的工作效率；</p><p><strong>主动预警：</strong></p><p>对网络关键设备设置相关阈值，当达到范围时，自动产生告警，并执行事先设置动作。</p><p>内置解释器，告警信息可按指定方式进行解释，更加明白易懂。</p><p>支持声音、邮件和手机短信等多种告警方式，确保信息通知到相应负责人；</p><p><strong>资产生命周期管理：</strong></p><p>从运维的角度对IT资产进行管理，包括相关配置、使用年限、维修记录等。</p><p>全程跟踪记录IT设备的使用周期，包括入库、领用、使用负荷和报废等。</p><p>减少设备流失，提高设备利用率，以最少的资金投入带来最大的回报；</p><p><strong>易于使用：</strong>操作简单方便，拓扑图支持全屏显示、局部放大镜、延时拖动、鹰眼、拖动图标无极缩放等丰富的操作功能，并支持任意层次的拓扑结构划分；</p><p><strong>易于部署：</strong>无需在被监测信息系统、服务器上安装任何代理软件，只需将系统安装在一台管理机上，即可自动进行监测和管理，同时对现有系统性能影响甚微，不会改变现有系统的应用配置，便于安装实施、维护使用。</p><p><strong>易于定制：</strong>提供了灵活的Web方式的客户化定制、发布工具，可对软件界面呈现及风格、数据库表、对象属性和方法进行灵活配置和定制，以满足用户特定的业务需求；提供了丰富的扩展和开发接口，可以快捷的集成各种管理工具，可以快速将各类IT资源纳入到系统管理范围内，加入到IT服务管理的流程中；此外，可视化的客户定制工具可以支持用户灵活定义和调整流程，以支持组织架构和流程的变化和发展。</p><h2 id="6-2-1-网络管理优势功能"><a href="#6-2-1-网络管理优势功能" class="headerlink" title="6.2.1 网络管理优势功能"></a>6.2.1 网络管理优势功能</h2><p><strong>业界领先的全自动拓扑发现技术</strong></p><p>自动搜索网络、发现网络节点，包括：网络设备、服务器、打印机、PC主机及VLAN等，并基于网络的二层连接关系构建物理拓扑。</p><p><strong>故障智能预测与分析</strong></p><p>通过实时的网络运行监测，Apex U2810可智能分析和预测潜在故障，并根据告警程度的不同发送警报。</p><p><strong>智能阈值技术</strong></p><p>能为每一个IT资源监控项给出科学的差异化阈值设置指导，并可随着时间段和业务量的变化进行动态调整。</p><p><strong>网络拓扑快速全面</strong></p><p>可快速全面的呈现网络拓扑结构，自动发现网络及其承载的服务，并支持多种协议。</p><p><strong>支持分布式管理</strong></p><p>支持多用户，多角色，IT运维人员，决策人员，不同角色有不同权限，不同区域级别也有不同权限。</p><p><strong>多维度监控</strong></p><p>支持从路由、设备、终端、流量、故障等方面多角度、细颗粒度地监控、管理整个IT网络。</p><h2 id="6-2-2-网络流量分析器优势功能"><a href="#6-2-2-网络流量分析器优势功能" class="headerlink" title="6.2.2 网络流量分析器优势功能"></a>6.2.2 网络流量分析器优势功能</h2><p><strong>简化的带宽监控</strong></p><p>NetFLow Analyzer能分析园区网交换机和出口路由器等设备中导出的Netstream数据。它支持标准的的操作硬件，支持Windows和Linux环境，易于部署易于操作，且无需广泛培训。</p><p><strong>深入的流量分析</strong></p><p>无需使用硬件探针或其他设备，NetFlow Analyzer能简单有效地执行流量分析。除了设置路由/交换设备导出NetFlow数据到NetFlow Analyzer，不需要其它的配置。</p><p><strong>全面显示流量信息</strong></p><p>NetFlow Analyzer通过NetFlow数据能呈现占用带宽最多的应用、主机和会话。要了解高峰时间的使用和历史趋势，该信息就显得非常重要。此外，从长期来看这些信息还可用于带宽容量规划和巩固安全策略。</p><p><strong>高效的带宽利用</strong></p><p>在多数企业中，对带宽不加管理将导致在高峰时间不重要的应用具有高于重要应用的优先级。NetFlow Analyzer中的带宽报表准确地显示了哪些应用在高峰时间使用带宽，并深入分析使用这些应用的主机。这将有助于控制带宽使用并加强企业安全策略。</p><p><strong>灵活的设备管理</strong></p><p>NetFlow Analyzer可以将NetFLow输出设备分组到不同的组别，以便进行针对性监控，以及向用户授予访问权限。利用NetFlow Analyzer中的设备分组，就可以专门管理某组导出NetFlow数据的设备，您可以将操作员指派到不同的组，监控带宽利用情况，以及查看针对每个设备组的流量模式。</p><p><strong>降低运维成本</strong></p><p>NetFlow Analyzer通过简化管理任务以降低成本。比起分析数据包需要许多时间分析结果并得到结论，故障诊断只需要相当少的时间。带宽报表以及深入分析选项使得流量分析更加快速有效，从而高效地使用企业的重要资源。</p><p><strong>高效的报表，易于趋势分析</strong></p><p>NetFlow Analyzer提供了丰富的带宽报表，便于分析流量的相关信息。通过查看不同时段的流量模式，NetFlow Analyzer显著简化了趋势分析过程。NetFlow Analyzer具有30多种不同的图表和报表，并带有能深入分析特定明细的选项，便于用户直接访问重要的信息。用户可以在线查看不同时段的图表，并将其输出为PDF格式。</p><p><strong>完全基于Web</strong></p><p>NetFlow Analyzer完全基于web，因此只需一个web浏览器就可以从网络中的任何位置跨WAN链接轻松查看流量报表。</p><h2 id="6-2-3-认证计费优势功能"><a href="#6-2-3-认证计费优势功能" class="headerlink" title="6.2.3 认证计费优势功能"></a>6.2.3 认证计费优势功能</h2><p><strong>成熟先进的宽带综合业务管理平台</strong></p><p>集成实时计费、业务管理和客户管理，提供各种应用的运行和管理、计费平台</p><p><strong>先进宽带运营理念的载体</strong></p><p><strong>基于用户的全方位管理控制手段</strong></p><p><strong>支持多种接入认证方式：</strong></p><p>802.1x、</p><p>WEB、</p><p>PPPoE、</p><p>RADIUS认证</p><p><strong>多层次计费策略：</strong></p><p>针对储值卡、充值卡有效期设置；</p><p>支持交费送免费用量设置；</p><p>提供信用额功能，允许用户超支部分用量；</p><p>支持预付费、后付费方式；</p><p>支持月结、即用即结、先付后用、包日等结算方式；</p><p>支持期限用户，即按每月固定月租，开通日开始计费，服务结束日自动停机，可以续交费，计费开始日自动按续费日开始计算；</p><p>支持月结延迟停机，在线催费；</p><p>支持开机停机预受理；</p><p><strong>灵活的控制策略：</strong></p><p>用户每日上网时段控制；</p><p>目标地址控制过滤策略；</p><p>目标端口控制策略；</p><p>源地址控制策略；</p><p>每日或每月上网时间和流量上限控制策略；</p><p>完整的登录记录、访问记录；</p><p>完整的设备运行日志</p><h2 id="6-3-网管系统部署"><a href="#6-3-网管系统部署" class="headerlink" title="6.3 网管系统部署"></a>6.3 网管系统部署</h2><h2 id="6-3-1-集中式网管系统部署"><a href="#6-3-1-集中式网管系统部署" class="headerlink" title="6.3.1 集中式网管系统部署"></a>6.3.1 集中式网管系统部署</h2><p><img src="https://pic3.zhimg.com/80/v2-7483e7441c549e4ce0899cf884f36d9a_hd.jpg" alt="img" loading="lazy"></p><p>图 6‑2 集中式网管系统部署</p><p><strong>硬件推荐配置：</strong></p><p><strong>软件推荐配置：</strong></p><p>操作系统</p><p>数据库</p><p>Web服务器</p><h2 id="6-3-2-分布式网管系统部署"><a href="#6-3-2-分布式网管系统部署" class="headerlink" title="6.3.2 分布式网管系统部署"></a>6.3.2 分布式网管系统部署</h2><p>系统可以通过将网管服务和数据库分离，降低数据库系统和网管服务器在高负荷状态下的相互影响。目前可将网管服务器和南向接口服务器分离。一方面可以降低南向接口承受的通信压力对网管服务器造成的影响。另外，对于大规模的网络，通过部署多个南向接口服务器，可以提高通信效率，降低单点失效造成的全网无法管理的风险。</p><p>网络管理系统均部署在一台中心服务器（以下简称Apex中心服务器）上，并通过PlusWell HA Cluster做集群。数据库服务器单独部署一台服务器，流量分析单独部署一台服务器，网络管理的二级系统部署在一台二级服务器上，分布在各个分支机构，可已经根据网络规模的不断增长灵活扩容。</p><p><img src="https://pic2.zhimg.com/80/v2-f7ead39000ee1c32e6f755ca9bde88ad_hd.jpg" alt="img" loading="lazy"></p><p>图 6‑3分布式网管系统部署</p><p><strong>硬件推荐配置：</strong></p><p><strong>软件推荐配置：</strong></p><h2 id="7-园区网络设备介绍"><a href="#7-园区网络设备介绍" class="headerlink" title="7 园区网络设备介绍"></a>7 园区网络设备介绍</h2><h2 id="7-1-园区汇聚-核心交换机"><a href="#7-1-园区汇聚-核心交换机" class="headerlink" title="7.1 园区汇聚/核心交换机"></a>7.1 园区汇聚/核心交换机</h2><p>Quidway® S9300系列运营级园区汇聚交换机是由华为公司自主开发的新一代高性能核心路由交换机产品，提供大容量、高密度、模块化的二到四层线速转发性能，具有强大组播功能，完善的QoS保障、有效的安全管理机制和电信级的高可靠设计，满足高端用户对多业务、高可靠、大容量、模块化的需求，降低运营商的建网成本和维护成本，可广泛应用于构建各种类型型园区网核心层和汇聚层交换机，对于接入交换机性能和接口密度要求高的某些大型园区网，也可使用S9303/S9306系列交换机作为接入交换机使用。</p><p><strong>产品特点</strong></p><p><strong>先进体系结构，高性能，配置灵活</strong></p><p>S9300系列交换机采用先进的全分布式体系结构设计，采用业界最新的硬件转发引擎技术，所有端口支持的业务能够线速转发，业务包括IPv4/MPLS/二层转发等。支持ACL线速转发。</p><p>S9300系列交换机实现组播线速转发，硬件完成两级复制：交换网板复制到接口板和转发引擎复制到接口。</p><p>S9300支持2Tbps交换容量，支持多种高密度板卡，满足核心、汇聚层设备大容量、高端口密度的要求，可以满足用户日益增长的带宽需求，能够极大的保护和节约用户投资。</p><p><strong>设备的性能规格参数：</strong></p><p><strong>安全机制</strong></p><p><strong>可靠性</strong></p><p>链路汇聚：S9300系列交换机最大支持128个汇聚组，每个汇聚组内支持最多8个成员端口，支持跨单板端口间的汇聚。</p><p>支持DLDP（Device Link Detection Protocol，设备连接检测协议）：可以监控光纤或铜质双绞线的链路状态。如果发现单向链路存在，DLDP会根据用户配置，自动关闭或通知用户手工关闭相关端口，以防止网络问题的发生。</p><p>支持RRPP及多实例：相比其他以太环网技术，RRPP具有以下优势――拓扑收敛速度快，低于50ms。收敛时间与环网上节点数无关，可应用于网络直径较大的网络。</p><p>支持标准STP/RSTP/MSTP二层环网保护协议</p><p>支持SmartLink及多实例</p><p>支持BFD for 单播路由/VRRP/FRR/PIM</p><h2 id="7-2-园区接入交换机"><a href="#7-2-园区接入交换机" class="headerlink" title="7.2 园区接入交换机"></a>7.2 园区接入交换机</h2><h2 id="7-2-1-Quidway-S5300系列交换机"><a href="#7-2-1-Quidway-S5300系列交换机" class="headerlink" title="7.2.1 Quidway S5300系列交换机"></a>7.2.1 Quidway S5300系列交换机</h2><p>Quidway S5300系列运营级园区交换机是华为公司为满足大带宽及多业务承载需求而推出的新一代全千兆运营级三层以太网交换机。S5300基于新一代高性能硬件和华为公司统一的VRP(Versatile Routing Platform)软件平台，支持万兆上行，提供高密度下行千兆端口，支持多种运营级可靠性技术，具备良好的扩展性和多业务接入/汇聚能力，可充分满足园区网络接入层交换机的应用需求。S5300为盒式产品设备，机箱高度1U，提供普通型(SI)和增强型(EI)产品版本，包括型号：S5328C-EI、S5328C-EI-24S、S5352C-EI、S5324TP-SI、S5324TP-PWR-SI、S5348TP-SI、S5348TP-PWR-SI、S5328C-PWR-EI、S5352C-PWR-EI、S5328C-SI、S5352C-SI、S5328C-PWR-SI、S5352C-PWR-SI。</p><p><strong>产品特点：</strong></p><p><strong>大带宽、高性能</strong></p><p>S5300最大可提供48个GE接口，以及4个GE接口或者2个10GE接口，充分满足对高密度千兆和万兆上行设备的需求。S5300硬件支持二/三层数据包线速转发能力。 </p><p><strong>强大的组播功能</strong></p><p>S5300支持组播组，支持可控组播、IGMP Snooping/Proxy/Filter/Fast leave等特性。S5300支持线速的跨VLAN组播复制，支持捆绑端口的组播负载分担，支持基于VLAN的组播呼叫接纳控制功能(组播CAC)，支持IPv6组播，支持MLD V1/V2 snooping, 充分满足IPTV等组播业务的运营要求。</p><p><strong>运营级高可靠性</strong></p><p>S5300不仅支持STP/RSTP/MSTP生成树协议，还支持树形(Smartlink/Monitorlink)和环形(RRPP)拓扑等增强型运营级以太网链路冗余保护技术，实现毫秒级的链路保护倒换，保证高可靠性业务要求的网络质量。</p><p>S5300支持Smartlink和RRPP的多实例功能，可实现链路负载分担，进一步提高链路带宽利用率。S5300支持BFD快速链路检测，可以为OSPF、ISIS、VRRP、PIM等路由协议提供毫秒级的连通性检测机制，提高网络拓扑收敛速度。</p><p>S5300同时提供Eth-OAM功能，802.1ag提供端到端可靠性检测，802.3ah提供最后一公里故障检测和链路性能管理。此外，S3300支持BPDU tunnel功能，为用户利用运营商提供的专线构建自己的二层网络提供可能。</p><p><strong>卓越的安全特性</strong></p><p>S5300支持MCE功能，实现不同VPN用户在同一台设备上的路由隔离，有效解决用户的数据安全问题，同时降低用户设备投资成本。S5300提供多种用户安全保护功能，支持大ACL表项，支持IP/MAC/端口的组合绑定，支持黑洞MAC地址、端口隔离、MAC地址学习数目限制、、端口安全、Sticky MAC、MFF、动态ARP检测、IP SOURCE GUARD等安全技术，支持Radius、Tacacs、802.1x、NAC、SSH等认证技术，为网络穿上坚实的保护衣。</p><p><strong>iStack功能</strong></p><p>S5300全系列产品支持堆叠功能，提供高速堆叠模块，支持双向48Gbps的堆叠带宽，在保证了堆叠设备高性能的同时，简化了管理和网络运行，降低了成本，提供强大的网络扩展能力，保障了网络的可靠性。</p><p><strong>支持IPv6功能</strong></p><p>S5300支持IPv6协议，支持双栈，实现了多种IPv6协议，支持IPv4向IPv6的多种过渡技术，实现了IPv6的多种路由协议，为下一代网络提供了保证。</p><h2 id="7-2-2-Quidway-S3300系列交换机"><a href="#7-2-2-Quidway-S3300系列交换机" class="headerlink" title="7.2.2 Quidway S3300系列交换机"></a>7.2.2 Quidway S3300系列交换机</h2><p>Quidway S3300系列运营级园区交换机是华为公司为满足以太网多业务承载需要而推出的新一代园区接入三层交换机。S3300基于新一代高性能硬件和华为公司统一的VRP(Versatile Routing Platform)软件平台，提供增强型灵活QinQ功能，具备限速的跨VLAN组播复制能力，支持环形拓扑和树形拓扑等运营级组网技术，具备以太网OAM功能，提供高性能低成本的堆叠功能，是企业网的楼宇、小区接入等多种场合的最佳选择。</p><p>S3300为盒式产品设备，机箱高度1U，从特性上划分为标准型(SI)和增强型(EI)两个产品版本，标准型支持二层和基本的三层功能，增强型支持复杂的路由协议和丰富的业务特性，包含型号：S3328TP-SI、S3352P-SI、S3328TP-EI、S3328TP-EI-24S、S3325-EI、S3325-EI-24S、S3325-EI-48S、S3328TP-PWR-EI、S3352P-PWR-EI。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;原文链接：&lt;a href=&quot;https://zhuanlan.zhihu.com/p/53512258&quot;&gt;https://zhuanlan.zhihu.com/p/53512258&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-项目概述&quot;&gt;&lt;a href=&quot;#1-项目概述&quot; class=&quot;headerlink&quot; title=&quot;1 项目概述&quot;&gt;&lt;/a&gt;1 项目概述&lt;/h2&gt;&lt;p&gt;根据实际情况增加项目介绍&lt;/p&gt;
&lt;h2 id=&quot;1-1-项目背景&quot;&gt;&lt;a href=&quot;#1-1-项目背景&quot; class=&quot;headerlink&quot; title=&quot;1.1 项目背景&quot;&gt;&lt;/a&gt;1.1 项目背景&lt;/h2&gt;&lt;h2 id=&quot;1-2-项目目标&quot;&gt;&lt;a href=&quot;#1-2-项目目标&quot; class=&quot;headerlink&quot; title=&quot;1.2 项目目标&quot;&gt;&lt;/a&gt;1.2 项目目标&lt;/h2&gt;&lt;h2 id=&quot;2-园区总体系统规划设计&quot;&gt;&lt;a href=&quot;#2-园区总体系统规划设计&quot; class=&quot;headerlink&quot; title=&quot;2 园区总体系统规划设计&quot;&gt;&lt;/a&gt;2 园区总体系统规划设计&lt;/h2&gt;&lt;h2 id=&quot;2-1-需求分析&quot;&gt;&lt;a href=&quot;#2-1-需求分析&quot; class=&quot;headerlink&quot; title=&quot;2.1 需求分析&quot;&gt;&lt;/a&gt;2.1 需求分析&lt;/h2&gt;&lt;p&gt;随着企业信息化建设不断深入，企业的生产业务系统、经营管理系统、办公自动化系统均得到大力发展，对于企业园区网的建设要求越来越高。传统园区网建设初期往往面临如下问题：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(一)&lt;/strong&gt; &lt;strong&gt;网络架构较为混乱，不便于扩容和维护管理：&lt;/strong&gt;园区网在建设初期，设备和光纤/电缆随意布放，缺乏统一的网络分层规划管理，网络拓扑相对混乱，不便于对网络性能瓶颈进行正确评估和有效扩容，给日常网络管理也带来很大难度。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(二)&lt;/strong&gt; &lt;strong&gt;网络可靠性规划不合理，影响企业生产和经营管理、造成投资浪费：&lt;/strong&gt;由于缺乏有效的园区网规划，对于网络可靠性考虑不够，网络中既存在单点故障导致网络可靠性低、影响企业生产和经营管理行为，同时也存在网络过度冗余、造成投资浪费的现象。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(三)&lt;/strong&gt; &lt;strong&gt;网络信息安全存在隐患：&lt;/strong&gt;网络安全性是园区网建设的重中之重，传统园区网安全漏洞较多，无法应对内外部用户日益猖獗的网络攻击行为（例如：对园区网设备进行攻击、消耗网络带宽、窃取企业核心电子资产信息），对于内部和外部用户缺乏有效的身份认证手段、用户可随意接入网络，网络层面的安全保证和防御措施也不到位，造成园区网的脆弱和易攻击。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(四)&lt;/strong&gt; &lt;strong&gt;无法满足日益增长的网络业务需求：&lt;/strong&gt;随着企业的业务发展，出现了基于园区网基础设施的丰富增值业务需求，例如：网络接入形式要求多样化，支持WLAN无线接入，满足移动办公、大区域无线缆覆盖等特殊要求；对于企业用户访问外网进行计费，计费策略可灵活设置（时长计费、流量计费、按目的地址计费）；企业多出口链路场景下的负载均衡、灵活选路需求。传统园区网建设缺乏有效满足这些增值业务需求的统一解决方案考虑，支持这些业务存在园区网络分散建设、重复投资的问题。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(五)&lt;/strong&gt; &lt;strong&gt;缺乏简单有效的网络管理系统，企业IT网络运维部门面临很大压力：&lt;/strong&gt;当前，企业网IT运维部门面临很大的网络运维压力，来自于园区网内外部的安全事件频发、网络可靠性低引起的网络业务中断现象，网络故障诊断、分析定位过程对于IT运维人员的技术能力和经验水平要求较高，缺乏简单有效/低成本的图形化网管工具、进行实时网络拓扑显示、状态监控和各种故障事件预警/告警展示。另外，IT运维部门也需要实施统计园区网各路径的流量信息，便于对网络带宽进行管理和规划，给后续网络扩容提供参考。&lt;/p&gt;
&lt;h2 id=&quot;2-2-设计原则&quot;&gt;&lt;a href=&quot;#2-2-设计原则&quot; class=&quot;headerlink&quot; title=&quot;2.2 设计原则&quot;&gt;&lt;/a&gt;2.2 设计原则&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;(一)&lt;/strong&gt; &lt;strong&gt;安全性：&lt;/strong&gt;安全性是企业园区网建设中的关键，它包括物理空间的安全控制及网络的安全控制。需要有完整的安全策略控制体系来实现企业园区网的安全控制。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(二)&lt;/strong&gt; &lt;strong&gt;可靠性、可用性：&lt;/strong&gt;高可靠性是园区网提供使用的关键，其可靠性设计包括：关键设备冗余、链路/网络冗余和重要业务模块冗余。&lt;/p&gt;
&lt;p&gt;关键设备均采用电信级全冗余设计，可实现单板热拔插、冗余的控制模块设计、冗余电源设计。采用冗余网络设计，每个层次均采用双机方式，层次与层次之间采用全冗余连接。提供多种冗余技术，采用高效、负载均衡的双机备份。&lt;/p&gt;
&lt;p&gt;可采用交换机的集群或者堆叠技术，在不降低网络可靠性的前提下，减化网络架构。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(三)&lt;/strong&gt; &lt;strong&gt;可扩展性：&lt;/strong&gt;园区网方案设计中，采用分层的网络设计；每个层次的设计所采用的设备本身都应具足够高的端口密度，为后续园区网扩展奠定基础。&lt;/p&gt;
&lt;p&gt;在园区出口层、核心层、汇聚层的设备都采用模块化设计，可根据园区网的发展进行灵活扩展。&lt;/p&gt;
&lt;p&gt;功能的可扩展性是园区网随着发展提供增值业务的基础。实现防火墙、负载均衡、WLAN接入、认证计费等功能，为园区网增值业务的扩展提供基础。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(四)&lt;/strong&gt; &lt;strong&gt;可维护、可管理性：&lt;/strong&gt;网络可管理性是园区网成功运维的基础。应提供低成本、简单有效的园区网统一网管系统，对园区网所有网络设备进行管理，包括网络拓扑显示、网络状态监控、故障事件实时预警和告警、网络流量统计。&lt;/p&gt;
    
    </summary>
    
    
      <category term="华为" scheme="https://zeozzz.github.com/categories/%E5%8D%8E%E4%B8%BA/"/>
    
    
      <category term="华为" scheme="https://zeozzz.github.com/tags/%E5%8D%8E%E4%B8%BA/"/>
    
  </entry>
  
  <entry>
    <title>中小型园区/分支出口综合配置举例</title>
    <link href="https://zeozzz.github.com/2019/07/15/66/"/>
    <id>https://zeozzz.github.com/2019/07/15/66/</id>
    <published>2019-07-15T06:59:36.000Z</published>
    <updated>2020-01-21T09:36:53.261Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>原文链接：<a href="http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&amp;partNo=10012#dc_cfg_campus_002">http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&amp;partNo=10012#dc_cfg_campus_002</a></p><h1 id="1-中小型园区-分支出口综合配置举例"><a href="#1-中小型园区-分支出口综合配置举例" class="headerlink" title="1  中小型园区/分支出口综合配置举例"></a><strong>1</strong>  中小型园区/分支出口综合配置举例</h1><h2 id="园区网出口简介"><a href="#园区网出口简介" class="headerlink" title="园区网出口简介"></a>园区网出口简介</h2><p>园区网出口一般位于企业网内部网络与外部网络的连接处，是内部网络与外部网络之间数据流的唯一出入口。对于中小型企业来说，考虑到企业网络建设的初期投资与长期运维成本，一般希望将多种业务部署在同一设备上。企业网络用户一般同时需要访问Internet和私网VPN，而对于中小型企业来说考虑到建设及维护成本问题，一般租用运营商Internet网络组建私网VPN。对于部分可靠性要求较高的园区网络，一般考虑部署两台出口路由器做冗余备份实现设备级可靠性，同时应用链路聚合、VRRP、主备路由等技术保证园区出口的可靠性。华为AR系列路由器配合华为S系列交换机是中小型园区网出口设备的理想解决方案。</p><ul><li>园区出口设备需要具备NAT Outbound及NAT Server的功能，实现私网地址和公网地址之间的转换，以满足用户访问Internet或者Internet用户访问内网服务器的需求。</li><li>园区出口设备需要具备通过Internet构建私网VPN的功能，以满足企业用户各个机构之间私网VPN互通的需求</li><li>园区出口设备需要具备数据加密传输的功能，以保证数据的完整性和机密性，保障用户业务传输的安全</li><li>中小型园区出口需要具备可靠性、安全性、低成本、易维护等特点。</li></ul><h2 id="配置注意事项"><a href="#配置注意事项" class="headerlink" title="配置注意事项"></a>配置注意事项</h2><ul><li>本配置案例适用于中小型企业园区/分支出口解决方案。</li><li>本配置案例仅涉及企业网络出口相关配置，涉及企业内网的相关配置请参见华为S系列园区交换机快速配置中的“中小园区组网场景”。</li></ul><h2 id="组网需求"><a href="#组网需求" class="headerlink" title="组网需求"></a>组网需求</h2><p>某企业总部和分支分别位于不同的城市，地域跨度较远，总部存在A、B两个不同的部门，分支只有一个部门。现在需要建设跨地域的企业园区网络，需要实现的需求如下：</p><ul><li>总部和分支都需要实现用户访问Internet的需求。总部划分为A、B两个部门，其中A部门的用户可以访问Internet，但是B部门的用户不能访问Internet；分支所有用户都可以访问Internet。</li><li>总部有Web服务器，对外提供WWW服务，外网用户可以访问内网服务器。</li><li>总部和分支之间需要通过Internet进行私网VPN互通，通信内容需要有安全保护。</li><li>总部园区出口可靠性要求较高，需要考虑链路级的可靠性和设备级的可靠性。</li><li>分支可以适当降低可靠性要求。</li></ul><a id="more"></a><h2 id="方案介绍"><a href="#方案介绍" class="headerlink" title="方案介绍"></a>方案介绍</h2><p>根据用户需求，可以给出如<a href="http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&partNo=10012#fig_dc_cfg_campus_002_01">图1-1</a>所示的综合配置解决方案，该方案具备层次化、模块化、冗余性、安全性的特点，适用于中小型企业/分支的园区网络部署。</p><p><strong>图1-1</strong>  中小型园区/分支出口综合配置组网图<br><img src="http://support.huawei.com/enterprise/product/images/4d904db9c09842ba9ca70b11b5eb11c9" alt="img" loading="lazy"></p><ul><li>在网络的接入层部署华为S2700&amp;S3700交换机（ACC1、ACC2、SwitchA），在网络的核心部署华为S5700交换机（CORE），在园区出口部署华为AR3200路由器（RouterA、RouterB、RouterC）。</li><li>总部采用双AR出口冗余备份方式，保证设备级的可靠性。分支部署一台AR路由器做出口。</li><li>总部核心交换机采用两台S5700交换机做堆叠，保证设备级的可靠性。</li><li>总部接入交换机与核心交换机之间以及核心交换机与出口路由器之间采用Eth-Trunk方式组网，保证链路级的可靠性。</li><li>总部每个部门业务划分到一个VLAN中，部门间的业务在核心交换机CORE上通过VLANIF三层互通。</li><li>总部核心交换机作为用户及服务器网关，部署DHCP Server为用户分配IP地址。</li><li>分支用户的网关直接部署在出口路由器上。</li><li>总部两个出口路由器之间部署VRRP，保证可靠性。</li><li>总部和分支之间通过Internet构建IPSec VPN进行私网互通，同时保证数据传输的安全性。</li><li>总部两台出口路由器和核心交换机之间部署OSPF，用于发布用户路由，便于后期扩容及维护。</li></ul><h2 id="配置思路"><a href="#配置思路" class="headerlink" title="配置思路"></a>配置思路</h2><p>采用如下思路部署中小型园区/分支出口综合配置举例：</p><ol><li><p>部署总部及分支园区内网</p><p>总部：部署堆叠、链路聚合，配置各VLAN及IP地址、部署DHCP Server，实现园区内网互通。部门内部通过接入层交换机进行二层互通，部门间通过核心交换机CORE上的VLANIF进行三层互通。</p><p>分支：配置接入层交换机及出口路由器的各接口VLAN及IP地址，部署DHCP Server，实现分支园区内网互通。</p></li><li><p>部署VRRP</p><p>为了保证总部核心交换机与两个出口路由器之间的可靠性，在两个出口路由器之间部署VRRP，VRRP的心跳报文经过核心交换机进行交互。RouterA为Master设备，RouterB为Backup设备。</p><p>为了防止总部RouterA上行链路故障的时候业务断流，将VRRP状态与RouterA的上行口进行联动，保证上行链路故障时VRRP进行快速倒换。</p></li><li><p>部署路由</p><p>为了引导各设备的上行流量，在总部核心交换机上配置一条缺省路由，下一跳指向VRRP的虚地址，在总部及分支的出口路由器上各配置一条缺省路由，下一跳指向运营商网络设备的对接地址（公网网关）。</p><p>为了引导总部两个出口路由器的回程流量，在两个出口路由器和核心交换机之间部署OSPF，核心交换机上将所有用户网段发布到OSPF里面，通告给两个出口路由器。</p><p>为了引导外网用户访问Web服务器的流量，需要在总部的运营商路由器上配置两条目的地址为服务器公网地址的静态路由，下一跳分别指向两个出口路由器的上行口IP地址。并且为了保证路由和VRRP同步切换，设置下一跳为RouterA的这条路由优先，当这条路由失效的时候下一跳指向RouterB的路由生效。</p></li><li><p>部署NAT Outbound</p><p>为了使内网用户访问Internet，在两台出口路由器的上行口配置NAT，实现私网地址和公网地址之间的转换。通过ACL匹配A部门的源IP地址，从而实现A部门的用户可以访问Internet，而B部门的用户不能访问Internet。</p></li><li><p>NAT Server</p><p>为了实现外网用户访问内网Web服务器，在两个出口路由器的上行口上配置NAT Server，实现服务器公网地址和私网地址之间的映射。</p></li><li><p>部署IPSec VPN</p><p>为了实现总部和分支之间进行私网VPN互通，在总部出口路由器和分支出口路由器之间部署IPSec VPN，通过Internet构建IPSec VPN，实现总部和分支之间的安全通信。</p></li></ol><p> 说明：</p><p>部署总部及分支园区内网所涉及的配置不在本例中给出，请参见华为S系列园区交换机快速配置中的“中小园区组网场景”。</p><h2 id="数据规划"><a href="#数据规划" class="headerlink" title="数据规划"></a>数据规划</h2><p>详细的数据规划如<a href="http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&partNo=10012#table_01">表1-1</a>、<a href="http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&partNo=10012#table_02">表1-2</a>、<a href="http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&partNo=10012#table_03">表1-3</a>所示。</p><p><strong>表1-1</strong>  链路聚合接口规划</p><table><thead><tr><th>设备</th><th>聚合接口</th><th>物理接口</th></tr></thead><tbody><tr><td>RouterA</td><td>Eth-trunk1</td><td>GE2/0/0GE2/0/1</td></tr><tr><td>RouterB</td><td>Eth-trunk1</td><td>GE2/0/0GE2/0/1</td></tr><tr><td>CORE</td><td>Eth-trunk1</td><td>GE0/0/1GE1/0/1</td></tr><tr><td>Eth-trunk2</td><td>GE0/0/2GE1/0/2</td><td></td></tr><tr><td>Eth-trunk3</td><td>GE0/0/3GE1/0/3</td><td></td></tr><tr><td>Eth-trunk4</td><td>GE0/0/4GE1/0/4</td><td></td></tr><tr><td>ACC1</td><td>Eth-trunk1</td><td>GE0/0/1GE0/0/2</td></tr><tr><td>ACC2</td><td>Eth-trunk1</td><td>GE0/0/1GE0/0/2</td></tr></tbody></table><p> 说明：</p><p>所有链路聚合采用LACP模式。</p><p><strong>表1-2</strong>  VLAN规划</p><table><thead><tr><th>设备</th><th>数据项</th><th>备注</th></tr></thead><tbody><tr><td>RouterA</td><td>Eth-trunk1.100：配置Dot1q终结子接口，终结VLAN100</td><td>用于和总部核心交换机CORE对接</td></tr><tr><td>RouterB</td><td>Eth-trunk1.100：配置Dot1q终结子接口，终结VLAN100</td><td>用于和总部核心交换机CORE对接</td></tr><tr><td>CORE</td><td>Eth-trunk1：Trunk类型，透传VLAN10</td><td>用于和总部部门A对接</td></tr><tr><td>Eth-trunk2：Trunk类型，透传VLAN20</td><td>用于和总部部门B对接</td><td></td></tr><tr><td>GE0/0/5：Access类型，缺省VLAN为VLAN30</td><td>用于连接总部Web服务器</td><td></td></tr><tr><td>Eth-trunk3：Trunk类型，透传VLAN100</td><td>用于和总部出口路由器RouterA对接</td><td></td></tr><tr><td>Eth-trunk4：Trunk类型，透传VLAN100</td><td>用于和总部出口路由器RouterB对接</td><td></td></tr><tr><td>ACC1</td><td>Eth-trunk1：Trunk类型，透传VLAN10</td><td>用于和总部CORE对接</td></tr><tr><td>Ethernet0/0/2：Access类型，缺省VLAN为VLAN10</td><td>用于连接总部A部门的PC1</td><td></td></tr><tr><td>ACC2</td><td>Eth-trunk1：Trunk类型，透传VLAN20</td><td>用于和总部CORE对接</td></tr><tr><td>Ethernet0/0/2：Access类型，缺省VLAN为VLAN20</td><td>用于连接总部B部门的PC3</td><td></td></tr><tr><td>RouterC</td><td>GE2/0/0.200：配置Dot1q终结子接口，终结VLAN200</td><td>用于连接分支接入交换机SwitchA</td></tr><tr><td>SwitchA</td><td>GE0/0/1：Trunk类型，透传VLAN200</td><td>用于连接分支出口路由器RouterC</td></tr><tr><td>Ethernet0/0/2：Access类型，缺省VLAN为VLAN200</td><td>用于连接分支PC5</td><td></td></tr></tbody></table><p><strong>表1-3</strong>  IP地址规划</p><table><thead><tr><th>设备</th><th>数据项</th><th>备注</th></tr></thead><tbody><tr><td>RouterA</td><td>GE1/0/0：202.10.1.2/24Eth-trunk1.100：10.10.100.2/24</td><td>GE1/0/0用于和运营商网络对接Eth-trunk1.100用于和总部核心交换机CORE对接</td></tr><tr><td>RouterB</td><td>GE1/0/0：202.10.2.2/24Eth-trunk1.100：10.10.100.3/24</td><td>-</td></tr><tr><td>CORE</td><td>VLANIF10：10.10.10.1/24VLANIF20：10.10.20.1/24VLANIF30：10.10.30.1/24VLANIF100：10.10.100.4/24</td><td>VLANIF10作为A部门的用户网关VLANIF20作为B部门的用户网关VLANIF30作为Web服务器的网关VLANIF100用于和出口路由器互联</td></tr><tr><td>Web服务器</td><td>IP地址：10.10.30.2/24默认网关：10.10.30.1</td><td>通过NAT Server 映射后的公网IP地址：202.10.100.3</td></tr><tr><td>PC1</td><td>IP地址：10.10.10.2/24默认网关：10.10.10.1</td><td>假设通过DHCP获取到的IP地址就是10.10.10.2/24</td></tr><tr><td>PC3</td><td>IP地址：10.10.20.2/24默认网关：10.10.20.1</td><td>假设通过DHCP获取到的IP地址就是10.10.20.2/24</td></tr><tr><td>RouterD</td><td>接口B，编号：GigabitEthernet1/0/0，IP地址：202.10.1.1/24接口C，编号：GigabitEthernet2/0/0，IP地址：202.10.2.1/24</td><td>该设备为运营商网络的设备，此处接口编号为假设，请以实际设备为准</td></tr><tr><td>RouterE</td><td>接口A，编号：GigabitEthernet1/0/0，IP地址：203.10.1.1/24</td><td>该设备为运营商网络的设备，此处接口编号为假设，请以实际设备为准</td></tr><tr><td>RouterC</td><td>GE1/0/0：203.10.1.2/24GE2/0/0.200：10.10.200.1/24</td><td>-</td></tr><tr><td>PC5</td><td>IP地址：10.10.200.2/24默认网关：10.10.200.1</td><td>假设通过DHCP获取到的IP地址就是10.10.200.2/24</td></tr></tbody></table><h4 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h4><ol><li>配置总部核心交换机CORE和两个出口路由器之间互联的Eth-Trunk</li></ol><p>   # 配置核心交换机CORE。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;HUAWEI&gt; system-view</span><br><span class="line">[HUAWEI] sysname CORE</span><br><span class="line">[CORE] interface eth-trunk 3</span><br><span class="line">[CORE-Eth-Trunk3] mode lacp</span><br><span class="line">[CORE-Eth-Trunk3] quit</span><br><span class="line">[CORE] interface eth-trunk 4</span><br><span class="line">[CORE-Eth-Trunk4] mode lacp</span><br><span class="line">[CORE-Eth-Trunk4] quit</span><br><span class="line">[CORE] interface gigabitethernet 0&#x2F;0&#x2F;3</span><br><span class="line">[CORE-GigabitEthernet0&#x2F;0&#x2F;3] eth-trunk 3</span><br><span class="line">[CORE-GigabitEthernet0&#x2F;0&#x2F;3] quit</span><br><span class="line">[CORE] interface gigabitethernet 1&#x2F;0&#x2F;3</span><br><span class="line">[CORE-GigabitEthernet1&#x2F;0&#x2F;3] eth-trunk 3</span><br><span class="line">[CORE-GigabitEthernet1&#x2F;0&#x2F;3] quit</span><br><span class="line">[CORE] interface gigabitethernet 0&#x2F;0&#x2F;4</span><br><span class="line">[CORE-GigabitEthernet0&#x2F;0&#x2F;4] eth-trunk 4</span><br><span class="line">[CORE-GigabitEthernet0&#x2F;0&#x2F;4] quit</span><br><span class="line">[CORE] interface gigabitethernet 1&#x2F;0&#x2F;4</span><br><span class="line">[CORE-GigabitEthernet1&#x2F;0&#x2F;4] eth-trunk 4</span><br><span class="line">[CORE-GigabitEthernet1&#x2F;0&#x2F;4] quit</span><br></pre></td></tr></table></figure><p>   # 配置总部出口路由器RouterA。RouterB的配置与RouterA类似。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname RouterA</span><br><span class="line">[RouterA] interface eth-trunk 1</span><br><span class="line">[RouterA-Eth-Trunk1] undo portswitch</span><br><span class="line">[RouterA-Eth-Trunk1] mode lacp-static</span><br><span class="line">[RouterA-Eth-Trunk1] quit</span><br><span class="line">[RouterA] interface gigabitethernet 2&#x2F;0&#x2F;0</span><br><span class="line">[RouterA-GigabitEthernet2&#x2F;0&#x2F;0] eth-trunk 1</span><br><span class="line">[RouterA-GigabitEthernet2&#x2F;0&#x2F;0] quit</span><br><span class="line">[RouterA] interface gigabitethernet 2&#x2F;0&#x2F;1</span><br><span class="line">[RouterA-GigabitEthernet2&#x2F;0&#x2F;1] eth-trunk 1</span><br><span class="line">[RouterA-GigabitEthernet2&#x2F;0&#x2F;1] quit</span><br></pre></td></tr></table></figure><ol start="2"><li>配置各接口的所属VLAN及IP地址</li></ol><p>   # 配置核心交换机CORE。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[CORE] vlan 100</span><br><span class="line">[CORE] quit</span><br><span class="line">[CORE] interface Eth-Trunk 3</span><br><span class="line">[CORE-Eth-Trunk3] port link-type trunk</span><br><span class="line">[CORE-Eth-Trunk3] port trunk allow-pass vlan 100</span><br><span class="line">[CORE-Eth-Trunk3] quit</span><br><span class="line">[CORE] interface Eth-Trunk 4</span><br><span class="line">[CORE-Eth-Trunk4] port link-type trunk</span><br><span class="line">[CORE-Eth-Trunk4] port trunk allow-pass vlan 100</span><br><span class="line">[CORE-Eth-Trunk4] quit</span><br><span class="line">[CORE] interface vlanif 100</span><br><span class="line">[CORE-Vlanif100] ip address 10.10.100.4 24</span><br><span class="line">[CORE-Vlanif100] quit</span><br></pre></td></tr></table></figure><p>   # 配置总部出口路由器RouterA。RouterB的配置与RouterA类似。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[RouterA] interface Eth-Trunk 1.100</span><br><span class="line">[RouterA-Eth-Trunk1.100] ip address 10.10.100.2 24</span><br><span class="line">[RouterA-Eth-Trunk1.100] dot1q termination vid 100</span><br><span class="line">[RouterA-Eth-Trunk1.100] arp broadcast enable     &#x2F;&#x2F;使能接口可以处理ARP广播报文功能；AR3200系列路由器V200R003C01及之后的版本默认已经使能了该功能，无需配置。</span><br><span class="line">[RouterA-Eth-Trunk1.100] quit</span><br><span class="line">[RouterA] interface gigabitethernet 1&#x2F;0&#x2F;0</span><br><span class="line">[RouterA-GigabitEthernet1&#x2F;0&#x2F;0] ip address 202.10.1.2 24</span><br><span class="line">[RouterA-GigabitEthernet1&#x2F;0&#x2F;0] quit</span><br></pre></td></tr></table></figure><p>   # 配置分支出口路由器RouterC。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Huawei&gt; system-view</span><br><span class="line">[Huawei] sysname RouterC</span><br><span class="line">[RouterC] interface gigabitethernet 1&#x2F;0&#x2F;0</span><br><span class="line">[RouterC-GigabitEthernet1&#x2F;0&#x2F;0] ip address 203.10.1.2 24</span><br><span class="line">[RouterC-GigabitEthernet1&#x2F;0&#x2F;0] quit</span><br></pre></td></tr></table></figure><ol start="3"><li>部署VRRP。在总部两个出口路由器RouterA和RouterB之间配置VRRP，RouterA为VRRP的Master，RouterB为VRRP的Backup</li></ol><p>   # 配置RouterA。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[RouterA] interface Eth-Trunk 1.100</span><br><span class="line">[RouterA-Eth-Trunk1.100] vrrp vrid 1 virtual-ip 10.10.100.1</span><br><span class="line">[RouterA-Eth-Trunk1.100] vrrp vrid 1 priority 120</span><br><span class="line">[RouterA-Eth-Trunk1.100] vrrp vrid 1 track interface GigabitEthernet1&#x2F;0&#x2F;0 reduced 40</span><br><span class="line">[RouterA-Eth-Trunk1.100] quit</span><br><span class="line"> &#x2F;&#x2F;为了防止RouterA的上行链路中断的时候数据流发送至VRRP的Master以后不能继续上行，配置VRRP的状态和RouterA的上行口进行联动，保证RouterA上行链路中断的时候VRRP状态迅速倒换。</span><br></pre></td></tr></table></figure><p>   # 配置RouterB。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[RouterB] interface Eth-Trunk 1.100</span><br><span class="line">[RouterB-Eth-Trunk1.100] vrrp vrid 1 virtual-ip 10.10.100.1</span><br><span class="line">[RouterB-Eth-Trunk1.100] quit</span><br></pre></td></tr></table></figure><p>   配置完成后，RouterA和RouterB之间应该能建立VRRP的主备份关系，执行<strong>display vrrp</strong>命令可以看到RouterA和RouterB的VRRP状态。</p><p>   # 查看RouterA的VRRP状态为Master。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[RouterA] display vrrp</span><br><span class="line">  Eth-Trunk1.100 | Virtual Router 1</span><br><span class="line">    State : Master</span><br><span class="line">    Virtual IP : 10.10.100.1</span><br><span class="line">    Master IP : 10.10.100.2</span><br><span class="line">    PriorityRun : 120</span><br><span class="line">    PriorityConfig : 120</span><br><span class="line">    MasterPriority : 120</span><br><span class="line">    Preempt : YES   Delay Time : 0 s</span><br><span class="line">    TimerRun : 1 s</span><br><span class="line">    TimerConfig : 1 s</span><br><span class="line">    Auth type : NONE</span><br><span class="line">    Virtual MAC : 0000-5e00-0101</span><br><span class="line">    Check TTL : YES</span><br><span class="line">    Config type : normal-vrrp</span><br><span class="line">    Backup-forward : disabled</span><br><span class="line">    Track IF : GigabitEthernet1&#x2F;0&#x2F;0   Priority reduced : 40</span><br><span class="line">    IF state : UP</span><br><span class="line">    Create time : 2015-05-18 06:53:47 UTC-05:13</span><br><span class="line">    Last change time : 2015-05-18 06:54:14 UTC-05:13</span><br></pre></td></tr></table></figure><p>   # 查看RouterB的VRRP状态为Backup。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[RouterB] display vrrp</span><br><span class="line">  Eth-Trunk1.100 | Virtual Router 1</span><br><span class="line">    State : Backup</span><br><span class="line">    Virtual IP : 10.10.100.1</span><br><span class="line">    Master IP : 10.10.100.2</span><br><span class="line">    PriorityRun : 100</span><br><span class="line">    PriorityConfig : 100</span><br><span class="line">    MasterPriority : 120</span><br><span class="line">    Preempt : YES   Delay Time : 0 s</span><br><span class="line">    TimerRun : 1 s</span><br><span class="line">    TimerConfig : 1 s</span><br><span class="line">    Auth type : NONE</span><br><span class="line">    Virtual MAC : 0000-5e00-0101</span><br><span class="line">    Check TTL : YES</span><br><span class="line">    Config type : normal-vrrp</span><br><span class="line">    Backup-forward : disabled</span><br><span class="line">    Create time : 2015-05-18 06:53:52 UTC-05:13</span><br><span class="line">    Last change time : 2015-05-18 06:57:12 UTC-05:13</span><br></pre></td></tr></table></figure><ol start="4"><li><p>部署路由</p><ol><li>部署缺省路由，用于引导各个设备的上行流量</li></ol></li></ol><pre><code>  \# 在核心交换机CORE上配置一条缺省路由，下一跳指向VRRP的虚地址。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[CORE] ip route-static 0.0.0.0 0.0.0.0 10.10.100.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 在总部及分支出口路由器上各配置一条缺省路由，下一跳指向运行商网络设备的对接地址（公网网关）。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] ip route-static 0.0.0.0 0.0.0.0 202.10.1.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterB] ip route-static 0.0.0.0 0.0.0.0 202.10.2.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] ip route-static 0.0.0.0 0.0.0.0 203.10.1.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="2"><li>部署OSPF。在总部两个出口路由器RouterA、RouterB以及总部核心交换机CORE之间部署OSPF，用于两个出口路由器RouterA和RouterB学习用户网段的回程路由</li></ol><pre><code>  \# 配置总部出口路由器RouterA。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] ospf 1 router-id 10.1.1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ospf-1] area 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ospf-1-area-0.0.0.0] network 10.10.100.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ospf-1-area-0.0.0.0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置总部出口路由器RouterB。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterB] ospf 1 router-id 10.2.2.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ospf-1] area 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ospf-1-area-0.0.0.0] network 10.10.100.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ospf-1-area-0.0.0.0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置总部核心交换机CORE。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[CORE] ospf 1 router-id 10.3.3.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[CORE-ospf-1] area 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[CORE-ospf-1-area-0.0.0.0] network 10.10.100.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[CORE-ospf-1-area-0.0.0.0] network 10.10.10.0 0.0.0.255      &amp;#x2F;&amp;#x2F;将用户网段发布到OSPF里面&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[CORE-ospf-1-area-0.0.0.0] network 10.10.20.0 0.0.0.255      &amp;#x2F;&amp;#x2F;将用户网段发布到OSPF里面&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[CORE-ospf-1-area-0.0.0.0] network 10.10.30.0 0.0.0.255     &amp;#x2F;&amp;#x2F;将Web服务器网段发布到OSPF里面&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[CORE-ospf-1-area-0.0.0.0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置完成后，RouterA、RouterB和Core之间应该建立OSPF邻居关系，执行**display ospf peer**命令可以查看OSPF邻居状态为Full，以CORE为例，OSPF邻居状态如下。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[CORE] display ospf peer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   OSPF Process 1 with Router ID 10.3.3.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     Neighbors &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Area 0.0.0.0 interface 10.10.100.4(Vlanif100)&amp;#39;s neighbors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Router ID: 10.1.1.1         Address: 10.10.100.2     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   State: Full  Mode:Nbr is  Slave  Priority: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   DR: 10.10.100.4  BDR: 10.10.100.3  MTU: 0    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Dead timer due in 40  sec &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Retrans timer interval: 5 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Neighbor is up for 00:26:37     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Authentication Sequence: [ 0 ] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Router ID: 10.2.2.2         Address: 10.10.100.3     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   State: Full  Mode:Nbr is  Slave  Priority: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   DR: 10.10.100.4  BDR: 10.10.100.3  MTU: 0    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Dead timer due in 36  sec &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Retrans timer interval: 5 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Neighbor is up for 00:26:37     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Authentication Sequence: [ 0 ] &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="3"><li>配置外网到内网服务器公网地址的静态路由（回程路由）</li></ol><pre><code>  \# 在和总部出口对接的运营商路由器RouterD上配置两条目的地址为服务器公网地址的静态路由，下一跳分别指向两个出口路由器RouterA、RouterB的上行口IP地址。为了保证路由和VRRP同步切换，设置下一跳为RouterA的这条路由优先，当这条路由失效的时候下一跳指向RouterB的路由生效。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterD] ip route-static 202.10.100.0 255.255.255.0 202.10.1.2 preference 40     &amp;#x2F;&amp;#x2F;下一跳为RouterA的这条路由优先&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterD] ip route-static 202.10.100.0 255.255.255.0 202.10.2.2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  当总部出口路由器RouterA的上行链路中断的时候会触发两个动作：  1. 两台总部出口路由器VRRP主备切换，这个通过VRRP状态联动总部出口路由器上行口状态来实现。  2. 和总部出口对接的运营商路由器RouterD到达内网服务器的路由进行主备切换，这个通过RouterD配置主备路由实现。  这两个动作保证了当出口路由器RouterA的上行链路中断的时候内网VRRP状态和公网回程主备路由同时切换，保证了来回路径双向可靠性。</code></pre><ol start="5"><li><p>部署NAT Outbound</p><ol><li>在总部及分支出口路由器上定义需要进行NAT转换的数据流</li></ol></li></ol><pre><code>  总部仅部门A允许访问Internet，源IP地址是10.10.10.0/24；分支所有用户都允许访问Internet，源IP地址是10.10.200.0/24。  \# 配置总部出口路由器RouterA。RouterB的配置和RouterA类似。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] acl 3000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3000] rule 5 deny ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255       &amp;#x2F;&amp;#x2F;需要IPSec保护的数据流&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3000] rule 10 deny ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255      &amp;#x2F;&amp;#x2F;需要IPSec保护的数据流&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3000] rule 15 permit ip source 10.10.10.0 0.0.0.255       &amp;#x2F;&amp;#x2F;需要进行NAT转换的数据流&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3000] quit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#x2F;&amp;#x2F;对于华为AR3200系列路由器，如果接口上同时配置了IPSec和NAT，则先执行NAT。所以为了避免把IPSec保护的数据流进行NAT转换，需要NAT引用的ACL规则deny掉需要IPSec保护的数据流，即对“IPSec感兴趣的数据流”做NAT豁免。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置分支出口路由器RouterC。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] acl 3000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3000] rule 5 deny ip source 10.10.200.0 0.0.0.255 destination 10.10.10.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3000] rule 10 deny ip source 10.10.200.0 0.0.0.255 destination 10.10.20.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3000] rule 15 permit ip source 10.10.200.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3000] quit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#x2F;&amp;#x2F;同样需要配置对“IPSec感兴趣的数据流”做NAT豁免&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="2"><li>在总部及分支出口路由器的上行口上配置NAT转换</li></ol><pre><code>  \# 配置RouterA。RouterB及RouterC的配置与RouterA类似。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] interface GigabitEthernet1&amp;#x2F;0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] nat outbound 3000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="3"><li>检查配置结果</li></ol><pre><code>  \# 配置完成后可以通过**display nat outbound**命令查看NAT转换的配置信息，以RouterA为例详细信息如下。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] display nat outbound&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; NAT Outbound Information:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; --------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Interface                     Acl     Address-group&amp;#x2F;IP&amp;#x2F;Interface      Type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; --------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; GigabitEthernet1&amp;#x2F;0&amp;#x2F;0         3000                     202.10.1.2    easyip  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; --------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Total : 1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="6"><li>部署NAT Server</li></ol><p>   总部有Web服务器，需在两个出口路由器RouterA和RouterB上都配置NAT Server，实现外网用户访问内网Web服务器。</p><p>   # 配置RouterA。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[RouterA] interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line">[RouterA-GigabitEthernet1&#x2F;0&#x2F;0] nat server protocol tcp global 202.10.100.3 www inside 10.10.30.2 8080</span><br><span class="line">[RouterA-GigabitEthernet1&#x2F;0&#x2F;0] quit</span><br></pre></td></tr></table></figure><p>   # 配置RouterB。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[RouterB] interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line">[RouterB-GigabitEthernet1&#x2F;0&#x2F;0] nat server protocol tcp global 202.10.100.3 www inside 10.10.30.2 8080</span><br><span class="line">[RouterB-GigabitEthernet1&#x2F;0&#x2F;0] quit</span><br></pre></td></tr></table></figure><p>   # 配置完成后可以通过<strong>display nat server</strong>命令查看NAT Server的配置信息，以RouterA为例详细信息如下。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[RouterA] display nat server</span><br><span class="line"></span><br><span class="line">  Nat Server Information:</span><br><span class="line">  Interface  : GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line">    Global IP&#x2F;Port     : 202.10.100.3&#x2F;80(www) </span><br><span class="line">    Inside IP&#x2F;Port     : 10.10.30.2&#x2F;8080</span><br><span class="line">    Protocol : 6(tcp)   </span><br><span class="line">    VPN instance-name  : ----                            </span><br><span class="line">    Acl number         : ----</span><br><span class="line">    Description : ----</span><br><span class="line"></span><br><span class="line">  Total :    1</span><br></pre></td></tr></table></figure><ol start="7"><li><p>部署IPSec VPN，实现总部和分支之间通过Internet实现私网互通，并且数据通信具有安全保护</p><ol><li>配置ACL，定义需要IPSec保护的数据流</li></ol></li></ol><pre><code>  \# 配置总部出口路由器RouterA。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3001] rule 5 permit ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255       &amp;#x2F;&amp;#x2F;需要IPSec保护的数据流&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3001] rule 10 permit ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255       &amp;#x2F;&amp;#x2F;需要IPSec保护的数据流&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-acl-adv-3001] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置总部出口路由器RouterB。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterB] acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-acl-adv-3001] rule 5 permit ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-acl-adv-3001] rule 10 permit ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-acl-adv-3001] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置分支出口路由器RouterC。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3001] rule 5 permit ip source 10.10.200.0 0.0.0.255 destination 10.10.10.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3001] rule 10 permit ip source 10.10.200.0 0.0.0.255 destination 10.10.20.0 0.0.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-acl-adv-3001] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="2"><li>配置IPSec安全提议</li></ol><pre><code>  \# 配置总部出口路由器RouterA。总部出口路由器RouterB以及分支出口路由器RouterC的配置和RouterA类似。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] ipsec proposal tran1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-proposal-tran1] esp authentication-algorithm sha2-256      &amp;#x2F;&amp;#x2F;设置ESP协议采用的认证算法&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-proposal-tran1] esp encryption-algorithm aes-128      &amp;#x2F;&amp;#x2F;设置ESP协议采用的加密算法&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-proposal-tran1] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="3"><li>配置IKE安全提议</li></ol><pre><code>  \# 配置总部出口路由器RouterA。总部出口路由器RouterB以及分支出口路由器RouterC的配置和RouterA类似。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] ike proposal 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-proposal-5] encryption-algorithm aes-cbc-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-proposal-5] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="4"><li>配置IKE对等体</li></ol><pre><code>  \# 配置总部出口路由器RouterA。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] ike peer vpn v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-peer-vpn] pre-shared-key cipher huawei123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-peer-vpn] ike-proposal 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-peer-vpn] dpd type periodic     &amp;#x2F;&amp;#x2F;配置周期性对等体存活检测&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-peer-vpn] dpd idle-time 10     &amp;#x2F;&amp;#x2F;设置对等体存活检测空闲时间为10秒&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-peer-vpn] remote-address 203.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ike-peer-vpn] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置总部出口路由器RouterB。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterB] ike peer vpn v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ike-peer-vpn] pre-shared-key cipher huawei123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ike-peer-vpn] ike-proposal 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ike-peer-vpn] dpd type periodic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ike-peer-vpn] dpd idle-time 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ike-peer-vpn] remote-address 203.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ike-peer-vpn] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置分支出口路由器RouterC。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] ike peer vpnr1 v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr1] pre-shared-key cipher huawei123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr1] ike-proposal 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr1] dpd type periodic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr1] dpd idle-time 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr1] remote-address 202.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr1] quit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] ike peer vpnr2 v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr2] pre-shared-key cipher huawei123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr2] ike-proposal 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr2] dpd type periodic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr2] dpd idle-time 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr2] remote-address 202.10.2.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ike-peer-vpnr2] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="5"><li>配置安全策略</li></ol><pre><code>  \# 配置总部出口路由器RouterA。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] ipsec policy ipsec_vpn 10 isakmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-policy-isakmp-ipsec_vpn-10] security acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-policy-isakmp-ipsec_vpn-10] ike-peer vpn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-policy-isakmp-ipsec_vpn-10] proposal tran1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-ipsec-policy-isakmp-ipsec_vpn-10] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置总部出口路由器RouterB。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterB] ipsec policy ipsec_vpn 10 isakmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ipsec-policy-isakmp-ipsec_vpn-10] security acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ipsec-policy-isakmp-ipsec_vpn-10] ike-peer vpn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ipsec-policy-isakmp-ipsec_vpn-10] proposal tran1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-ipsec-policy-isakmp-ipsec_vpn-10] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置分支出口路由器RouterC。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] ipsec policy ipsec_vpn 10 isakmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-10] security acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-10] ike-peer vpnr1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-10] proposal tran1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-10] quit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] ipsec policy ipsec_vpn 20 isakmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-20] security acl 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-20] ike-peer vpnr2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-20] proposal tran1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-ipsec-policy-isakmp-ipsec_vpn-20] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="6"><li>接口上引用安全策略组</li></ol><pre><code>  \# 在总部出口路由器RouterA的接口上引用安全策略组。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterA] interface GigabitEthernet1&amp;#x2F;0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] ipsec policy ipsec_vpn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterA-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 在总部出口路由器RouterB的接口上引用安全策略组。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterB] interface GigabitEthernet1&amp;#x2F;0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] ipsec policy ipsec_vpn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterB-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 在分支出口路由器RouterC的接口上引用安全策略组。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] interface GigabitEthernet1&amp;#x2F;0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] ipsec policy ipsec_vpn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[RouterC-GigabitEthernet1&amp;#x2F;0&amp;#x2F;0] quit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="7"><li>检查配置结果</li></ol><pre><code>  \# 配置完成后，可以执行**display ike sa**命令查看由IKE建立的安全联盟信息，以RouterC为例，由IKE建立的安全联盟信息如下。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] display ike sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Conn-ID  Peer            VPN   Flag(s)                Phase  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ---------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        7    202.10.2.2      0     RD|ST                  2     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        4    202.10.2.2      0     RD                     2     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        2    202.10.2.2      0     RD                     1     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        6    202.10.1.2      0     RD|ST                  2     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        5    202.10.1.2      0     RD                     2     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        3    202.10.1.2      0     RD                     1     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Flag Description:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  RD--READY   ST--STAYALIVE   RL--REPLACED   FD--FADING   TO--TIMEOUT&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  HRT--HEARTBEAT   LKG--LAST KNOWN GOOD SEQ NO.   BCK--BACKED UP&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;  \# 配置完成后，可以执行**display ipsec sa**命令查看安全联盟的相关信息，以RouterC为例，安全联盟信息如下。  &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[RouterC] display ipsec sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Interface: GigabitEthernet1&amp;#x2F;0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Path MTU: 1500&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  IPSec policy name: &amp;quot;ipsec_vpn&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Sequence number  : 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl Group        : 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl rule         : 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Mode             : ISAKMP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Connection ID     : 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Encapsulation mode: Tunnel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel local      : 203.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel remote     : 202.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow source       : 10.10.200.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow destination  : 10.10.10.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Qos pre-classify  : Disable&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Outbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 969156085 (0x39c425f5)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887313920&amp;#x2F;1521&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max sent sequence-number: 8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Inbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 1258341975 (0x4b00c657)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887436080&amp;#x2F;1521&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max received sequence-number: 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Anti-replay window size: 32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  IPSec policy name: &amp;quot;ipsec_vpn&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Sequence number  : 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl Group        : 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl rule         : 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Mode             : ISAKMP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Connection ID     : 6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Encapsulation mode: Tunnel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel local      : 203.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel remote     : 202.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow source       : 10.10.200.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow destination  : 10.10.20.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Qos pre-classify  : Disable&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Outbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 4217384908 (0xfb602fcc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887283200&amp;#x2F;1522&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max sent sequence-number: 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Inbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 654720480 (0x27063de0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887436080&amp;#x2F;1522&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max received sequence-number: 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Anti-replay window size: 32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  IPSec policy name: &amp;quot;ipsec_vpn&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Sequence number  : 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl Group        : 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl rule         : 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Mode             : ISAKMP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Connection ID     : 4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Encapsulation mode: Tunnel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel local      : 203.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel remote     : 202.10.2.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow source       : 10.10.200.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow destination  : 10.10.10.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Qos pre-classify  : Disable&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Outbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 240759500 (0xe59b2cc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887436800&amp;#x2F;1521&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max sent sequence-number: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Inbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 3888073495 (0xe7bf4b17)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887436800&amp;#x2F;1521&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max received sequence-number: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Anti-replay window size: 32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  IPSec policy name: &amp;quot;ipsec_vpn&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Sequence number  : 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl Group        : 3001&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Acl rule         : 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Mode             : ISAKMP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  -----------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Connection ID     : 7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Encapsulation mode: Tunnel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel local      : 203.10.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Tunnel remote     : 202.10.2.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow source       : 10.10.200.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Flow destination  : 10.10.20.0&amp;#x2F;255.255.255.0 0&amp;#x2F;0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Qos pre-classify  : Disable&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Outbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 2751917383 (0xa406ed47)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887436800&amp;#x2F;1522&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max sent sequence-number: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [Inbound ESP SAs] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SPI: 739146604 (0x2c0e7b6c)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Proposal: ESP-ENCRYPT-AES-128 SHA2-256-128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      SA remaining key duration (bytes&amp;#x2F;sec): 1887436800&amp;#x2F;1522&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Max received sequence-number: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Anti-replay window size: 32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      UDP encapsulation used for NAT traversal: N&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><ol start="8"><li>检查配置结果</li></ol><p>   # 通过<strong>ping</strong>命令验证总部和分支之间的连通性。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PC1&gt;ping 10.10.200.2</span><br><span class="line"></span><br><span class="line">Ping 10.10.200.2: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;1 ttl&#x3D;126 time&#x3D;140 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;2 ttl&#x3D;126 time&#x3D;235 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;3 ttl&#x3D;126 time&#x3D;266 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;4 ttl&#x3D;126 time&#x3D;140 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;5 ttl&#x3D;126 time&#x3D;141 ms</span><br><span class="line"></span><br><span class="line">--- 10.10.200.2 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  5 packet(s) received</span><br><span class="line">  0.00% packet loss</span><br><span class="line">  round-trip min&#x2F;avg&#x2F;max &#x3D; 140&#x2F;184&#x2F;266 ms</span><br></pre></td></tr></table></figure>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PC3&gt;ping 10.10.200.2</span><br><span class="line"></span><br><span class="line">Ping 10.10.200.2: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;1 ttl&#x3D;126 time&#x3D;156 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;2 ttl&#x3D;126 time&#x3D;297 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;3 ttl&#x3D;126 time&#x3D;156 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;4 ttl&#x3D;126 time&#x3D;141 ms</span><br><span class="line">From 10.10.200.2: bytes&#x3D;32 seq&#x3D;5 ttl&#x3D;126 time&#x3D;109 ms</span><br><span class="line"></span><br><span class="line">--- 10.10.200.2 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  5 packet(s) received</span><br><span class="line">  0.00% packet loss</span><br><span class="line">  round-trip min&#x2F;avg&#x2F;max &#x3D; 109&#x2F;171&#x2F;297 ms</span><br></pre></td></tr></table></figure><p>   可以看到，PC1和PC5、PC3和PC5之间都是可以互通的，公司总部和分支之间可以通过运营商网络组建的私网VPN进行互通。</p><p>   # 验证企业总部各部门与公网之间的连通性，以企业总部的公网网关202.10.1.1作为测试地址。</p>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PC1&gt;ping 202.10.1.1</span><br><span class="line"></span><br><span class="line">Ping 202.10.1.1: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">From 202.10.1.1: bytes&#x3D;32 seq&#x3D;1 ttl&#x3D;253 time&#x3D;235 ms</span><br><span class="line">From 202.10.1.1: bytes&#x3D;32 seq&#x3D;2 ttl&#x3D;253 time&#x3D;109 ms</span><br><span class="line">From 202.10.1.1: bytes&#x3D;32 seq&#x3D;3 ttl&#x3D;253 time&#x3D;79 ms</span><br><span class="line">From 202.10.1.1: bytes&#x3D;32 seq&#x3D;4 ttl&#x3D;253 time&#x3D;63 ms</span><br><span class="line">From 202.10.1.1: bytes&#x3D;32 seq&#x3D;5 ttl&#x3D;253 time&#x3D;63 ms</span><br><span class="line"></span><br><span class="line">--- 202.10.1.1 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  5 packet(s) received</span><br><span class="line">  0.00% packet loss</span><br><span class="line">  round-trip min&#x2F;avg&#x2F;max &#x3D; 63&#x2F;109&#x2F;235 ms</span><br></pre></td></tr></table></figure>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PC3&gt;ping 202.10.1.1</span><br><span class="line"></span><br><span class="line">Ping 202.10.1.1: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line"></span><br><span class="line">--- 202.10.1.1 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  0 packet(s) received</span><br><span class="line">  100.00% packet loss</span><br></pre></td></tr></table></figure><p>   可以看到，部门A（PC1）的用户可以访问公网，部门B（PC3）的用户不能访问公网。</p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul><li><p>总部核心交换机CORE的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">sysname CORE</span><br><span class="line">#</span><br><span class="line">vlan batch 100</span><br><span class="line">#</span><br><span class="line">interface Vlanif100</span><br><span class="line"> ip address 10.10.100.4 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Eth-Trunk3</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 100</span><br><span class="line"> mode lacp</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">interface Eth-Trunk4</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 100</span><br><span class="line"> mode lacp</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0&#x2F;0&#x2F;3</span><br><span class="line"> eth-trunk 3</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0&#x2F;0&#x2F;4</span><br><span class="line"> eth-trunk 4</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;3</span><br><span class="line"> eth-trunk 3</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;4</span><br><span class="line"> eth-trunk 4</span><br><span class="line">#</span><br><span class="line">ospf 1 router-id 10.3.3.3</span><br><span class="line"> area 0.0.0.0</span><br><span class="line">  network 10.10.100.0 0.0.0.255</span><br><span class="line">  network 10.10.10.0 0.0.0.255</span><br><span class="line">  network 10.10.20.0 0.0.0.255</span><br><span class="line">  network 10.10.30.0 0.0.0.255</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 10.10.100.1</span><br><span class="line">#</span><br><span class="line">return</span><br></pre></td></tr></table></figure></li><li><p>总部出口路由器RouterA的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"> sysname RouterA</span><br><span class="line">#</span><br><span class="line">acl number 3000  </span><br><span class="line"> rule 5 deny ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line"> rule 10 deny ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line"> rule 15 permit ip source 10.10.10.0 0.0.0.255 </span><br><span class="line">acl number 3001  </span><br><span class="line"> rule 5 permit ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line"> rule 10 permit ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">ipsec proposal tran1</span><br><span class="line"> esp authentication-algorithm sha2-256 </span><br><span class="line"> esp encryption-algorithm aes-128</span><br><span class="line">#</span><br><span class="line">ike proposal 5</span><br><span class="line"> encryption-algorithm aes-cbc-128</span><br><span class="line">#</span><br><span class="line">ike peer vpn v1</span><br><span class="line"> pre-shared-key cipher &quot;@J*U2S*(7F,YWX*NZ55OA!!</span><br><span class="line"> ike-proposal 5</span><br><span class="line"> dpd type periodic</span><br><span class="line"> dpd idle-time 10</span><br><span class="line"> remote-address 203.10.1.2</span><br><span class="line">#</span><br><span class="line">ipsec policy ipsec_vpn 10 isakmp</span><br><span class="line"> security acl 3001</span><br><span class="line"> ike-peer vpn</span><br><span class="line"> proposal tran1</span><br><span class="line">#</span><br><span class="line">interface Eth-Trunk1</span><br><span class="line"> undo portswitch</span><br><span class="line"> mode lacp-static</span><br><span class="line">#</span><br><span class="line">interface Eth-Trunk1.100</span><br><span class="line"> dot1q termination vid 100</span><br><span class="line"> ip address 10.10.100.2 255.255.255.0 </span><br><span class="line"> vrrp vrid 1 virtual-ip 10.10.100.1</span><br><span class="line"> vrrp vrid 1 priority 120</span><br><span class="line"> vrrp vrid 1 track interface GigabitEthernet1&#x2F;0&#x2F;0 reduced 40</span><br><span class="line"> arp broadcast enable</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line"> ip address 202.10.1.2 255.255.255.0 </span><br><span class="line"> ipsec policy ipsec_vpn</span><br><span class="line"> nat server protocol tcp global 202.10.100.3 www inside 10.10.30.2 8080</span><br><span class="line"> nat outbound 3000</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet2&#x2F;0&#x2F;0</span><br><span class="line"> eth-trunk 1</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet2&#x2F;0&#x2F;1</span><br><span class="line"> eth-trunk 1</span><br><span class="line">#</span><br><span class="line">ospf 1 router-id 10.1.1.1 </span><br><span class="line"> area 0.0.0.0 </span><br><span class="line">  network 10.10.100.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 202.10.1.1</span><br><span class="line">#</span><br><span class="line">return</span><br></pre></td></tr></table></figure></li><li><p>总部出口路由器RouterB的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"> sysname RouterB</span><br><span class="line">#</span><br><span class="line">acl number 3000  </span><br><span class="line"> rule 5 deny ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line"> rule 10 deny ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line"> rule 15 permit ip source 10.10.10.0 0.0.0.255 </span><br><span class="line">acl number 3001  </span><br><span class="line"> rule 5 permit ip source 10.10.10.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line"> rule 10 permit ip source 10.10.20.0 0.0.0.255 destination 10.10.200.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">ipsec proposal tran1</span><br><span class="line"> esp authentication-algorithm sha2-256 </span><br><span class="line"> esp encryption-algorithm aes-128</span><br><span class="line">#</span><br><span class="line">ike proposal 5</span><br><span class="line"> encryption-algorithm aes-cbc-128</span><br><span class="line">#</span><br><span class="line">ike peer vpn v1</span><br><span class="line"> pre-shared-key cipher &quot;@J*U2S*(7F,YWX*NZ55OA!!</span><br><span class="line"> ike-proposal 5</span><br><span class="line"> dpd type periodic</span><br><span class="line"> dpd idle-time 10</span><br><span class="line"> remote-address 203.10.1.2</span><br><span class="line">#</span><br><span class="line">ipsec policy ipsec_vpn 10 isakmp</span><br><span class="line"> security acl 3001</span><br><span class="line"> ike-peer vpn</span><br><span class="line"> proposal tran1</span><br><span class="line">#</span><br><span class="line">interface Eth-Trunk1</span><br><span class="line"> undo portswitch</span><br><span class="line"> mode lacp-static</span><br><span class="line">#</span><br><span class="line">interface Eth-Trunk1.100</span><br><span class="line"> dot1q termination vid 100</span><br><span class="line"> ip address 10.10.100.3 255.255.255.0 </span><br><span class="line"> vrrp vrid 1 virtual-ip 10.10.100.1</span><br><span class="line"> arp broadcast enable</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line"> ip address 202.10.2.2 255.255.255.0 </span><br><span class="line"> ipsec policy ipsec_vpn</span><br><span class="line"> nat server protocol tcp global 202.10.100.3 www inside 10.10.30.2 8080</span><br><span class="line"> nat outbound 3000</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet2&#x2F;0&#x2F;0</span><br><span class="line"> eth-trunk 1</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet2&#x2F;0&#x2F;1</span><br><span class="line"> eth-trunk 1</span><br><span class="line">#</span><br><span class="line">ospf 1 router-id 10.2.2.2 </span><br><span class="line"> area 0.0.0.0 </span><br><span class="line">  network 10.10.100.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 202.10.2.1</span><br><span class="line">#</span><br><span class="line">return</span><br></pre></td></tr></table></figure></li><li><p>分支出口路由器RouterC的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"> sysname RouterC</span><br><span class="line">#</span><br><span class="line">acl number 3000  </span><br><span class="line"> rule 5 deny ip source 10.10.200.0 0.0.0.255 destination 10.10.10.0 0.0.0.255 </span><br><span class="line"> rule 10 deny ip source 10.10.200.0 0.0.0.255 destination 10.10.20.0 0.0.0.255 </span><br><span class="line"> rule 15 permit ip source 10.10.200.0 0.0.0.255 </span><br><span class="line">acl number 3001  </span><br><span class="line"> rule 5 permit ip source 10.10.200.0 0.0.0.255 destination 10.10.10.0 0.0.0.255 </span><br><span class="line"> rule 10 permit ip source 10.10.200.0 0.0.0.255 destination 10.10.20.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">ipsec proposal tran1</span><br><span class="line"> esp authentication-algorithm sha2-256 </span><br><span class="line"> esp encryption-algorithm aes-128</span><br><span class="line">#</span><br><span class="line">ike proposal 5</span><br><span class="line"> encryption-algorithm aes-cbc-128</span><br><span class="line">#</span><br><span class="line">ike peer vpnr1 v1</span><br><span class="line"> pre-shared-key cipher &quot;@J*U2S*(7F,YWX*NZ55OA!!</span><br><span class="line"> ike-proposal 5</span><br><span class="line"> dpd type periodic</span><br><span class="line"> dpd idle-time 10</span><br><span class="line"> remote-address 202.10.1.2</span><br><span class="line">#</span><br><span class="line">ike peer vpnr2 v1</span><br><span class="line"> pre-shared-key cipher &quot;@J*U2S*(7F,YWX*NZ55OA!!</span><br><span class="line"> ike-proposal 5</span><br><span class="line"> dpd type periodic</span><br><span class="line"> dpd idle-time 10</span><br><span class="line"> remote-address 202.10.2.2</span><br><span class="line">#</span><br><span class="line">ipsec policy ipsec_vpn 10 isakmp</span><br><span class="line"> security acl 3001</span><br><span class="line"> ike-peer vpnr1</span><br><span class="line"> proposal tran1</span><br><span class="line">#</span><br><span class="line">ipsec policy ipsec_vpn 20 isakmp</span><br><span class="line"> security acl 3001</span><br><span class="line"> ike-peer vpnr2</span><br><span class="line"> proposal tran1</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line"> ip address 203.10.1.2 255.255.255.0 </span><br><span class="line"> ipsec policy ipsec_vpn</span><br><span class="line"> nat outbound 3000</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 203.10.1.1</span><br><span class="line">#</span><br><span class="line">return</span><br></pre></td></tr></table></figure></li><li><p>总部运营商路由器RouterD的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"> sysname RouterD</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line"> ip address 202.10.1.1 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet2&#x2F;0&#x2F;0</span><br><span class="line"> ip address 202.10.2.1 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">ip route-static 202.10.100.0 255.255.255.0 202.10.1.2 preference 40</span><br><span class="line">ip route-static 202.10.100.0 255.255.255.0 202.10.2.2</span><br><span class="line">#</span><br><span class="line">return</span><br></pre></td></tr></table></figure></li><li><p>分支运营商路由器RouterE的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"> sysname RouterE</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1&#x2F;0&#x2F;0</span><br><span class="line"> ip address 203.10.1.1 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">return</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;原文链接：&lt;a href=&quot;http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&amp;amp;partNo=10012#dc_cfg_campus_002&quot;&gt;http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC1000098180&amp;amp;partNo=10012#dc_cfg_campus_002&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;1-中小型园区-分支出口综合配置举例&quot;&gt;&lt;a href=&quot;#1-中小型园区-分支出口综合配置举例&quot; class=&quot;headerlink&quot; title=&quot;1  中小型园区/分支出口综合配置举例&quot;&gt;&lt;/a&gt;&lt;strong&gt;1&lt;/strong&gt;  中小型园区/分支出口综合配置举例&lt;/h1&gt;&lt;h2 id=&quot;园区网出口简介&quot;&gt;&lt;a href=&quot;#园区网出口简介&quot; class=&quot;headerlink&quot; title=&quot;园区网出口简介&quot;&gt;&lt;/a&gt;园区网出口简介&lt;/h2&gt;&lt;p&gt;园区网出口一般位于企业网内部网络与外部网络的连接处，是内部网络与外部网络之间数据流的唯一出入口。对于中小型企业来说，考虑到企业网络建设的初期投资与长期运维成本，一般希望将多种业务部署在同一设备上。企业网络用户一般同时需要访问Internet和私网VPN，而对于中小型企业来说考虑到建设及维护成本问题，一般租用运营商Internet网络组建私网VPN。对于部分可靠性要求较高的园区网络，一般考虑部署两台出口路由器做冗余备份实现设备级可靠性，同时应用链路聚合、VRRP、主备路由等技术保证园区出口的可靠性。华为AR系列路由器配合华为S系列交换机是中小型园区网出口设备的理想解决方案。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;园区出口设备需要具备NAT Outbound及NAT Server的功能，实现私网地址和公网地址之间的转换，以满足用户访问Internet或者Internet用户访问内网服务器的需求。&lt;/li&gt;
&lt;li&gt;园区出口设备需要具备通过Internet构建私网VPN的功能，以满足企业用户各个机构之间私网VPN互通的需求&lt;/li&gt;
&lt;li&gt;园区出口设备需要具备数据加密传输的功能，以保证数据的完整性和机密性，保障用户业务传输的安全&lt;/li&gt;
&lt;li&gt;中小型园区出口需要具备可靠性、安全性、低成本、易维护等特点。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;配置注意事项&quot;&gt;&lt;a href=&quot;#配置注意事项&quot; class=&quot;headerlink&quot; title=&quot;配置注意事项&quot;&gt;&lt;/a&gt;配置注意事项&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;本配置案例适用于中小型企业园区/分支出口解决方案。&lt;/li&gt;
&lt;li&gt;本配置案例仅涉及企业网络出口相关配置，涉及企业内网的相关配置请参见华为S系列园区交换机快速配置中的“中小园区组网场景”。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;组网需求&quot;&gt;&lt;a href=&quot;#组网需求&quot; class=&quot;headerlink&quot; title=&quot;组网需求&quot;&gt;&lt;/a&gt;组网需求&lt;/h2&gt;&lt;p&gt;某企业总部和分支分别位于不同的城市，地域跨度较远，总部存在A、B两个不同的部门，分支只有一个部门。现在需要建设跨地域的企业园区网络，需要实现的需求如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;总部和分支都需要实现用户访问Internet的需求。总部划分为A、B两个部门，其中A部门的用户可以访问Internet，但是B部门的用户不能访问Internet；分支所有用户都可以访问Internet。&lt;/li&gt;
&lt;li&gt;总部有Web服务器，对外提供WWW服务，外网用户可以访问内网服务器。&lt;/li&gt;
&lt;li&gt;总部和分支之间需要通过Internet进行私网VPN互通，通信内容需要有安全保护。&lt;/li&gt;
&lt;li&gt;总部园区出口可靠性要求较高，需要考虑链路级的可靠性和设备级的可靠性。&lt;/li&gt;
&lt;li&gt;分支可以适当降低可靠性要求。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="华为" scheme="https://zeozzz.github.com/categories/%E5%8D%8E%E4%B8%BA/"/>
    
    
      <category term="华为" scheme="https://zeozzz.github.com/tags/%E5%8D%8E%E4%B8%BA/"/>
    
  </entry>
  
  <entry>
    <title>安全可溯源的IPv6网络</title>
    <link href="https://zeozzz.github.com/2019/07/15/65/"/>
    <id>https://zeozzz.github.com/2019/07/15/65/</id>
    <published>2019-07-15T06:07:55.000Z</published>
    <updated>2020-01-21T09:37:14.067Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　2018年5月3日，工业和信息化部发布关于贯彻落实《推进互联网协议第六版（IPv6）规模部署行动计划》的通知，这份文件，成为智慧校园发展的巨大引擎，文件对教育网的IPv6改造做了明确要求：</p><p>　　到2018年底，教育网完成业务运营支撑系统升级改造，建立面向IPv6业务的运维管理体系和业务管理流程，具备IPv6用户统计、网络日志审计、流量统计以及IPv6业务受理、开通、运行维护等能力。</p><p>　　到2019年底，省教育计算机网以及高等学校校园网完成IPv6升级改造。鼓励有条件的高等学校开展纯IPv6试验网建设；鼓励中小学、幼儿园积极推进校园网IPv6改造。</p><p><img src="https://www.doctorcom.com/uploadfile/2019/0304/20190304122128489.jpg" alt="img" loading="lazy"></p><p>　　国家政策虽然一直在强调校园网的IPv6改造，但就目前IPv6升级而言，高校仍旧没有找到相关IPv6安全合规且系统有效的解决方案。</p><p>　　按照现有等级保护标准，网络安全主要有三个防护要求：</p><p>访问控制、边界完整性和安全审计</p><p>。</p><p>　　需要强调的是，访问控制是建立在实名认证的基础上，然后结合接入控制设备进行实名用户访问控制。</p><p>　　而实名认证分为准入和准出认证，准入认证的好处是实现边界完整和IP实名审计，但要实现IPv6准入认证就意味着现有准入和汇聚网络设备要改造，这对很多高校来说需要很大的预算。</p><p>　　网络设备仅仅简单支持IPv6准入认证还是不够，仍然需要解决很多细节才能建立安全的IPv6网络，这是由于IPv6的以下几个重要特性：</p><p>　　<a id="more"></a></p><p>1.终端兼容性。</p><p>　　原生的安卓设备不支持DHCPv6，意味着无线网需使用无状态地址自动配置方式（SLAAC）配置IPv6。</p><p>　　</p><p>2.地址变化频繁。</p><p>　　使用SLAAC后，所有PC和智能终端操作系统，因默认启用隐私保护策略（RFC4941、RFC7217），终端的IPv6地址就会每小时或切换网络时都会发生变化，目的是隐藏轨迹保护隐私，以防被跟踪攻击。</p><p>　　</p><p>3.NDP协议的组播特性。</p><p>　　IPv6的一个主要增强特性是邻居发现（ND， Neighbor Discovery）。ND用一种更全面、统一的方法取代了IPv4使用的ICMP和ARP。IPv6无状态地址的自动配置和地址变更过程也是基于NDP协议，但NDP协议使用了组播方式通信，意味着终端的IPv6无状态地址和MAC地址对应日志分布在不同的汇聚交换机，传统基于SNMP网管方式难以有效快速采集大规模网络中变化频繁的IPv6地址日志。</p><p>　　所以，校园网基础网络的IPv6改造，不是简单的网络设备改造，如果以上问题不能妥善解决，IPv6的校园场景应用，会面临以下挑战：</p><p>　　</p><p>1.安全无法溯源。</p><p>　　难以实现有效的IPv6 IP实名审计，同时，当IPv6网络出现安全威胁，面对变化频繁的无状态地址，无法溯源终端的网络轨迹，难以找到元凶；</p><p>　　</p><p>2.用户体验差。</p><p>　　在有IPv6准入认证的情况下，频繁变化的地址意味用户需要反复认证，使用体验很差，如果要实现无感知认证，要求认证系统能够兼容不同网络设备厂商的无感知认证方法。</p><p>　　</p><p>3.组网环境复杂。</p><p>　　不同的组网方案也需要不同的整体解决方案。传统三层网络、扁平化网络和SDN网络， IPv6地址审计、无感知认证、准入认证等需要满足的条件就各有不同，比如纯二层扁平化网络，相对于传统三层网络，核心BRAS更容易实现IPv6地址审计。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;　　2018年5月3日，工业和信息化部发布关于贯彻落实《推进互联网协议第六版（IPv6）规模部署行动计划》的通知，这份文件，成为智慧校园发展的巨大引擎，文件对教育网的IPv6改造做了明确要求：&lt;/p&gt;
&lt;p&gt;　　到2018年底，教育网完成业务运营支撑系统升级改造，建立面向IPv6业务的运维管理体系和业务管理流程，具备IPv6用户统计、网络日志审计、流量统计以及IPv6业务受理、开通、运行维护等能力。&lt;/p&gt;
&lt;p&gt;　　到2019年底，省教育计算机网以及高等学校校园网完成IPv6升级改造。鼓励有条件的高等学校开展纯IPv6试验网建设；鼓励中小学、幼儿园积极推进校园网IPv6改造。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.doctorcom.com/uploadfile/2019/0304/20190304122128489.jpg&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;　　国家政策虽然一直在强调校园网的IPv6改造，但就目前IPv6升级而言，高校仍旧没有找到相关IPv6安全合规且系统有效的解决方案。&lt;/p&gt;
&lt;p&gt;　　按照现有等级保护标准，网络安全主要有三个防护要求：&lt;/p&gt;
&lt;p&gt;访问控制、边界完整性和安全审计&lt;/p&gt;
&lt;p&gt;。&lt;/p&gt;
&lt;p&gt;　　需要强调的是，访问控制是建立在实名认证的基础上，然后结合接入控制设备进行实名用户访问控制。&lt;/p&gt;
&lt;p&gt;　　而实名认证分为准入和准出认证，准入认证的好处是实现边界完整和IP实名审计，但要实现IPv6准入认证就意味着现有准入和汇聚网络设备要改造，这对很多高校来说需要很大的预算。&lt;/p&gt;
&lt;p&gt;　　网络设备仅仅简单支持IPv6准入认证还是不够，仍然需要解决很多细节才能建立安全的IPv6网络，这是由于IPv6的以下几个重要特性：&lt;/p&gt;
&lt;p&gt;
    
    </summary>
    
    
      <category term="IPv6" scheme="https://zeozzz.github.com/categories/IPv6/"/>
    
    
      <category term="IPv6" scheme="https://zeozzz.github.com/tags/IPv6/"/>
    
  </entry>
  
  <entry>
    <title>IPv4 与 IPv6 相互操作</title>
    <link href="https://zeozzz.github.com/2019/07/15/64/"/>
    <id>https://zeozzz.github.com/2019/07/15/64/</id>
    <published>2019-07-15T06:07:25.000Z</published>
    <updated>2019-07-15T06:07:48.344Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>​        由于互联网终端不断增加，IPv4 地址长度（32位）已不能够满足要求，所以出现了 IPv6地址（128位），但是现有应用程序大部分还是采用 IPv4 地址形式，所以必须解决 IPv4 与 IPv6 之间的相互操作，使现有基于 IPv4 的应用程序能够与基于 IPv6 的应用程序相互通信。那么我们怎么实现 IPv4 客户端与 IPv6 服务器、IPv6 客户端与 IPv4 服务器之间的通信。</p><h3 id="IPv4-客户端与-IPv6-服务器"><a href="#IPv4-客户端与-IPv6-服务器" class="headerlink" title="IPv4 客户端与 IPv6 服务器"></a>IPv4 客户端与 IPv6 服务器</h3><p>​        假设我们主机是运行双栈，即存在 IPv4 协议栈和 IPv6 协议栈，双栈主机上的 IPv6 服务器既能处理 IPv4 客户端，也能处理 IPv6 客户端，因为 IPv4 可以映射成 IPv6 地址。下图是 IPv4 客户端与 IPv6 服务器之间的通信过程：</p><p><img src="http://img3.itkeyword.com/17/15/QFnY73.png" alt="img" loading="lazy"></p><p>​       IPv6 服务器程序创建的套接字绑定到 IPv6 通配地址和 TCP 端口号 9999。假设客户端和服务器主机都处于同一个以太网，当左侧两个客户端都发送 SYN 报文段请求与服务器建立连接时，IPv4 客户端主机在一个 IPv4 数据报中载送 SYN，IPv6 客户端主机在一个 IPv6 数据报中载送 SYN。在以太网线上包含以太网首部、IP 首部、TCP 首部以及 TCP 数据，根据以太网首部中包含的类型字段区分 IP 类型是为 IPv4 还是 IPv6，因此 IP 首部中的目的 IP 地址格式根据以太网类型字段分为 IPv4 地址和 IPv6 地址。两者的 TCP 首部是一样的，TCP 首部中包含目的端口号（即 IPv6 服务器的端口号 9999）。</p><p>​        服务器的接收数据链路通过查看以太网类型字段把每帧传递给相应的 IP 模块。IPv4 模块结合其上的 TCP 模块检测到 IPv4 数据报的目的端口对应的是一个 IPv6 套接字，于是把该数据报 IPv4 首部中的源 IPv4 地址转换成一个等价的 IPv4 映射的 IPv6 地址。当 accept 系统调用把这个已经接受的 IPv4 客户端连接返回给服务器进程时，这个映射后的地址将作为客户的 IPv6 地址返回给服务器的 IPv6 套接字（也就是说服务器根本不知道自己是在跟 IPv4 客户端通信，客户端也不知道自己和 IPv6 的服务器通信），该连接上其余的数据报都是 IPv4 数据报。对于 IPv6 客户端，当 accept 系统调用把接受的 IPv6 客户端连接返回给服务器进程时，该客户的 IPv6 地址就是原来 IPv6 首部中的源地址，不需要进行映射，该连接上其余的数据报都是 IPv6 数据报。</p><p>IPv4 的 TCP 客户端与 IPv6 的 TCP 服务器之间通信的步骤如下：</p><blockquote><p>推荐：<a href="http://www.itkeyword.com/doc/9277980099094691x126">第10章Ipv4和Ipv6的交互</a></p><p>在ipv4（32）地址不够用的时候，ipv6的使用（128位）将大大增加 地址的使用范围。但是毕竟还是用从ipv4到ipv6的过度期，这个时间还不知道多久呢，就像windows系</p></blockquote><ol><li>首先启动 IPv6 服务器，创建一个 IPv6 的监听套接字，并且该服务器把通配地址和端口号 9999 绑定到该套接字上；</li><li>IPv4 客户端调用 gethostbyname 函数找到服务器主机的一个 A 记录，服务器同时包含 A 记录和 AAAA 记录，即同时支持 IPv4 和 IPv6，对于 IPv4 客户端来说只需要 A 记录即可；</li><li>IPv4 客户端调用 connect 函数向服务器发出连接请求，即客户端主机向服务器主机发送一个 IPv4 的 SYN 数据报（该 IPv4 的 SYN 中的目的地是 IPv6 套接字）；</li><li>服务器主机接收到来自客户端的 IPv4 的 SYN 数据报后，设置一个标志指示本连接应使用 IPv4 映射的 IPv6 地址，并响应一个 IPv4 的SYN 和 ACK 数据报。当该链接建立后，由 accept 函数把这个 IPv4 映射的 IPv6 地址返回给服务器；</li><li>当服务器主机往这个 IPv4 映射的 IPv6 地址发送 TCP 报文段时，其 IP 栈产生目的地址为所映射 IPv4 地址的 IPv4 载送数据报。即客户端和服务器之间所有通信都使用 IPv4 的载送数据报；</li></ol><h3 id="IPv6-客户端与-IPv4-服务器"><a href="#IPv6-客户端与-IPv4-服务器" class="headerlink" title="IPv6 客户端与 IPv4 服务器"></a>IPv6 客户端与 IPv4 服务器</h3><p>IPv6 的 TCP 客户端与 IPv4 的 TCP 服务器之间通信的步骤如下：</p><ol><li>首先启动 IPv4 服务器，创建一个 IPv4 的监听套接字；</li><li>IPv6 客户端调用 getaddrinfo 函数查找 IPv6 地址；</li><li>IPv6 客户端在作为函数参数的 IPv6 套接字地址结构中设置这个 IPv4 映射的 IPv6 地址后调用 connect 函数向服务器发出连接请求，内核检测到这个映射地址后，自动向服务器主机发送一个 IPv4 的 SYN 数据报；</li><li>服务器主机接收到来自客户端的 IPv4 的 SYN 数据报后，响应一个 IPv4 的SYN 和 ACK 数据报。连接通过使用 IPv4 数据报建立；</li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>​        双栈主机上的 IPv6 服务器既能服务于 IPv4 客户，又能服务于 IPv6 客户。IPv4 客户发送给这种服务器的仍然是 IPv4 数据报，不过服务器的协议栈会把客户主机的地址转换成一个 IPv4 映射的 IPv6 地址。类似地，双栈主机上的 IPv6 客户能够与 IPv4 服务器通信，客户的解析器会把服务器主机所有的 A 记录作为 IPv4 映射的 IPv6 地址返回给客户，而客户指定这些地址之一调用 connect 将会使双栈发送一个 IPv4 的 SYN 数据报。为了使套接字编程具有可移植性，在编程实现过程中，尽量避免使用 gethostbyname 和 gethostbyaddr 函数，而应该使用 getaddrinfo 和 getnameinfo 函数。</p><p>参考资料：</p><p>《Unix 网络编程》</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="IPv6" scheme="https://zeozzz.github.com/categories/IPv6/"/>
    
    
      <category term="IPv6" scheme="https://zeozzz.github.com/tags/IPv6/"/>
    
  </entry>
  
  <entry>
    <title>如何定位Ping不通的问题？</title>
    <link href="https://zeozzz.github.com/2019/07/15/63/"/>
    <id>https://zeozzz.github.com/2019/07/15/63/</id>
    <published>2019-07-15T03:36:17.000Z</published>
    <updated>2019-07-15T03:38:35.030Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>故障定位步骤：</strong></p><p><strong>步骤1：检查配置</strong></p><p>检查交换机上端口配置、VLAN配置、VLANIF接口配置、IP地址配置是否正确，首先排除配置问题；确认两端端口的端口类型，两端VLAN的封装方式是否一致，VLANIF接口下IP地址配置的网段是否存在问题。</p><p><strong>步骤2：检查链路</strong><br>检查物理链路：<br>1）光纤或网线连接的端口需要和网络要求的部署一致。<br>2）光纤所带的光模块波长参数需要一致，光模块建议使用华为认证光模块。<br>3）如果是通过Eth-Trunk接口连接，两端设备上Eth-Trunk中加入的物理成员端口数量需要保持一致；若Eth-Trunk启用LACP协议，需要保证LACP协议状态稳定。<br>4）检查两端设备之间是否有传输设备，两端的物理端口是否处于UP状态。<br>5）确认Ping业务经过的物理端口是否存在CRC校验错误，且错误计数是否在不断增长。<br>检查物理端口是否存在阻塞现象。检查设备上是否运行了STP、RRPP或SMART LINK等二层协议，确认Ping业务经过的物理端口是否被阻塞。</p><p><strong>步骤3：检查路由</strong><br>检查设备上是否存在到Ping目的地址的路由。<br>• 如果和交换机连接的是终端设备，检查终端设备上是否配置了正确的网关地址。<br>• 如果和交换机连接的是交换机或路由设备，检查对端设备上是否有正确的回程路由。<br>参考命令：display ip routing-table<br>如果路由不正常，检查接口协议状态是否UP，设备上运行的路由协议是否正常，排查路由故障。</p><p><strong>步骤4：检查ARP表项</strong></p><p>1、检查直连地址的ARP是否学习正常。<br>相关命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">display arp</span><br><span class="line">display arp interface vlanifvlanif-id</span><br></pre></td></tr></table></figure><p>2、如果ARP学习正确，查看MAC表项，确认MAC地址的出端口和ARP的物理出端口是否一致。<br>相关命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">display mac-addressmac-address</span><br><span class="line">display mac-addressmac-addressvlanvlan-id</span><br></pre></td></tr></table></figure><p>3、如果ARP学习不到，排查ARP故障，步骤如下：<br>1）检查设备上是否使能严格ARP学习，若配置将其去使能后观察能否正常学习ARP。<br>2）在不能互相学习ARP的两端设备的其中一端执行长Ping操作，命令行如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -c 100000ip-address</span><br></pre></td></tr></table></figure><p>也可视情况添加-t/-m等参数将Ping的速率适当调整。<br>3）长ping操作会不断触发本端设备发出ARP请求报文，可通过流量统计确认ARP请求报文是否从端口送出。<br>4）通过流量统计检查对端设备的物理端口是否收到了ARP请求报文。若收到ARP请求，查看是否能生成ARP表项，并是否能回应ARP-REPLY；若收到请求未生成表项，联系华为工程师处理。<br>5）同样可采用流量统计方法确认ARP-REPLY报文是否从对端设备物理口发出。若未发出，联系华为工程师处理。<br>6）检查本端设备是否收到ARP-REPLY报文，若物理端口上收到ARP-REPLY但没有上送CPU，联系华为工程师处理。<br>ARP请求和ARP回应报文的流量统计配置，示例如下：</p><p>也可视情况添加-t/-m等参数将Ping的速率适当调整。<br>3）长ping操作会不断触发本端设备发出ARP请求报文，可通过流量统计确认ARP请求报文是否从端口送出。<br>4）通过流量统计检查对端设备的物理端口是否收到了ARP请求报文。若收到ARP请求，查看是否能生成ARP表项，并是否能回应ARP-REPLY；若收到请求未生成表项，联系华为工程师处理。<br>5）同样可采用流量统计方法确认ARP-REPLY报文是否从对端设备物理口发出。若未发出，联系华为工程师处理。<br>6）检查本端设备是否收到ARP-REPLY报文，若物理端口上收到ARP-REPLY但没有上送CPU，联系华为工程师处理。<br>ARP请求和ARP回应报文的流量统计配置，示例如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[huawei] traffic classifier aa operator and&#x2F;&#x2F;配置流分类</span><br><span class="line">[huawei-traffic-classifier-aa]if-match l2-protocol arp &#x2F;&#x2F;匹配ARP报文</span><br><span class="line">[huawei-traffic-classifier-aa]if-match source-mac 1111-1111-1111 &#x2F;&#x2F;匹配源MAC</span><br><span class="line">[huawei-traffic-classifier-aa]if-match destination-mac 2222-2222-2222 &#x2F;&#x2F;匹配目的MAC</span><br><span class="line">[huawei-traffic-classifier-aa]if-match vlan-id 33 &#x2F;&#x2F;匹配VLAN</span><br><span class="line">[huawei-traffic-classifier-aa]quit</span><br></pre></td></tr></table></figure><p>Tips：对应ARP请求报文，目的MAC需要匹配广播MAC(FFFF-FFFF-FFFF)，源MAC匹配发送端设备的MAC；对于ARP回应报文，目的MAC匹配对端MAC，源MAC匹配本设备MAC。上面的数据仅是举例，实际故障定位中需要按照这个原则替换。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[huawei]traffic behavior bb &#x2F;&#x2F;配置流行为</span><br><span class="line">[huawei-traffic-behavior-bb] statistic enable &#x2F;&#x2F;使能流量统计功能</span><br><span class="line">[huawei-traffic-behavior-bb]quit</span><br><span class="line">[huawei]traffic policy pp&#x2F;&#x2F;配置流策略</span><br><span class="line">[huawei-traffice-policy-pp]classifier aa behavior bb &#x2F;&#x2F;关联流分类和流行为</span><br><span class="line">[huawei-traffice-policy-pp]quit</span><br><span class="line">[huawei]interface gigabitethernet 3&#x2F;0&#x2F;0</span><br><span class="line">[huawei-gigabitethernet3&#x2F;0&#x2F;0] traffic policy pp inbound &#x2F;&#x2F;在接口的入方面应用流策略。对于ARP请求报文，应该是接口的出方向。</span><br></pre></td></tr></table></figure><p>步骤5：检查报文收***况</p><p>Ping不通问题或Ping有丢包问题的定位关键主要是确认报文丢在哪里了，可以通过如下几个方式进行确认。</p><p>1、ICMP统计<br>进行Ping操作时，通过命令display icmp statistics查看ICMP报文的收***况，echo和echo reply报文收发是否一致，是否存在checksum错误统计计数。<br>reset ip statistics命令用来清除统计计数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;HUAWEI&gt; display icmp statistics</span><br><span class="line">Input: bad formats 0     bad checksum 0</span><br><span class="line">      echo          521     destination unreachable 0</span><br><span class="line">      source quench   0     redirects               0</span><br><span class="line">      echo reply     19     parameter problem       0</span><br><span class="line">      timestamp       0     information request     0</span><br><span class="line">      mask requests   0     mask replies            0</span><br><span class="line">      time exceeded   0     timestamp reply         0</span><br><span class="line">      Mping request   0     Mping reply             0</span><br><span class="line">Output:echo  19     destination unreachable 0</span><br><span class="line">      source quench   0     redirects                0</span><br><span class="line">      echo reply     512    parameter problem        0</span><br><span class="line">      timestamp       0     information request      0</span><br><span class="line">      mask requests   0     mask replies             0</span><br><span class="line">      time exceeded   0     timestamp reply          0</span><br><span class="line">      Mping request   0     Mping reply              0</span><br></pre></td></tr></table></figure><p>2、IP层调试开关<br>这一层调试开关需要定义ACL匹配Ping报文，即源IP、目的IP地址，进行Ping操作同时打开IP层调试开关，观察报文的收***况。<br>配置命令如下：<br>\</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">acl number 3333</span><br><span class="line">rule 5 permit icmp source x.x.x.x 0 destination y.y.y.y 0</span><br><span class="line">rule 10 permit icmp source y.y.y.y 0 destination x.x.x.x 0</span><br><span class="line">#</span><br><span class="line">debugging ip packet acl 3333 verbose</span><br></pre></td></tr></table></figure><p>下面举例说明：<br>如：ping 7.8.20.5</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PING 7.8.20.5: 56 data bytes, press CTRL_C to break*0.55569503 L3FC-4 IP&#x2F;7&#x2F;debug_case:Sending, interface &#x3D; Vlanif20, version &#x3D; 4, headlen &#x3D; 20, tos &#x3D; 0,pktlen &#x3D; 84, pktid &#x3D; 35000, offset &#x3D; 0, ttl &#x3D; 255, protocol &#x3D; 1,checksum &#x3D; 64727, s &#x3D; 7.8.20.4, d &#x3D; 7.8.20.5prompt: Sending the packet from local at Vlanif20</span><br><span class="line">45 00 00 54 88 b8 00 00 ff 01 fc d7 07 08 14 04</span><br><span class="line">07 08 14 05 08 00 00 9e ab cf 00 01 03 4f ec 5e</span><br><span class="line">81 00 c0 01 50 49 4e 00 00 00 ff 05 00 01 02 03</span><br><span class="line">04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 10 11 12 13</span><br><span class="line">14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23</span><br><span class="line">24 25 26 27</span><br><span class="line">Reply from 7.8.20.5: bytes&#x3D;56 Sequence&#x3D;1 ttl&#x3D;255 time&#x3D;2 ms*0.55569603 L3FC-4 IP&#x2F;7&#x2F;debug_case:Receiving, interface &#x3D; Vlanif20, version &#x3D; 4, headlen &#x3D; 20, tos &#x3D; 0,pktlen &#x3D; 84, pktid &#x3D; 44132, offset &#x3D; 0, ttl &#x3D; 255, protocol &#x3D; 1,checksum &#x3D; 55595, s &#x3D; 7.8.20.5, d &#x3D; 7.8.20.4prompt: Receiving IP packet from Vlanif20</span><br><span class="line">45 00 00 54 ac 64 00 00 ff 01 d9 2b 07 08 14 05</span><br><span class="line">07 08 14 04 00 00 0e 9d ab cf 00 01 03 4f ec 5e</span><br><span class="line">81 00 c0 01 50 4e 47 00 00 00 00 02 00 01 02 03</span><br><span class="line">04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 10 11 12 13</span><br><span class="line">14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23</span><br><span class="line">24 25 26 27</span><br></pre></td></tr></table></figure><p>3、CPCAR统计<br>查看CPCAR的统计情况，检查ICMP报文是否被car掉了。相关命令：<br>大S V100R002版本、小S V100R005版本：display cpu-defend icmp statistics all<br>大S V100R003及之后、小S V100R006及之后的版本：display cpu-defend statistics packet-type icmp all<br>主要关注Drop计数是否在增加。如果Drop计数在增加，说明存在CPCAR丢包，可以适当增加car值再进行Ping测试，看问题是否解决。最后建议恢复car值。</p><p>4、流量统计<br>配置流量统计，确认报文的收***况。定义流分类时需要匹配到Ping的源IP和目的IP，其他配置同ARP报文的统计。<br>配置完成后，执行Ping命令，查看流量统计情况。相关命令：<br>display traffic policy statistics interface GigabitEthernet 0/0/1 inbound<br>display traffic policy statistics interface GigabitEthernet 0/0/1 outbound<br>如果outbound方向没有统计计数，说明报文没有发送出去；如果inbound方向没有统计计数，说明没有收到应答报文。</p><p>5、配置镜像查看报文收*<strong>况<br>通过镜像来确认报文的收**<em>况。<br>如果端口上流量不大，可以直接用端口镜像；<br>如果端口上流量较大，可以使用流镜像。<br>通过对镜像报文进行分析，不仅可以确认报文的收</em></strong>况，同时可以对报文进行校验，包括：报文的VLAN是否正确、报文的目的MAC地址是否是设备系统MAC地址、报文IP头的checksum是否正确、ICMP的checksum是否正确。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="CASE" scheme="https://zeozzz.github.com/categories/CASE/"/>
    
    
      <category term="CASE" scheme="https://zeozzz.github.com/tags/CASE/"/>
    
  </entry>
  
  <entry>
    <title>企业园区网中1x端口的两种方式</title>
    <link href="https://zeozzz.github.com/2019/07/09/62/"/>
    <id>https://zeozzz.github.com/2019/07/09/62/</id>
    <published>2019-07-09T06:45:58.000Z</published>
    <updated>2019-07-09T06:47:45.516Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="1-1-12-dot1x-port-method"><a href="#1-1-12-dot1x-port-method" class="headerlink" title="1.1.12  dot1x port-method"></a>1.1.12  dot1x port-method</h3><p>【命令】</p><p>在系统视图下：</p><p><strong>dot1x</strong> <strong>port-method</strong> { <strong>macbased</strong> | <strong>portbased</strong> } [ <strong>interface</strong> <em>interface-list</em> ]</p><p><strong>undo dot1x</strong> <strong>port-method</strong> [ <strong>interface</strong> <em>interface-list</em> ]</p><p>在二层以太网端口视图下：</p><p><strong>dot1x</strong> <strong>port-method</strong> { <strong>macbased</strong> | <strong>portbased</strong> }</p><p><strong>undo dot1x</strong> <strong>port-method</strong></p><p>【视图】</p><p>系统视图/二层以太网端口视图</p><p>【缺省级别】</p><p>2：系统级</p><p>【参数】</p><p><strong>macbased</strong>：表示基于MAC地址对接入用户进行认证，即该端口下的所有接入用户均需要单独认证，当某个用户下线时，也只有该用户无法使用网络。</p><p><strong>portbased</strong>：表示基于端口对接入用户进行认证，即只要该端口下的第一个用户认证成功后，其他接入用户无须认证就可使用网络资源，但是当第一个用户下线后，其他用户也会被拒绝使用网络。</p><p><strong>interface</strong> <em>interface-list</em>：以太网端口列表，表示多个以太网端口，表示方式为<em>interface-list</em> ＝ { <em>interface-type interface-number</em> [ <strong>to</strong> <em>interface-type interface-number</em> ] }&amp;&lt;1-10&gt;。其中，<em>interface-type</em>为端口类型，<em>interface-number</em>为端口号。&amp;&lt;1-10&gt;表示前面的参数最多可以输入10次。起始端口类型必须和终止端口类型一致，并且终止端口号必须大于起始端口号。</p><p>【描述】</p><p><strong>dot1x</strong> <strong>port-method</strong>命令用来设置802.1X在指定端口上进行接入控制的方式。<strong>undo dot1x</strong> <strong>port-method</strong>命令用来恢复缺省的接入控制方式。</p><p>缺省情况下，接入控制方式为<strong>macbased</strong>。</p><p>需要注意的是：</p><p>l              在系统视图下执行该命令时，若指定了参数<em>interface-list</em>，则作用于<em>interface-list</em>参数所指定的端口；若不指定任何端口，则作用于当前系统中的所有端口。</p><p>l              在以太网端口视图下执行该命令时，不能指定参数<em>interface-list</em>，只能作用于当前端口。</p><p>相关配置可参考命令<strong>display dot1x</strong>。</p><p>【举例】</p><p># 在端口GigabitEthernet1/0/1上配置对接入用户进行基于端口的802.1X认证。</p><p><Sysname> system-view</p><p>[Sysname] dot1x port-method portbased interface gigabitethernet 1/0/1</p><p>或者</p><p><Sysname> system-view</p><p>[Sysname] interface gigabitethernet 1/0/1</p><p>[Sysname-GigabitEthernet1/0/1] dot1x port-method portbased</p><p># 配置端口GigabitEthernet1/0/2～GigabitEthernet1/0/5上对接入用户进行基于端口的802.1X认证。</p><p><Sysname> system-view</p><p>[Sysname] dot1x port-method portbased interface gigabitethernet 1/0/2 to gigabitethernet 1/0/5</p><p>文档：<a href="http://www.h3c.com/cn/d_201111/730911_30005_0.htm#_Toc308256276">http://www.h3c.com/cn/d_201111/730911_30005_0.htm#_Toc308256276</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="802.1x" scheme="https://zeozzz.github.com/categories/802-1x/"/>
    
    
      <category term="802.1x" scheme="https://zeozzz.github.com/tags/802-1x/"/>
    
  </entry>
  
  <entry>
    <title>路由来回路径不一致的case</title>
    <link href="https://zeozzz.github.com/2019/07/05/61/"/>
    <id>https://zeozzz.github.com/2019/07/05/61/</id>
    <published>2019-07-05T02:24:52.000Z</published>
    <updated>2019-07-05T06:17:48.735Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近遇到一个路由来回路径不一致导致网络不通的问题，搜了一些资料，也和前辈讨教了一下，当个case记录下来。</p><p><strong>1、如果链路上存在安全设备，由于来回路径不一致，流量可能会被安全设备认为是半连接，进行阻断。防火墙状态检测一般会挡住来不路径不一致的包。如果网络结构中有防火墙，路由来回路径不一致可能直接导致网络不连通。</strong><br>2、出现问题时，给问题排查带来困难。<br>3、如果不同链路的带宽不一致，可能会导致单向拥塞。</p><p>非对称路由是指发送和接收数据包时，分别使用了主机和目的地设备之间两条不同的路径。</p><p>经过多个实战经验终于可以明确：防火墙来回路径不一致结果是不能正常通信的。</p><p>如下图：</p><p><img src="https://img-blog.csdn.net/20150210025249326?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemFpbndlaTE3NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img" loading="lazy"></p><p>局域网10网段要访问文件服务器路途为</p><p>去：主服务器→防火墙→中间路由器→文件路由器→文件服务器</p><p>回：文件服务器→文件路由器→中间路由器→主服务器</p><p>可以看出数据包在选择路由时是可以正常到达的（实战中ping与telnet+端口也是正常的），但主服务器（10网段）要访问文件服务器（172网段）中的应用程序时，就出现异常了，压根就无法访问。这是怎么回事呢？</p><p>网上高手解释：</p><p>路由没有问题，有来有回。。。<br>路由可达。。</p><p>但安全设备上，过不去。。许多的安全设备会进行检查。。。<br>TCP三次握手。。缺一不可。。<br>比如你的数据出去的时候从A走。。回来的时候，从B机或备机回来，就可能会被拦截。</p><p>DOS攻击，就是只发起建立，而不理会回报，不会进行确认。。<br>如果只有确认报，而没有发起来。基于上下文的检测，会认为这是有问题的报文，不能转发，会当攻击、异常，直接丢弃。</p><p>防火墙在默认情况下是把状态检测打开的，当回包到达防火墙的时候，防火墙仅仅是收到了一个回复的数据包，这个时候防火墙会直接丢弃<br>有些防火墙是有这样的功能 选项，可以进行关闭</p><p>比如华为USG墙</p><p>在防火墙的全局模式下关闭链路的会话检测功能,即：<br>undo firewall session link-state check</p><p>还有些墙支持会话同步功能的，就没有问题。。</p><p>起初第一次碰到这种情况以为是设备版本问题，但之后陆续也出现这种情况，所以不得不认真排查了一翻。通过以下排查可以确定，防火墙来回路径不一致结果是不能正常通信的。</p><p>第一种认证方法：将主服务器网关改成10.45.99.199，最后访问文件服务器所有功能正常。</p><p>第二种认证方法：将防火墙换成路由器其他不变，最后访问文件服务器所有功能正常。</p><p>因此网络上的高手的解释是正确的。</p><p>来回路径不一致还会引起另个问题，目前有些防火墙（比如，神州数码）可以把trust到trust允许后就可以实现从主服务器正常ping及访问文件服务器，但还是引起了另外的一个问题，就是文件服务器无法ping及访问主服务器。</p><p>所以要想让双向网络都能正常访问那么在以后的网络规划中如果使用到防火墙时，必须杜绝这种来回路径不一致的路由。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="路由" scheme="https://zeozzz.github.com/categories/%E8%B7%AF%E7%94%B1/"/>
    
    
      <category term="路由" scheme="https://zeozzz.github.com/tags/%E8%B7%AF%E7%94%B1/"/>
    
  </entry>
  
  <entry>
    <title>vxlan 协议原理简介</title>
    <link href="https://zeozzz.github.com/2019/07/04/60/"/>
    <id>https://zeozzz.github.com/2019/07/04/60/</id>
    <published>2019-07-04T10:04:15.000Z</published>
    <updated>2019-07-04T10:04:52.204Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-vxlan-简介"><a href="#1-vxlan-简介" class="headerlink" title="1. vxlan 简介"></a>1. vxlan 简介</h2><p>VXLAN 全称是 <code>Virtual eXtensible Local Area Network</code>，虚拟可扩展的局域网。它是一种 overlay 技术，通过三层的网络来搭建虚拟的二层网络。rfc7348 (参考资料1) 上的介绍是这样的：</p><blockquote><p>A framework for overlaying virtualized layer 2 networks over lay 3 networks.</p></blockquote><p>每一个技术出来都有它要解决的问题，VXLAN 也不例外，那么我们先看看 VXLAN 到底要解决哪些问题。</p><ul><li>虚拟化（虚拟机和容器）的兴起使得一个数据中心会有成千上万的机器需要通信，而传统的 VLAN 技术只能支持 4096 个网络上限，已经满足不了不断扩展的数据中心规模</li><li>越来越多的数据中心（尤其是公有云服务）需要提供多租户的功能，不同用户之间需要独立地分配 ip 和 MAC 地址，如何保证这个功能的扩展性和正确性也是一个待解决的问题</li><li>云计算业务对业务灵活性要求很高，虚拟机可能会大规模迁移，并保证网络一直可用，也就是大二层的概念。解决这个问题同时保证二层的广播域不会过分扩大，也是云计算网络的要求</li></ul><p>传统二层+三层的网络在应对这些要求时变得力不从心，虽然很多改进型的技术比如堆叠、SVF、TRILL 等能够增加二层的范围，努力改进经典网络，但是要做到对网络改动小同时保证灵活性高却非常困难。</p><p>为了解决这些问题，有很多方案被提出来，vxlan 就是其中之一。vxlan 是 VMware、Cisco 等一众大型企业共同推出的，目前标准文档在 <a href="https://tools.ietf.org/html/rfc7348">RFC7348</a>。</p><h2 id="2-VXLAN-模型"><a href="#2-VXLAN-模型" class="headerlink" title="2. VXLAN 模型"></a>2. VXLAN 模型</h2><p>vxlan 这类隧道网络的一个特点是对原有的网络架构影响小，原来的网络不需要做任何改动，在原来网络基础上架设一层新的网络。</p><p>vxlan 自然会引入一些新的概念，这部分就讲讲它们。下面这张图 是 vxlan 的工作模型，它创建在原来的 IP 网络（三层）上，只要是三层可达（能够通过 IP 互相通信）的网络就能部署 vxlan。在每个端点上都有一个 vtep 负责 vxlan 协议报文的封包和解包，也就是在虚拟报文上封装 vtep 通信的报文头部。物理网络上可以创建多个 vxlan 网络，这些 vxlan 网络可以认为是一个隧道，不同节点的虚拟机能够通过隧道直连。每个 vxlan 网络由唯一的 VNI 标识，不同的 vxlan 可以不相互影响。</p><p><img src="http://support.huawei.com/huaweiconnect/enterprise/data/attachment/forum/dm/ecommunity/uploads/2015/1123/16/5652c940898f4.png" alt="img" loading="lazy"></p><ul><li>VTEP（VXLAN Tunnel Endpoints）：vxlan 网络的边缘设备，用来进行 vxlan 报文的处理（封包和解包）。vtep 可以是网络设备（比如交换机），也可以是一台机器（比如虚拟化集群中的宿主机）</li><li>VNI（VXLAN Network Identifier）：VNI 是每个 vxlan 的标识，是个 24 位整数，一共有 2^24 = 16,777,216（一千多万），一般每个 VNI 对应一个租户，也就是说使用 vxlan 搭建的公有云可以理论上可以支撑千万级别的租户</li><li>Tunnel：隧道是一个逻辑上的概念，在 vxlan 模型中并没有具体的物理实体想对应。隧道可以看做是一种虚拟通道，vxlan 通信双方（图中的虚拟机）认为自己是在直接通信，并不知道底层网络的存在。从整体来说，每个 vxlan 网络像是为通信的虚拟机搭建了一个单独的通信通道，也就是隧道</li></ul><p>现在来说，这些概念还是非常晦涩难理解的，我们会在下面具体讲解 vxlan 网络的报文和通信流程，希望文章结束之后再回来看这些概念能明白它们的意思。</p><h2 id="3-VXLAN-报文解析"><a href="#3-VXLAN-报文解析" class="headerlink" title="3. VXLAN 报文解析"></a>3. VXLAN 报文解析</h2><p>前面说过，vxlan 在三层网络上构建一个虚拟的二层网络出来，这一点能够在 vxlan 的报文上很明显地体现出来。</p><p>下图是 vxlan 协议的报文，白色的部分是虚拟机发送报文（二层帧，包含了 MAC 头部、IP 头部和传输层头部的报文），前面加了 vxlan 头部用来专门保存 vxlan 相关的内容，在前面是标准的 UDP 协议头部（UDP 头部、IP 头部和 MAC 头部）用来在底层网路上传输报文。</p><p><img src="https://ying-zhang.github.io/img/vnet-vxlan.png" alt="img" loading="lazy"></p><p>从这个报文中可以看到三个部分：</p><ol><li>最外层的 UDP 协议报文用来在底层网络上传输，也就是 vtep<br>之间互相通信的基础</li><li>中间是 VXLAN 头部，vtep 接受到报文之后，去除前面的 UDP 协议部分，根据这部分来处理 vxlan 的逻辑，主要是根据 VNI 发送到最终的虚拟机</li><li>最里面是原始的报文，也就是虚拟机看到的报文内容</li></ol><p>报文各个部分的意义如下：</p><ul><li>VXLAN header：vxlan 协议相关的部分，一共 8 个字节<ul><li>VXLAN flags：标志位</li><li>Reserved：保留位</li><li>VNID：24 位的 VNI 字段，这也是 vxlan 能支持千万租户的地方</li><li>Reserved：保留字段</li></ul></li><li>UDP 头部，8 个字节<ul><li>UDP 应用通信双方是 vtep 应用，其中目的端口就是接收方 vtep 使用的端口，IANA 分配的端口是 4789</li></ul></li><li>IP 头部：20 字节<ul><li>主机之间通信的地址，可能是主机的网卡 IP 地址，也可能是多播 IP 地址</li></ul></li><li>MAC 头部：14 字节<ul><li>主机之间通信的 MAC 地址，源 MAC 地址为主机 MAC 地址，目的 MAC 地址为下一跳设备的 MAC 地址</li></ul></li></ul><p>可以看出 vxlan 协议比原始报文多 50 字节的内容，这会降低网络链路传输有效数据的比例。vxlan 头部最重要的是 VNID 字段，其他的保留字段主要是为了未来的扩展，目前留给不同的厂商用这些字段添加自己的功能。</p><h2 id="4-vxlan-网络通信过程"><a href="#4-vxlan-网络通信过程" class="headerlink" title="4. vxlan 网络通信过程"></a>4. vxlan 网络通信过程</h2><p>通过上节的内容，我们大致了解 vxlan 报文的发送过程。虚拟机的报文通过 vtep 添加上 vxlan 以及外部的报文层，然后发送出去，对方 vtep 收到之后拆除 vxlan 头部然后根据 VNI 把原始报文发送到目的虚拟机。</p><p>上面的过程是双方已经知道所有通信信息的过程，但是在第一次通信之前还有很多问题有解决：</p><ul><li>哪些 vtep 需要加到一个相同的 VNI 组？</li><li>发送方虚拟机怎么知道对方的 MAC 地址？</li><li>vtep 怎么知道目的虚拟机在哪一台宿主机上？</li></ul><p>这三个问题可以归结为同一个问题：vxlan 网络怎么感知彼此的存在并选择正确的路径传输报文？</p><p>而且第一个问题也是不用回答的，因为 vtep 形成的组是虚构的概念，只有某些 vtep 能够正确地传递报文，它们就是在同一个组内。也就是说，我们只要回答后面两个问题就行。</p><p>要回答这两个问题，我们还是回到 vxlan 协议报文上，看看一个完整的 vxlan 报文需要哪些信息。</p><ul><li>内层报文：通信的虚拟机双方要么直接使用 IP 地址，要么通过 DNS 等方式已经获取了对方的 IP 地址，因此网络层地址已经知道。同一个网络的虚拟机需要通信，还需要知道<strong>对方虚拟机的 MAC 地址</strong>，vxlan 需要一个机制来实现传统网络 ARP 的功能</li><li>vxlan 头部：只需要知道 VNI，这一般是直接配置在 vtep 上的，要么是提前规划写死的，要么是根据内部报文自动生成的，也不需要担心</li><li>UDP 头部：最重要的是源地址和目的地址的端口，源地址端口是系统生成并管理的，目的端口也是写死的，比如 IANA 规定的 4789 端口，这部分也不需要担心</li><li>IP 头部：IP 头部关心的是 vtep 双方的 IP 地址，源地址可以很简单确定，目的地址是<strong>虚拟机所在地址宿主机 vtep 的 IP 地址</strong>，这个也需要由某种方式来确定</li><li>MAC 头部：如果 vtep 的 IP 地址确定了，MAC 地址可以通过经典的 ARP 方式来获取，毕竟 vtep 网络在同一个三层，经典网络架构那一套就能直接用了</li></ul><p>总结一下，一个 vxlan 报文需要确定两个地址信息：目的虚拟机的 MAC 地址和目的 vtep 的 IP 地址，如果 VNI 也是动态感知的，那么 vtep 就需要一个三元组：</p><blockquote><p>内部 MAC &lt;–&gt; VNI &lt;–&gt; VTEP IP</p></blockquote><p>根据实现的不同，一般分为两种方式：多播和控制中心。多播的概念是同个 vxlan 网络的 vtep 加入到同一个多播网络，如果需要知道以上信息，就在组内发送多播来查询；控制中心的概念是在某个集中式的地方保存了所有虚拟机的上述信息，自动化告知 vtep 它需要的信息。</p><p>针对这两种方式，我们下面就分别分析。</p><h3 id="多播"><a href="#多播" class="headerlink" title="多播"></a>多播</h3><p>多播的概念和工作原理不是这里的重点，所以就不介绍了。简单来说，每个多播组对应一个多播 IP 地址，往这个多播 IP 地址发送的报文会发给多播组的所有主机。</p><p>为什么要使用多播？因为 vxlan 的底层网络是三层的，广播地址无法穿越三层网络，要给 vxlan 网络所有 vtep 发送报文只能通过多播。</p><p>下图是在多播模式下，vxlan 的报文工作流程，位于左下方的 机器 A 要通过 vxlan 网络发送报文给右下方的机器 B。</p><p><img src="http://img.blog.csdn.net/20160113005124711?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img" loading="lazy"></p><p>vtep 建立的时候会通过配置加入到多播组（具体做法取决于实现），图中的多播组 IP 地址是 <code>239.1.1.1</code>。</p><ol><li>机器 A 只知道对方的 IP 地址，不知道 MAC 地址，因此会发送 ARP 报文进行查询，内部的 ARP 报文很普通，目标地址为全 1 的广播地址</li><li>vtep 收到 ARP 报文，发现虚拟机目的 MAC 为广播地址，封装上 vxlan 协议头部之后（外层 IP 为多播组 IP，MAC 地址为多播组的 MAC 地址），发送给多播组 <code>239.1.1.1</code>，支持多播的底层网络设备（交换机和路由器）会把报文发送给组内所有的成员</li><li>vtep 接收到 vxlan 封装的 ARP 请求，去掉 vxlan 头部，并通过报文学习到发送方 &lt;虚拟机 MAC - VNI - Vtep IP&gt; 三元组保存起来，把原来的 ARP 报文广播给主机</li><li>主机接收到 ARP 请求报文，如果 ARP 报文请求的是自己的 MAC 地址，就返回 ARP 应答</li><li>vtep-2 此时已经知道发送放的虚拟机和 vtep 信息，把 ARP 应答添加上 vxlan 头部（外部 IP 地址为 vtep-1 的 IP 地址，VNI 是原来报文的 VNI）之后通过单播发送出去</li><li>vtep-1 接收到报文，并学习到报文中的三元组，记录下来。然后 vtep 进行解包，知道内部的 IP 和 MAC 地址，并转发给目的虚拟机</li><li>虚拟机拿到 ARP 应答报文，就知道了到目的虚拟机的 MAC 地址</li></ol><p>在这个过程中，只有一次多播，因为 vtep 有自动学习的能力，后续的报文都是通过单播直接发送的。可以看到，多播报文非常浪费，每次的多播其实只有一个报文是有效的，如果某个多播组的 vtep 数量很多，这个浪费是非常大的。但是多播组也有它的实现起来比较简单，不需要中心化的控制，只有底层网络支持多播，只有配置好多播组就能自动发现了。</p><p>单播报文的发送过程就是上述应答报文的逻辑，应该也非常容易理解了。还有一种通信方式，那就是不同 VNI 网络之间的通信，这个需要用到 vxlan 网关（可以是物理网络设备，也可以是软件），它接收到一个 vxlan 网络报文之后解压，根据特定的逻辑添加上另外一个 vxlan 头部转发出去。</p><p>因为并不是所有的网络设备都支持多播，再加上多播方式带来的报文浪费，在实际生产中这种方式很少用到。</p><h3 id="分布式控制中心"><a href="#分布式控制中心" class="headerlink" title="分布式控制中心"></a>分布式控制中心</h3><p>从多播的流程可以看出来，其实 vtep 发送报文最关键的就是知道对方虚拟机的 MAC 地址和虚拟机所在主机的 vtep IP 地址。如果能够事先知道这两个信息，直接告诉 vtep，那么就不需要多播了。</p><p>在虚拟机和容器的场景中，当虚拟机或者容器启动还没有进行网络通讯时，我们就可以知道它的 IP 和 MAC（可能是用某种方式获取，也有可能是事先控制这两个地址），分布式控制中心保存了这些信息。除此之外，控制中心还保存了每个 vxlan 网络有哪些 vtep，这些 vtep 的地址是多少。有了这些信息，vtep 就能发送报文时直接查询并添加头部，不需要多播去满网络地问了。</p><p>一般情况下，在每个 vtep 所在的节点都会有一个 agent，它会和控制中心通信，获取 vtep 需要的信息以某种方式告诉 vtep。具体的做法取决于具体的实现，每种实现可能会更新不同的信息给 vtep，比如 HER（Head End Replication）只是把多播组替换成多个单播报文，也就是把多播组所有的 VTEP IP 地址告诉 vtep，这样查询的时候不是发送多播，而是给组内每个 vtep 发送一个单播报文；有些实现只是告诉 vtep 目的虚拟机的 MAC 地址信息；有些实现告诉 MAC 地址对应的 vtep IP 地址。</p><p>此外，什么时候告诉 vtep 这些信息也是有区别的。一般有两种方式：常见的是一旦知道了虚拟机的三元组信息就告诉 vtep（即使某个 vtep 用不到这个信息，因为它管理的虚拟机不会和这个地址通信），一般这时候第一次通信还没有发生；另外一种方式是在第一次通信时，当 vtep 需要这些信息的时候以某种方式通知 agent，然后 agent 这时候才告诉 vtep 信息。</p><p>分布式控制的 vxlan 是一种典型的 SDN 架构，也是目前使用最广泛的方式。因为它的实现多样，而且每种实现都有些许差距，这里不便来具体的例子来说明，只要明白了上面的原理，不管是什么样的实现，都能很快上手。</p><h2 id="5-vxlan-网络带来新的问题"><a href="#5-vxlan-网络带来新的问题" class="headerlink" title="5. vxlan 网络带来新的问题"></a>5. vxlan 网络带来新的问题</h2><p>vxlan 协议给虚拟网络带来了灵活性和扩展性，让云计算网络能够像计算、存储资源那样按需扩展，并灵活分布。和计算机领域所有技术一样，这也是一种 tradeoff，相对于经典网络来说，vxlan 主要的问题是它的复杂性和额外的开销。</p><h3 id="额外的报文和计算"><a href="#额外的报文和计算" class="headerlink" title="额外的报文和计算"></a>额外的报文和计算</h3><p>这一点可容易看出来，每个 vxlan 报文都有额外的 50 字节开销，如果加上 vlan 字段，开销要到 54 字节。这对于小报文的传输是非常昂贵的操作，试想如果某个报文应用数据才几个字节，原来的网络头部加上 vxlan 报文头部都能有 100 字节的控制信息。</p><p>额外的报文也带来了额外的计算量，每个 vxlan 报文的封包和解包操作都是必须的，如果用软件来实现这些步骤，额外的计算量也是不可以忽略的影响。</p><h3 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h3><p>vxlan 另外一个缺点是复杂度，虽然经典网络在应对云计算时捉紧见拙，但是经典网络模型已经发展了很久，所有的部署、监控、运维都比较成熟。如果使用 vxlan 网络，那么所有的这些都要重新学习，时间和人力成本必然会大大提高。</p><h2 id="6-参考资料"><a href="#6-参考资料" class="headerlink" title="6. 参考资料"></a>6. 参考资料</h2><ul><li><a href="https://tools.ietf.org/html/rfc7348">VXLAN 协议文档: rfc7348</a></li><li><a href="http://support.huawei.com/huaweiconnect/enterprise/thread-334207.html">【华为悦读汇】技术发烧友：认识VXLAN</a></li><li><a href="http://support.huawei.com/huaweiconnect/enterprise/forum.php?mod=viewthread&tid=284371&page=1#pid1553281">Vxlan基础理解-新的三层overlay技术的浅析</a></li><li><a href="http://blog.csdn.net/sinat_31828101/article/details/50504656">vxlan 技术探究</a></li><li><a href="https://blogs.vmware.com/vsphere/2013/05/vxlan-series-how-vtep-learns-and-creates-forwarding-table-part-5.html">VMware vxlan series</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="VXLAN" scheme="https://zeozzz.github.com/categories/VXLAN/"/>
    
    
      <category term="VXLAN" scheme="https://zeozzz.github.com/tags/VXLAN/"/>
    
  </entry>
  
  <entry>
    <title>对服务器上出现大量的SYN_RCVD状态的TCP连接的问题分析</title>
    <link href="https://zeozzz.github.com/2019/06/28/59/"/>
    <id>https://zeozzz.github.com/2019/06/28/59/</id>
    <published>2019-06-28T02:16:36.000Z</published>
    <updated>2019-06-28T02:19:19.370Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>​        首先我们需要弄清楚SYN_RCVD状态是怎样产生的，通过TCP状态转换图(如下图)我们可以清楚的看到，SYN_RCVD是TCP三次握手的中间状态，是服务端口（监听端口，如应用服务器的80端口）收到SYN包并发送[SYN，ACK]包后所处的状态。这时如果再收到ACK的包，就完成了三次握手，建立起TCP连接。</p><p><img src="http://dl.iteye.com/upload/attachment/352766/2c25f9fd-10af-3a97-a230-614a65805c43.png" alt="img" loading="lazy"></p><p>​      如果服务器上出现大量的SYN_RCVD状态的TCP连接说明这些连接一直没有收到ACK包，这主要有两种可能，一种是对方（请求方或客户端）没有收到服务器发送的[SYN,ACK]包，另一种可能是对方收到了[SYN,ACK]包却没有ACK。</p><p>​      对于第一种情况一般是由于网络结构或安全规则限制导致(SYN,ACK)包无法发送到对方，这种情况比较容易判断：只要在服务器上能够ping通互联网的任意主机，基本可以排除这种情况。</p><p>​      对于第二种情况要稍微复杂一些，这种情况还有两种可能：一种是对方根本就不打算ACK，一般在对方程序有意为之才会出现，如SYN Flood类型的DOS/DDOS攻击；另一种可能是对方收到的[SYN,ACK]包不合法，常见的是SYN包的目的地址（服务地址）和应答[SYN,ACK]包的源地址不同。这种情况在只配置了DNAT而不进行SNAT的服务网络环境下容易出现，主要是由于inbound（SYN包）和outbound（[SYN,ACK]包）的包穿越了不同的网关/防火墙/负载均衡器，从而导致[SYN,ACK]路由到互联网的源地址（一般是防火墙的出口地址）与SYN包的目的地址（服务的虚拟IP)不同，这时客户机无法将SYN包和[SYN,ACK]包关联在一起，从而会认为已发出的SYN包还没有被应答，于是继续等待应答包。这样服务器端的连接一直保持在SYN_RCVD状态（半开连接）直到超时。     </p><p>原文链接：<a href="https://daviswang.iteye.com/blog/819176">https://daviswang.iteye.com/blog/819176</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="TCP" scheme="https://zeozzz.github.com/categories/TCP/"/>
    
    
      <category term="TCP" scheme="https://zeozzz.github.com/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>RAID技术全解图解-RAID0、RAID1、RAID5、RAID100【转】</title>
    <link href="https://zeozzz.github.com/2019/06/11/58/"/>
    <id>https://zeozzz.github.com/2019/06/11/58/</id>
    <published>2019-06-11T06:30:52.000Z</published>
    <updated>2019-06-11T06:31:25.828Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="图文并茂-RAID-技术全解-–-RAID0、RAID1、RAID5、RAID100……"><a href="#图文并茂-RAID-技术全解-–-RAID0、RAID1、RAID5、RAID100……" class="headerlink" title="图文并茂 RAID 技术全解 – RAID0、RAID1、RAID5、RAID100……"></a>图文并茂 RAID 技术全解 – RAID0、RAID1、RAID5、RAID100……</h3><p>　　RAID 技术相信大家都有接触过，尤其是服务器运维人员，RAID 概念很多，有时候会概念混淆。这篇文章为网络转载，写得相当不错，它对 RAID 技术的概念特征、基本原理、关键技术、各种等级和发展现状进行了全面的阐述，并为用户如何进行应用选择提供了基本原则，对于初学者应该有很大的帮助。</p><h3 id="一、RAID-概述"><a href="#一、RAID-概述" class="headerlink" title="一、RAID 概述"></a>一、RAID 概述</h3><p>　　1988 年美国加州大学伯克利分校的 D. A. Patterson 教授等首次在论文 “A Case of Redundant Array of Inexpensive Disks” 中提出了 RAID 概念 [1] ，即廉价冗余磁盘阵列（ Redundant Array of Inexpensive Disks ）。由于当时大容量磁盘比较昂贵， RAID 的基本思想是将多个容量较小、相对廉价的磁盘进行有机组合，从而以较低的成本获得与昂贵大容量磁盘相当的容量、性能、可靠性。随着磁盘成本和价格的不断降低， RAID 可以使用大部分的磁盘， “廉价” 已经毫无意义。因此， RAID 咨询委员会（ RAID Advisory Board, RAB ）决定用 “ 独立 ” 替代 “ 廉价 ” ，于时 RAID 变成了独立磁盘冗余阵列（ Redundant Array of Independent Disks ）。但这仅仅是名称的变化，实质内容没有改变。</p><p>　　RAID 这种设计思想很快被业界接纳， RAID 技术作为高性能、高可靠的存储技术，已经得到了非常广泛的应用。 RAID 主要利用数据条带、镜像和数据校验技术来获取高性能、可靠性、容错能力和扩展性，根据运用或组合运用这三种技术的策略和架构，可以把 RAID 分为不同的等级，以满足不同数据应用的需求。 D. A. Patterson 等的论文中定义了 RAID1 ~ RAID5 原始 RAID 等级， 1988 年以来又扩展了 RAID0 和 RAID6 。近年来，存储厂商不断推出诸如 RAID7 、 RAID10/01 、 RAID50 、 RAID53 、 RAID100 等 RAID 等级，但这些并无统一的标准。目前业界公认的标准是 RAID0 ~ RAID5 ，除 RAID2 外的四个等级被定为工业标准，而在实际应用领域中使用最多的 RAID 等级是 RAID0 、 RAID1 、 RAID3 、 RAID5 、 RAID6 和 RAID10。</p><p>　　从实现角度看， RAID 主要分为软 RAID、硬 RAID 以及软硬混合 RAID 三种。软 RAID 所有功能均有操作系统和 CPU 来完成，没有独立的 RAID 控制 / 处理芯片和 I/O 处理芯片，效率自然最低。硬 RAID 配备了专门的 RAID 控制 / 处理芯片和 I/O 处理芯片以及阵列缓冲，不占用 CPU 资源，但成本很高。软硬混合 RAID 具备 RAID 控制 / 处理芯片，但缺乏 I/O 处理芯片，需要 CPU 和驱动程序来完成，性能和成本 在软 RAID 和硬 RAID 之间。</p><p>　　RAID 每一个等级代表一种实现方法和技术，等级之间并无高低之分。在实际应用中，应当根据用户的数据应用特点，综合考虑可用性、性能和成本来选择合适的 RAID 等级，以及具体的实现方式。</p><h3 id="二、基本原理"><a href="#二、基本原理" class="headerlink" title="二、基本原理"></a>二、基本原理</h3><p>　　RAID （ Redundant Array of Independent Disks ）即独立磁盘冗余阵列，通常简称为磁盘阵列。简单地说， RAID 是由多个独立的高性能磁盘驱动器组成的磁盘子系统，从而提供比单个磁盘更高的存储性能和数据冗余的技术。 RAID 是一类多磁盘管理技术，其向主机环境提供了成本适中、数据可靠性高的高性能存储。 SNIA 对 RAID 的定义是 [2] ：一种磁盘阵列，部分物理存储空间用来记录保存在剩余空间上的用户数据的冗余信息。当其中某一个磁盘或访问路径发生故障时，冗余信息可用来重建用户数据。磁盘条带化虽然与 RAID 定义不符，通常还是称为 RAID （即 RAID0 ）。</p><p>　　RAID 的初衷是为大型服务器提供高端的存储功能和冗余的数据安全。在整个系统中， RAID 被看作是由两个或更多磁盘组成的存储空间，通过并发地在多个磁盘上读写数据来提高存储系统的 I/O 性能。大多数 RAID 等级具有完备的数据校验、纠正措施，从而提高系统的容错性，甚至镜像方式，大大增强系统的可靠性， Redundant 也由此而来。</p><p>　　这里要提一下 JBOD （ Just a Bunch of Disks ）。最初 JBOD 用来表示一个没有控制软件提供协调控制的磁盘集合，这是 RAID 区别与 JBOD 的主要因素。目前 JBOD 常指磁盘柜，而不论其是否提供 RAID 功能。</p><p>　　RAID 的两个关键目标是提高数据可靠性和 I/O 性能。磁盘阵列中，数据分散在多个磁盘中，然而对于计算机系统来说，就像一个单独的磁盘。通过把相同数据同时写入到多块磁盘（典型地如镜像），或者将计算的校验数据写入阵列中来获得冗余能力，当单块磁盘出现故障时可以保证不会导致数据丢失。有些 RAID 等级允许更多地 磁盘同时发生故障，比如 RAID6 ，可以是两块磁盘同时损坏。在这样的冗余机制下，可以用新磁盘替换故障磁盘， RAID 会自动根据剩余磁盘中的数据和校验数据重建丢失的数据，保证数据一致性和完整性。数据分散保存在 RAID 中的多个不同磁盘上，并发数据读写要大大优于单个磁盘，因此可以获得更高的聚合 I/O 带宽。当然，磁盘阵列会减少全体磁盘的总可用存储空间，牺牲空间换取更高的可靠性和性能。比如， RAID1 存储空间利用率仅有 50% ， RAID5 会损失其中一个磁盘的存储容量，空间利用率为 (n-1)/n 。</p><p>　　磁盘阵列可以在部分磁盘（单块或多块，根据实现而论）损坏的情况下，仍能保证系统不中断地连续运行。在重建故障磁盘数据至新磁盘的过程中，系统可以继续正常运行，但是性能方面会有一定程度上的降低。一些磁盘阵列在添加或删除磁盘时必须停机，而有些则支持热交换 （ Hot Swapping ），允许不停机下替换磁盘驱动器。这种高端磁盘阵列主要用于要求高可能性的应用系统，系统不能停机或尽可能少的停机时间。一般来说， RAID 不可作为数据备份的替代方案，它对非磁盘故障等造成的数据丢失无能为力，比如<a href="http://www.hack520.com/topic/virus/">病毒</a>、人为破坏、意外删除等情形。此时的数据丢失是相对操作系统、文件系统、卷管理器或者应用系统来说的，对于 RAID 系统来身，数据都是完好的，没有发生丢失。所以，数据备份、灾 备等数据保护措施是非常必要的，与 RAID 相辅相成，保护数据在不同层次的安全性，防止发生数据丢失。</p><p>　　RAID 中主要有三个关键概念和技术：镜像（ Mirroring ）、数据条带（ Data Stripping ）和数据校验（ Data parity ） [3][4][5] 。镜像，将数据复制到多个磁盘，一方面可以提高可靠性，另一方面可并发从两个或多个副本读取数据来提高读性能。显而易见，镜像的写性能要稍低， 确保数据正确地写到多个磁盘需要更多的时间消耗。数据条带，将数据分片保存在多个不同的磁盘，多个数据分片共同组成一个完整数据副本，这与镜像的多个副本是不同的，它通常用于性能考虑。数据条带具有更高的并发粒度，当访问数据时，可以同时对位于不同磁盘上数据进行读写操作， 从而获得非常可观的 I/O 性能提升 。数据校验，利用冗余数据进行数据错误检测和修复，冗余数据通常采用海明码、异或操作等算法来计算获得。利用校验功能，可以很大程度上提高磁盘阵列的可靠性、鲁棒性和容错能力。不过，数据校验需要从多处读取数据并进行计算和对比，会影响系统性能。 不同等级的 RAID 采用一个或多个以上的三种技术，来获得不同的数据可靠性、可用性和 I/O 性能。至于设计何种 RAID （甚至新的等级或类型）或采用何种模式的 RAID ，需要在深入理解系统需求的前提下进行合理选择，综合评估可靠性、性能和成本来进行折中的选择。</p><p>　　RAID 思想从提出后就广泛被业界所接纳，存储工业界投入了大量的时间和财力来研究和开发相关产品。而且，随着处理器、<a href="http://www.hack520.com/topic/ram/">内存</a>、计算机接口等技术的不断发展， RAID 不断地发展和革新，在计算机存储领域得到了广泛的应用，从高端系统逐渐延伸到普通的中低端系统。 RAID 技术如此流行，源于其具有显著的特征和优势，基本可以满足大部分的数据存储需求。总体说来， RAID 主要优势有如下几点：</p><p><strong>(1) 大容量</strong></p><p>　　这是 RAID 的一个显然优势，它扩大了磁盘的容量，由多个磁盘组成的 RAID 系统具有海量的存储空间。现在单个磁盘的容量就可以到 1TB 以上，这样 RAID 的存储容量就可以达到 PB 级，大多数的存储需求都可以满足。一般来说， RAID 可用容量要小于所有成员磁盘的总容量。不同等级的 RAID 算法需要一定的冗余开销，具体容量开销与采用算法相关。如果已知 RAID 算法和容量，可以计算出 RAID 的可用容量。通常， RAID 容量利用率在 50% ~ 90% 之间。</p><p><strong>(2) 高性能</strong></p><p>　　 RAID 的高性能受益于数据条带化技术。单个磁盘的 I/O 性能受到接口、带宽等计算机技术的限制，性能往往很有 限，容易成为系统性能的瓶颈。通过数据条带化， RAID 将数据 I/O 分散到各个成员磁盘上，从而获得比单个磁盘成倍增长的聚合 I/O 性能。</p><p><strong>(3) 可靠性</strong></p><p>　　可用性和可靠性是 RAID 的另一个重要特征。从理论上讲，由多个磁盘组成的 RAID 系统在可靠性方面应该比单个磁盘要差。这里有个隐含假定：单个磁盘故障将导致整个 RAID 不可用。 RAID 采用镜像和数据校验等数据冗余技术，打破了这个假定。 镜像是最为原始的冗余技术，把某组磁盘驱动器上的数据完全复制到另一组磁盘驱动器上，保证总有数据副本可用。 比起镜像 50% 的冗余开销 ，数据校验要小很多，它利用校验冗余信息对数据进行校验和纠错。 RAID 冗余技术大幅提升数据可用性和可靠性，保证了若干磁盘出错时，不 会导致数据的丢失，不影响系统的连续运行。</p><p><strong>(4) 可管理性</strong></p><p>　　实际上， RAID 是一种虚拟化技术，它对多个物理磁盘驱动器虚拟成一个大容量的逻辑驱动器。对于外部主机系统来说， RAID 是一个单一的、快速可靠的大容量磁盘驱动器。这样，用户就可以在这个虚拟驱动器上来组织和存储应用系统数据。 从用户应用角度看，可使存储系统简单易用，管理也很便利。 由于 RAID 内部完成了大量的存储管理工作，管理员只需要管理单个虚拟驱动器，可以节省大量的管理工作。 RAID 可以动态增减磁盘驱动器，可自动进行数据校验和数据重建，这些都可以 大大简化管理工作。</p><h3 id="三、关键技术"><a href="#三、关键技术" class="headerlink" title="三、关键技术"></a>三、关键技术</h3><p><strong>3.1 镜像</strong></p><p>　　镜像是一种冗余技术，为磁盘提供保护功能，防止磁盘发生故障而造成数据丢失。对于 RAID 而言，采用镜像技术 典型地 将会同时在阵列中产生两个完全相同的数据副本，分布在两个不同的磁盘驱动器组上。镜像提供了完全的数据冗余能力，当一个数据副本失效不可用时，外部系统仍可正常访问另一副本，不会对应用系统运行和性能产生影响。而且，镜像不需要额外的计算和校验，故障修复非常快，直接复制即可。镜像技术可以从多个副本进行并发读取数据，提供更高的读 I/O 性能，但不能并行写数据，写多个副本会会导致一定的 I/O 性能降低。</p><p>　　镜像技术提供了非常高的数据安全性，其代价也是非常昂贵的，需要至少双倍的存储空间。高成本限制了镜像的广泛应用，主要应用于至关重要的数据保护，这种场合下数据丢失会造成巨大的损失。另外，镜像通过“ 拆分 ”能获得特定时间点的上数据快照，从而可以实现一种备份窗口几乎为零的数据备份技术。</p><p><strong>3.2 数据条带</strong></p><p>　　磁盘存储的性能瓶颈在于磁头寻道定位，它是一种慢速机械运动，无法与高速的 CPU 匹配。再者，单个磁盘驱动器性能存在物理极限， I/O 性能非常有限。 RAID 由多块磁盘组成，数据条带技术将数据以块的方式分布存储在多个磁盘中，从而可以对数据进行并发处理。这样写入和读取数据就可以在多个磁盘上同时进行，并发产生非常高的聚合 I/O ，有效提高了整体 I/O 性能，而且具有良好的线性扩展性。这对大容量数据尤其显著，如果不分块，数据只能按顺序存储在磁盘阵列的磁盘上，需要时再按顺序读取。而通过条带技术，可获得数倍与顺序访问的性能提升。</p><p>　　数据条带技术的分块大小选择非常关键。条带粒度可以是一个字节至几 KB 大小，分块越小，并行处理能力就越强，数据存取速度就越高，但同时就会增加块存取的随机性和块寻址时间。实际应用中，要根据数据特征和需求来选择合适的分块大小，在数据存取随机性和并发处理能力之间进行平衡，以争取尽可能高的整体性能。<br>数据条带是基于提高 I/O 性能而提出的，也就是说它只关注性能， 而对数据可靠性、可用性没有任何改善。实际上，其中任何一个数据条带损坏都会导致整个数据不可用，采用数据条带技术反而增加了数据发生丢失的概念率。</p><p><strong>3.3 数据校验</strong></p><p>　　镜像具有高安全性、高读性能，但冗余开销太昂贵。数据条带通过并发性来大幅提高性能，然而对数据安全性、可靠性未作考虑。数据校验是一种冗余技术，它用校验数据来提供数据的安全，可以检测数据错误，并在能力允许的前提下进行数据重构。相对镜像，数据校验大幅缩减了冗余开销，用较小的代价换取了极佳的数据完整性和可靠性。数据条带技术提供高性能，数据校验提供数据安全性， RAID 不同等级往往同时结合使用这两种技术。</p><p>　　采用数据校验时， RAID 要在写入数据同时进行校验计算，并将得到的校验数据存储在 RAID 成员磁盘中。校验数据可以集中保存在某个磁盘或分散存储在多个不同磁盘中，甚至校验数据也可以分块，不同 RAID 等级实现各不相同。当其中一部分数据出错时，就可以对剩余数据和校验数据进行反校验计算重建丢失的数据。校验技术相对于镜像技术的优势在于节省大量开销，但由于每次数据读写都要进行大量的校验运算，对计算机的运算速度要求很高，必须使用硬件 RAID 控制器。在数据重建恢复方面，检验技术比镜像技术复杂得多且慢得多。</p><p>　　海明校验码和 异或校验是两种最为常用的 数据校验算法。海明校验码是由理查德.海明提出的，不仅能检测错误，还能给出错误位置并自动纠正。海明校验的基本思想是：将有效信息按照某种规律分成若干组，对每一个组作奇偶测试并安排一个校验位，从而能提供多位检错信息，以定位错误点并纠正。可见海明校验实质上是一种多重奇偶校验。异或校验通过异或逻辑运算产生，将一个有效信息与一个给定的初始值进行异或运算，会得到校验信息。如果有效信息出现错误，通过校验信息与初始值的异或运算能还原正确的有效信息。</p><h3 id="四、RAID-等级"><a href="#四、RAID-等级" class="headerlink" title="四、RAID 等级"></a>四、RAID 等级</h3><p><strong>4.1 JBOD</strong></p><p>　　JBOD （ Just a Bunch Of Disks ）不是标准的 RAID 等级，它通常用来表示一个没有控制软件提供协调控制的磁盘集合。 JBOD 将多个物理磁盘串联起来，提供一个巨大的逻辑磁盘。 JBOD （如图 1 ）的数据存放机制是由第一块磁盘开始按顺序往后存储，当前磁盘存储空间用完后，再依次往后面的磁盘存储数据。 JBOD 存储性能完全等同于单块磁盘，而且也不提供数据安全保护。它只是简单提供一种扩展存储空间的机制， JBOD 可用存储容量等于所有成员磁盘的存储空间之和。目前 JBOD 常指磁盘柜，而不论其是否提供 RAID 功能。</p><p><img src="http://www.hack520.com/images/2017/20170621112044769.png" alt="RAID" loading="lazy"><br>图1 JBOD</p><p><strong>4.2 标准 RAID 等级</strong></p><p>　　SNIA 、 Berkeley 等组织机构把 RAID0 、 RAID1 、 RAID2 、 RAID3 、 RAID4 、 RAID5 、 RAID6 七个等级定为标准的 RAID 等级，这也被业界和学术界所公认。标准等级是最基本的 RAID 配置集合，单独或综合利用数据条带、镜像和数据校验技术。标准 RAID 可以组合，即 RAID 组合等级，满足 对性能、安全性、可靠性要求更高的存储应用需求。 [6][7][8][9][10][11]</p><p><strong>1.RAID0</strong></p><p>　　RAID0 是一种简单的、无数据校验的数据条带化技术。实际上不是一种真正的 RAID ，因为它并不提供任何形式的冗余策略。 RAID0 将所在磁盘条带化后组成大容量的存储空间（如图 2 所示），将数据分散存储在所有磁盘中，以独立访问方式实现多块磁盘的并读访问。由于可以并发执行 I/O 操作，总线带宽得到充分利用。再加上不需要进行数据校验，RAID0 的性能在所有 RAID 等级中是最高的。理论上讲，一个由 n 块磁盘组成的 RAID0 ，它的读写性能是单个磁盘性能的 n 倍，但由于总线带宽等多种因素的限制，实际的性能提升低于理论值。</p><p>　　RAID0 具有低成本、高读写性能、 100% 的高存储空间利用率等优点，但是它不提供数据冗余保护，一旦数据损坏，将无法恢复。 因此， RAID0 一般适用于对性能要求严格但对数据安全性和可靠性不高的应用，如视频、音频存储、临时数据缓存空间等。</p><p><img src="http://www.hack520.com/images/2017/20170621112044832.png" alt="RAID" loading="lazy"><br>图2 RAID0 ：无冗错的数据条带</p><p><strong>2.RAID1</strong></p><p>　　RAID1 称为镜像，它将数据完全一致地分别写到工作磁盘和镜像 磁盘，它的磁盘空间利用率为 50% 。 RAID1 在数据写入时，响应时间会有所影响，但是读数据的时候没有影响。 RAID1 提供了最佳的数据保护，一旦工作磁盘发生故障，系统自动从镜像磁盘读取数据，不会影响用户工作。工作原理如图 3 所示。</p><p>　　RAID1 与 RAID0 刚好相反，是为了增强数据安全性使两块 磁盘数据呈现完全镜像，从而达到安全性好、技术简单、管理方便。 RAID1 拥有完全容错的能力，但实现成本高。 RAID1 应用于对顺序读写性能要求高以及对数据保护极为重视的应用，如对邮件系统的数据保护。</p><p><img src="http://www.hack520.com/images/2017/20170621112044948.png" alt="RAID" loading="lazy"><br>图3 RAID1 ：无校验的相互镜像</p><p><strong>3.RAID2</strong></p><p>　　RAID2 称为纠错海明码磁盘阵列，其设计思想是利用海明码实现数据校验冗余。海明码是一种在原始数据中加入若干校验码来进行错误检测和纠正的编码技术，其中第 2n 位（ 1, 2, 4, 8, … ）是校验码，其他位置是数据码。因此在 RAID2 中，数据按位存储，每块磁盘存储一位数据编码，磁盘数量取决于所设定的数据存储宽度，可由用户设定。图 4 所示的为数据宽度为 4 的 RAID2 ，它需要 4 块数据磁盘和 3 块校验磁盘。如果是 64 位数据宽度，则需要 64 块 数据磁盘和 7 块校验磁盘。可见， RAID2 的数据宽度越大，存储空间利用率越高，但同时需要的磁盘数量也越多。</p><p>　　海明码自身具备纠错能力，因此 RAID2 可以在数据发生错误的情况下对纠正错误，保证数据的安全性。它的数据传输性能相当高，设计复杂性要低于后面介绍的 RAID3 、 RAID4 和 RAID5 。</p><p>　　但是，海明码的数据冗余开销太大，而且 RAID2 的数据输出性能受阵列中最慢磁盘驱动器的限制。再者，海明码是按位运算， RAID2 数据重建非常耗时。由于这些显著的缺陷，再加上大部分磁盘驱动器本身都具备了纠错功能，因此 RAID2 在实际中很少应用，没有形成商业产品，目前主流存储磁盘阵列均不提供 RAID2 支持。</p><p><img src="http://www.hack520.com/images/2017/20170621112045235.png" alt="RAID" loading="lazy"><br>图 4 RAID2 ：海明码校验</p><p><strong>4.RAID3</strong></p><p>　　RAID3 （图 5 ）是使用专用校验盘的并行访问阵列，它采用一个专用的磁盘作为校验盘，其余磁盘作为数据盘，数据按位可字节的方式交叉存储到各个数据盘中。RAID3 至少需要三块磁盘，不同磁盘上同一带区的数据作 XOR 校验，校验值写入校验盘中。 RAID3 完好时读性能与 RAID0 完全一致，并行从多个磁盘条带读取数据，性能非常高，同时还提供了数据容错能力。向 RAID3 写入数据时，必须计算与所有同条带的校验值，并将新校验值写入校验盘中。一次写操作包含了写数据块、读取同条带的数据块、计算校验值、写入校验值等多个操作，系统开销非常大，性能较低。</p><p>　　如果 RAID3 中某一磁盘出现故障，不会影响数据读取，可以借助校验数据和其他完好数据来重建数据。假如所要读取的数据块正好位于失效磁盘，则系统需要读取所有同一条带的数据块，并根据校验值重建丢失的数据，系统性能将受到影响。当故障磁盘被更换后，系统按相同的方式重建故障盘中的数据至新磁盘。</p><p>　　RAID3 只需要一个校验盘，阵列的存储空间利用率高，再加上并行访问的特征，能够为高带宽的大量读写提供高性能，适用大容量数据的顺序访问应用，如影像处理、流媒体服务等。目前， RAID5 算法不断改进，在大数据量读取时能够模拟 RAID3 ，而且 RAID3 在出现坏盘时性能会大幅下降，因此常使用 RAID5 替代 RAID3 来运行具有持续性、高带宽、大量读写特征的应用。</p><p><img src="http://www.hack520.com/images/2017/20170621112045398.png" alt="RAID" loading="lazy"><br>图5 RAID3 ：带有专用位校验的数据条带</p><p><strong>5.RAID4</strong></p><p>　　RAID4 与 RAID3 的原理大致相同，区别在于条带化的方式不同。 RAID4 （图 6 ）按照 块的方式来组织数据，写操作只涉及当前数据盘和校验盘两个盘，多个 I/O 请求可以同时得到处理，提高了系统性能。 RAID4 按块存储可以保证单块的完整性，可以避免受到其他磁盘上同条带产生的不利影响。</p><p>　　RAID4 在不同磁盘上的同级数据块同样使用 XOR 校验，结果存储在校验盘中。写入数据时， RAID4 按这种方式把各磁盘上的同级数据的校验值写入校验 盘，读取时进行即时校验。因此，当某块磁盘的数据块损坏， RAID4 可以通过校验值以及其他磁盘上的同级数据块进行数据重建。</p><p>　　RAID4 提供了 非常好的读性能，但单一的校验盘往往成为系统性能的瓶颈。对于写操作， RAID4 只能一个磁盘一个磁盘地写，并且还要写入校验数据，因此写性能比较差。而且随着成员磁盘数量的增加，校验盘的系统瓶颈将更加突出。正是如上这些限制和不足， RAID4 在实际应用中很少见，主流存储产品也很少使用 RAID4 保护。</p><p><img src="http://www.hack520.com/images/2017/20170621112045507.png" alt="RAID" loading="lazy"><br>图6 RAID4 ：带有专用块级校验的数据条带</p><p><strong>6.RAID5</strong></p><p>　　 RAID5 应该是目前最常见的 RAID 等级，它的原理与 RAID4 相似，区别在于校验数据分布在阵列中的所有磁盘上，而没有采用专门的校验磁盘。对于数据和校验数据，它们的写操作可以同时发生在完全不同的磁盘上。因此， RAID5 不存在 RAID4 中的并发写操作时的校验盘性能瓶颈问题。另外， RAID5 还具备很好的扩展性。当阵列磁盘 数量增加时，并行操作量的能力也随之增长，可比 RAID4 支持更多的磁盘，从而拥有更高的容量以及更高的性能。</p><p>　　RAID5 （图 7）的磁盘上同时存储数据和校验数据，数据块和对应的校验信息存保存在不同的磁盘上，当一个数据盘损坏时，系统可以根据同一条带的其他数据块和对应的校验数据来重建损坏的数据。与其他 RAID 等级一样，重建数据时， RAID5 的性能会受到较大的影响。</p><p>　　RAID5 兼顾存储性能、数据安全和存储成本等各方面因素，它可以理解为 RAID0 和 RAID1 的折中方案，是目前综合性能最佳的数据保护解决方案。 RAID5 基本上可以满足大部分的存储应用需求，数据中心大多采用它作为应用数据的保护方案。</p><p><img src="http://www.hack520.com/images/2017/20170621112045620.png" alt="RAID" loading="lazy"><br>图7 RAID5 ：带分散校验的数据条带</p><p><strong>7.RAID6</strong></p><p>　　前面所述的各个 RAID 等级都只能保护因单个磁盘失效而造成的数据丢失。如果两个磁盘同时发生故障，数据将无法恢复。 RAID6 （如图 8 ）引入双重校验的概念，它可以保护阵列中同时出现两个磁盘失效时，阵列仍能够继续工作，不会发生数据丢失。 RAID6 等级是在 RAID5 的基础上为了进一步增强数据保护而设计的一种 RAID 方式，它可以看作是一种扩展的 RAID5 等级。</p><p>　　RAID6 不仅要支持数据的恢复，还要支持校验数据的恢复，因此实现代价很高，控制器的设计也比其他等级更复杂、更昂贵。 RAID6 思想最常见的实现方式是采用两个独立的校验算法，假设称为 P 和 Q ，校验数据可以分别存储在两个不同的校验盘上，或者分散存储在所有成员磁盘中。当两个磁盘同时失效时，即可通过求解两元方程来重建两个磁盘上的数据。</p><p>　　RAID6 具有快速的读取性能、更高的容错能力。但是，它的成本要高于 RAID5 许多，写性能也较差，并有设计和实施非常复杂。因此， RAID6 很少得到实际应用，主要用于对数据安全等级要求非常高的场合。它一般是替代 RAID10 方案的经济性选择。</p><p><img src="http://www.hack520.com/images/2017/20170621112045706.png" alt="RAID" loading="lazy"><br>图8 RAID6 ：带双重分散校验的数据条带</p><p><strong>4.3 RAID 组合等级</strong></p><p>　　标准 RAID 等级各有优势和不足。自然地，我们想到把多个 RAID 等级组合起来，实现优势互补，弥补相互的不足，从而达到在性能、数据安全性等指标上更高的 RAID 系统。目前在业界和学术研究中提到的 RAID 组合等级主要有 RAID00 、 RAID01 、 RAID10 、 RAID100 、 RAID30 、 RAID50 、 RAID53 、 RAID60 ，但实际得到较为广泛应用的只有 RAID01 和 RAID10 两个等级。当然，组合等级的实现成本一般都非常昂贵，只是在 少数特定场合应用。 [12]</p><p><strong>1.RAID00</strong></p><p>　　简单地说， RAID00 是由多个成员 RAID0 组成的高级 RAID0 。它与 RAID0 的区别在于， RAID0 阵列替换了原先的成员磁盘。可以把 RAID00 理解为两层条带化结构的磁盘阵列，即对条带再进行条带化。这种阵列可以提供更大的存储容量、更高的 I/O 性能和更好的 I/O 负均衡。</p><p><strong>2. RAID01 和 RAID10</strong></p><p>　　一些文献把这两种 RAID 等级看作是等同的，本文认为是不同的。 RAID01 是先做条带化再作镜像，本质是对物理磁盘实现镜像；而 RAID10 是先做镜像再作条带化，是对虚拟磁盘实现镜像。相同的配置下，通常 RAID01 比 RAID10 具有更好的容错能力，原理如图 9 所示。</p><p>　　RAID01 兼备了 RAID0 和 RAID1 的优点，它先用两块磁盘建立镜像，然后再在镜像内部做条带化。 RAID01 的数据将同时写入到两个磁盘阵列中，如果其中一个阵列损坏，仍可继续工作，保证数据安全性的同时又提高了性能。 RAID01 和 RAID10 内部都含有 RAID1 模式，因此整体磁盘利用率均仅为 50% 。</p><p><img src="http://www.hack520.com/images/2017/20170621112045783.png" alt="RAID" loading="lazy"><br><img src="http://www.hack520.com/images/2017/20170621112045812.png" alt="RAID" loading="lazy"><br>图 9 典型的 RAID01 （上）和 RAID10 （下）模型</p><p><strong>3.RAID100</strong></p><p>　　通常看作 RAID 1+0+0 ，有时也称为 RAID 10+0 ，即条带化的 RAID10 。原理如图 10 所示。 RAID100 的缺陷与 RAID10 相同，任意一个 RAID1 损坏一个磁盘不会发生数据丢失，但是剩下的磁盘存在单点故障的危险。最顶层的 RAID0 ，即条带化任务，通常由软件层来完成。</p><p>　　RAID100 突破了单个 RAID 控制器对物理磁盘数量的限制，可以获得更高的 I/O 负载均衡， I/O 压力分散到更多的磁盘上，进一步提高随机读性能，并有效降低热点盘故障风险。因此， RAID100 通常是大数据库的最佳选择。</p><p><img src="http://www.hack520.com/images/2017/2017062111204647.png" alt="RAID" loading="lazy"><br>图10 典型的 RAID100 模型</p><p><strong>4.RAID30 （ RAID53 ）、 RAID50 和 RAID60</strong></p><p>　　这三种 RAID 等级与 RAID00 原理基本相同，区别在于成员 “ 磁盘 ” 换成了 RAID3 、 RAID5 和 RAID6 ，分别如图 11 、 12 、 13 所示。其中， RAID30 通常又被称为 RAID53[13] 。其实，可把这些等级 RAID 统称为 RAID X0 等级， X 可为标准 RAID 等级，甚至组合等级（如 RAID100 ）。利用多层 RAID 配置，充分利用 RAID X 与 RAID0 的优点，从而获得在存储容量、数据安全性和 I/O 负载均衡等方面的大幅性能提升。</p><p><img src="http://www.hack520.com/images/2017/20170621112046191.png" alt="RAID" loading="lazy"><br>图11 典型的 RAID50 模型</p><p><img src="http://www.hack520.com/images/2017/20170621112046378.png" alt="RAID" loading="lazy"><br>图12 典型的 RAID50 模型</p><p><img src="http://www.hack520.com/images/2017/20170621112046473.png" alt="RAID" loading="lazy"><br>图13 典型的 RAID60 模型</p><p><strong>4.4 非标准 RAID 等级</strong></p><p>　　虽然标准 RAID 和组合 RAID 在具体实现上存在一定程度的不同，但与标准规范是保持一致或兼容的。然而除此之外，一些存储厂商还实现了非标准的 RAID 等级，往往都是公司私有的产品。这里简单介绍几个非标准 RAID 等级。 [14]</p><p><strong>1.RAID7</strong></p><p>　　RAID7 的全称是最优化的异步高 I/O 速率和高数据传输率，它与其他 RAID 等级有着明显区别。它不仅仅是一种技术，它还是一个独立存储计算机，自身带的操作系统和管理工具，完全可以独立运行。</p><p>　　RAID7 的存储计算机操作系统是一套实时事件驱动操作系统，其主要用来进行系统初始化和安排 RAID7 磁盘阵列的所有数据传输，并把它们转换到相应的物理存储驱动器上。 RAID7 通过自身系统中的专用控制板来控制读写速度，存储计算机操作系统可使主机 I/O 传递性能达到最佳。如果一个磁盘出现故障， RAID7 还能够自动执行恢复操作，并可管理备份磁盘的重建过程。</p><p>　　RAID7 突破了以往 RAID 标准的技术架构，采用了非同步访问，极大地减轻了数据写瓶颈，提高了 I/O 速度。 RAID7 系统内置实时操作系统还可自动对主机发送过来的读写指令进行优化处理，以智能化方式将可能被读取的数据预先读入快速缓存中，从而大大减少了磁头的转动次数，提高存储系统的 I/O 速度。</p><p>　　RAID7 可帮助用户有效地管理日益庞大的数据存储系统，并使系统的运行效率大大提高，满足不同用户的存储需求。但是， RAID7 的成本比其他 RAID 等级要高许多。另外， RAID7 已被某公司注册为商标，目前仅有一家公司提供 RAID7 的产品，用户没有更多的选择。技术封闭，缺乏主流专业存储厂商的参与和研发严重制约了 RAID7 的发展。</p><p><strong>2.RAID-DP</strong></p><p>　　按照 SNIA 最新的 RAID6 定义 [15] ，双重数据校验的磁盘阵列都可归为 RAID6 等级。 NetApp 公司按照 RAID6 的定义实现了 RAID-DP ，使用双重的数据校验来保护数据，可以保证两块磁盘同时损坏的情况下不发生数据丢失。与该公司的 RAID4 实现对比，传统的 RAID6 实现会致使系统性能损失 30% 左右，而 RAID-DP 的性能下降低于 2% 。上层文件系统的请求首先写入后端的 NVRAM 中，确保即使在 掉电的情况下也不会有任何数据丢失。因此，数据块不会立即更新，当执行新来的写操作，会对写操作进行聚集，然后存储控制器尝试一次性写入包括校验数据在内的整个数据条带。 RAID-DP 提供了比 RAID10 更好的数据保护，性能却不低于 RAID10 。对于相同大小的 RAID 组，在大多数情况下， RAID-DP 没有受到传统 RAID6 即时更新数据块的挑战，并提供更多的磁盘进行读写。它甚至允许磁盘固件实时更新而不发生任何中断。</p><p><strong>3.RAID1.5</strong></p><p>　　这是 HighPoint 公司的 RAID 产品，有时也被错误地称为 RAID15 。 RAID1.5 仅使用两个磁盘驱动器同时进行数据条带化和镜像，数据可以同时从两块磁盘进行读取。这其中的大部分工作都由硬件来完成，而非驱动程序。 Linux 、 Solaris 等操作系统实现的 RAID1 也可以实现同时从两块磁盘进行读取数据，因此 RAID1.5 并不优于传统的　RAID1。</p><p><strong>4. RAID5E 、 RAID5EE 和 RAID6E</strong></p><p>　　这种概念首次在 IBM ServerRAID 中被提出， E 是 Enhanced 的首字母。它们分别是对 RAID5 和 RAID6 的增强，增加了热冗余磁盘驱动器，冗余磁盘与其他磁盘一块进行数据块编排。这种设计使得 I/O 可以分散到包括热冗余在内的所在磁盘，从而减小单块磁盘的 I/O 带宽， 提供更高的性能。然而，热冗余磁盘不能够被多个阵列共享。</p><p>　　在实现中，实际上不存在专用的热冗余磁盘，就像 RAID5 和 RAID6 中没有专用的校验磁盘一样，所有的冗余数据块分布在所的成员磁盘中。例如，一个 10 块磁盘的 RAID5E ，包括 80% 数据块、 10% 的冗余数据块和 10% 的校验数据。对于 RAID5E 和 RAID6E ，冗余数据块位于阵列尾部，而 RAID5EE 则分布在整个 RAID 中。如果 RAID5E/5EE 中发生一块磁盘损坏，则系统会自动降级并重建至标准的 RAID5 。这一过程中， I/O 操作非常密集，并且需要花费大量时间，从几个小时至甚至几天，根据阵列的具体配置而异。当损坏磁盘被替换后，系统则又会自动升级并重建至原先的 RAID5E/5EE ，同时非常耗时。在上面的重建过程中，数据没有冗余保护。由于系统升级和降级时， I/O 活动密集且所需时间过长，因此实际应用中成员磁盘数据限制在 4~8 块。一旦超过 8 块磁盘，由于损坏磁盘的重建耗时和重建中发生第二块磁盘损坏造成的数据丢失， RAID5E/5EE 所获得的性能提升和其他获益都将严重降低。</p><p><strong>5.RAID S (Parity RAID)</strong></p><p>　　 RAID S 是 EMC 公司的 Symmetrix 存储系统所使用的条带化校验 RAID 。该系统中，每个卷位于单独的物理磁盘上，多个卷组合进行数据校验。 EMC 最早引入了 RAID S 概念，后来改名为 Parity RAID 并应用于 Symmetrix DMX 平台。 EMC 现在也为 Symmetrix DMX 提供标准的 RAID5 ， RAID S 已经不再 EMC 产品中使用。</p><p><strong>6.Intel Matrix RAID</strong></p><p>　　 Matrix RAID 是 Intel ICH6R 和后继的南桥芯片的一个重要特征，可以通过 RAID <a href="http://www.hack520.com/topic/bios/">BIOS</a> 进行访问。它使用两块磁盘或者控制器能支持的最多磁盘，它的显著特征是允许 RAID0 、 1 、 5 、 10 多种数据卷混合共存，每块磁盘的指定部分分配给相应的 RAID 卷。 Matrix RAID 主要用于改善性能和数据完整性，实际应用中可以将操作系统应用于小的 RAID0 ，而大的 RAID1 存储关键数据以及用户数据。海量的流媒体数据容易发生数据丢失，可以考虑使用这种 RAID 。 linux 的 MD RAID 也可以实现类似的功能。</p><p><strong>7.Linux MD RAID 10</strong></p><p>　　RAID 10 是 Linux 内核所支持的软 RAID 等级之一，它还支持 RAID0、1、3、4、5、6 等级别。软 RAID 驱动程序通常通过构造典型的 RAID1+0 阵开来实现 RAID10 ， 2.6.9 以后的内核也可作为单独的级别来实现。</p><p>　　MD RAID10 支持重复数据块的近布局和远布局两种模式。近布局与标准 RAID10 相同，镜像数据块相邻存储。对于 n 重镜像的 k 路条带，不要求 k 为 n 的 整倍数。两重镜像的2、3、4路条带的 MD RAID10 分布相当于 RAID1 、 RAID-1E 和 RAID10 。远布局模式下，所有磁盘被划分为 f （ f= 镜像数）个数据存储区，重复数据块相对于原始数据块具有一个磁盘和若干依偏移的距离，即保存在下一个磁盘对应存储区的偏移位置。这种设计能够提高镜像阵列的条带性能，有效提高顺序和随机读性能，但对写性能没有显著提升。许多应该通常具有读密集而写稀疏的特点， RAID10 适合此类数据应用。需要指出的是，近布局和远布局两种模式可以同时使用，这种情况下将有 n * f 个数据副本。</p><p><strong>8. IBM ServerRAID 1E</strong></p><p>　　 IBM 公司的 ServerRAID 阵列卡系列支持任意数量驱动器上的两路镜像，多个磁盘对数据块进行轮转镜像。这种配置能够对不相邻磁盘驱动器发生的损坏进行容错，其他的存储系统也支持这种模式，比如 SUN 公司的 StorEdge T3 。</p><p><strong>9.RAID-K</strong></p><p>　　 Kaleidescape 公司实现了一种称为 RAID-K[16] 的 RAID 类型。 RAID-K 与 RAID4 相似，但不对文件数据进行块级的条带化处理，它企图将整个电影或音乐集合完整地存储在单个磁盘上。另外，它的冗余校验信息可存储在多个磁盘上，从而适应由多个容量不同的磁盘所组成的逻辑磁盘。而且，冗余数据包含比校验信息更多的数据，用于获取更高的容错性。这些特征可以为影像、音乐提供更好的性能，增加数据存储的安全性。 RAID-K 还可以允许用户以增量方式扩充存储容量，能够增加容量更大的磁盘，甚至它还可以增加包含数据（仅限影像和音乐）的磁盘。 RAID-K 会自动把这些磁盘组建成 RAID-K 阵列和 Kaleidescape 文件系统。</p><p><strong>10. RAID-Z</strong></p><p>　　 RAID-Z 是集成在 SUN 公司 ZFS 文件系统中的一种与 RAID5 相似的 RAID 模式。利用写时复制策略， RAID-Z 避免了 RAID5 的写操作困境（即更新数据同时需要更新校验数据），它不用新数据覆盖旧数据，而是把新数据写到新位置并自动更新数据指针。对于小的写操作，仅仅执行完全的写条带操作，有效避免 “ 读取－更改－写回 ” 的操作需求。另外，还可以直接对小写操作使用镜像替换校验进行保护，因为文件系统了解下层存储结构，可以在必要时分配 额外存储空间。 ZFS 还实现了 RAID-Z2 ，提供类似与 RAID6 的双重校验保护能力，可以保证不块磁盘发生损坏而不发生数据丢失。根据 2009 年 6 月的更新， ZFS 加入了三重校验 RAID 支持，或许称为 RAID-Z3 。</p><h3 id="五、实现方式"><a href="#五、实现方式" class="headerlink" title="五、实现方式"></a>五、实现方式</h3><p>　　通常计算机功能既可以由硬件来实现，也可以由软件来实现。对于 RAID 系统而言，自然也不例外，它可以采用软件方式实现，也可以采用硬件方式实现，或者采用软硬结合的方式实现。 [3][8]</p><p><strong>5.1 软 RAID</strong></p><p>　　软 RAID 没有专用的控制芯片和 I/O 芯片，完全由操作系统和 CPU 来实现所的 RAID 的功能。现代操作系统基本上都提供软 RAID 支持，通过在磁盘设备驱动程序上添加一个软件层，提供一个物理驱动器与逻辑驱动器之间的抽象层。目前，操作系统支持的最常见的 RAID 等级有 RAID0 、 RAID1 、 RAID10 、 RAID01 和 RAID5 等。比如， Windows Server 支持 RAID0 、 RAID1 和 RAID5 三种等级， Linux 支持 RAID0 、 RAID1 、 RAID4 、 RAID5 、 RAID6 等， Mac OS X Server 、 FreeBSD 、 NetBSD 、 OpenBSD 、 Solaris 等操作系统也都支持相应的 RAID 等级。</p><p>　　软 RAID 的配置管理和<a href="http://www.hack520.com/topic/data-recovery/">数据恢复</a>都比较简单，但是 RAID 所有任务的处理完全由 CPU 来完成，如计算校验值，所以执行效率比较低下，这种方式需要消耗大量的运算资源，支持 RAID 模式 较少，很难广泛应用。</p><p>　　软 RAID 由操作系统来实现，因此系统所在分区不能作为 RAID 的逻辑成员磁盘，软 RAID 不能保护系统盘 D 。对于部分操作系统而言， RAID 的配置信息保存在系统信息中，而不是单独以文件形式保存在磁盘上。这样当系统意外崩溃而需要重新安装时， RAID 信息就会丢失。另外，磁盘的容错技术并不等于完全支持在线更换、热插拔或热交换，能否支持错误磁盘的热交换与操作系统实现相关，有的操作系统热交换。</p><p><strong>5.2 硬 RAID</strong></p><p>　　硬 RAID 拥有自己的 RAID 控制处理与 I/O 处理芯片，甚至还有阵列缓冲，对 CPU 的占用率和整体性能是三类实现中最优的，但实现成本也最高的。硬 RAID 通常都支持热交换技术，在系统运行下更换故障磁盘。<br>　　<br>　　硬 RAID 包含 RAID 卡和主板上集成的 RAID 芯片， 服务器平台多采用 RAID 卡。 RAID 卡由 RAID 核心处理芯片（ RAID 卡上的 CPU ）、端口、缓存和电池 4 部分组成。其中，端口是指 RAID 卡支持的磁盘接口类型，如 IDE/ATA 、 SCSI 、 SATA 、 SAS 、 FC 等接口。</p><p><strong>5.3 软硬混合 RAID</strong></p><p>　　软 RAID 性能欠佳，而且不能保护系统分区，因此很难应用于桌面系统。而硬 RAID 成本非常昂贵，不同 RAID 相互独立，不具互操作性。因此，人们采取软件与硬件结合的方式来实现 RAID ，从而获得在性能和成本上的一个折中，即较高的性价比。</p><p>　　这种 RAID 虽然采用了处理控制芯片，但是为了节省成本，芯片往往比较廉价且处理能力较弱， RAID 的任务处理大部分还是通过固件驱动程序由 CPU 来完成。</p><h3 id="六、RAID-应用选择"><a href="#六、RAID-应用选择" class="headerlink" title="六、RAID 应用选择"></a>六、RAID 应用选择</h3><p>　　RAID 等级的选择主要有三个因素，即数据可用性、 I/O 性能和成本。　目前，在实际应用中常见的主流 RAID 等级是 RAID0 ， RAID1 ， RAID3 ， RAID5 ， RAID6 和 RAID10 ，它们之间的技术对比情况如表 1 所示。如果不要求可用性，选择 RAID0 以获得高性能。如果可用性和性能是重要的，而成本不是一个主要因素，则根据磁盘数量选择 RAID1 。如果可用性，成本和性能都同样重要，则根据一般的数据传输和磁盘数量选择 RAID3 或 RAID5 。在实际应用中，应当根据用户的数据应用特点和具体情况，综合考虑可用性、性能和成本来选择合适的 RAID 等级。 [10]</p><p><strong>表1 主流 RAID 等级技术对比</strong></p><table><thead><tr><th><strong>RAID</strong> <strong>等级</strong></th><th><strong>RAID0</strong></th><th><strong>RAID1</strong></th><th><strong>RAID3</strong></th><th><strong>RAID5</strong></th><th><strong>RAID6</strong></th><th><strong>RAID10</strong></th></tr></thead><tbody><tr><td><strong>别名</strong></td><td>条带</td><td>镜像</td><td>专用奇偶校验条带</td><td>分布奇偶校验条带</td><td>双重奇偶校验条带</td><td>镜像加条带</td></tr><tr><td><strong>容错性</strong></td><td>无</td><td>有</td><td>有</td><td>有</td><td>有</td><td>有</td></tr><tr><td><strong>冗余类型</strong></td><td>无</td><td>有</td><td>有</td><td>有</td><td>有</td><td>有</td></tr><tr><td><strong>热备份选择</strong></td><td>无</td><td>有</td><td>有</td><td>有</td><td>有</td><td>有</td></tr><tr><td><strong>读性能</strong></td><td>高</td><td>低</td><td>高</td><td>高</td><td>高</td><td>高</td></tr><tr><td><strong>随机写性能</strong></td><td>高</td><td>低</td><td>低</td><td>一般</td><td>低</td><td>一般</td></tr><tr><td><strong>连续写性能</strong></td><td>高</td><td>低</td><td>低</td><td>低</td><td>低</td><td>一般</td></tr><tr><td><strong>需要磁盘数</strong></td><td>n≥1</td><td>2n (n≥1)</td><td>n≥3</td><td>n≥3</td><td>n≥4</td><td>2n(n≥2)≥4</td></tr><tr><td><strong>可用容量</strong></td><td>全部</td><td>50%</td><td>(n-1)/n</td><td>(n-1)/n</td><td>(n-2)/n</td><td>50%</td></tr></tbody></table><p>　　近年来，企业的信息化水平不断发展，数据已经取代计算成为了信息计算的中心，信息数据的安全性就显得尤为至关重要。随着存储技术的持续发展， RAID 技术在成本、性能、数据安全性等诸多方面都将优于其他存储技术，例如磁带库、光盘库等，大多数企业数据中心首选 RAID 作为存储系统。当前存储行业的知名存储厂商均提供全线的磁盘阵列产品，包括面向个人和中小企业的入门级的低端 RAID 产品，面向大中型企业的中高端 RAID 产品。这些存储企业包括了国内外的主流存储厂商，如 EMC 、 IBM 、 HP 、 SUN 、 NetApp 、 NEC 、 HDS 、 H3C 、 Infortrend 、华赛等。另外，这些厂商在提供存储硬件系统的同时，还往往提供非常全面的软件系统，这也是用户采购产品的一个主要参考因素。</p><p>　　不同的存储厂商的产品在技术、成本、性能、管理、服务等方面各有优势和不足。用户选择 RAID 的原则是：在成本预算内，满足数据存储需求的前提下，选择最优的存储厂商解决方案。因此，首先用户需要对存储需求作深入的调研和分析，并给出成本预算，然后对众多存储厂商的解决方案进行分析和对比，最后选择出一个综合最优的存储方案。其中，存储产品的扩展性和存储厂家的售后服务需要重点考察，存储需求（如容量、性能）可能会不断升级，存储产品发生故障后的维修和支持保障，这些都要未雨先缪。</p><h3 id="七、总结与展望"><a href="#七、总结与展望" class="headerlink" title="七、总结与展望"></a>七、总结与展望</h3><p>　　回顾 RAID 发展历史，从首次提出概念至今已有二十多年。在此期间，整个社会信息化水平不断提高，数据呈现爆炸式增长趋势，数据取代计算成为信息计算的中心。这促使人们对数据愈加重视，不断追求海量存储容量、高性能、高 安全性、高可用性、可扩展性、可管理性等等。 RAID 技术在这样强大的存储需求推动下不断发展进步，时至今日技术已经非常成熟，在各种数据存储系统中得到了十分广泛的应用。<br>　　<br>　　正是由于技术发展的成熟， RAID 技术的未来发展已经不被广泛看好，甚至预言在不久的将来会停止发展，称之为 “ 僵尸技术 ” ，即虽然宣布死亡，但在很长一段时间内仍会继续发挥巨大的价值。<br>　　<br>　　然而，当前的 RAID 技术仍然存在诸多不足，各种 RAID 模式都存在自身的缺陷，主要集中在读写性能、实现成本、恢复时间窗口、多磁盘损坏等方面。因此， RAID 技术显然还存在很大的提升空间，具有很大的发展潜力。近年来新出现的 RAID 模式以及学术研究显示了其未来的发展趋势，包括分布式校验、多重校验、混合 RAID 模式、水平和垂直条带、基于固态内存 RAID 、网络校验等等。特别指出的是，多核 CPU 和 GPU 是当前的热点技术，它们大幅提升了主机的可用计算资源，这可以解决 RAID 对计算资源的消耗问题，软 RAID 很可能将重新成为热点。另外，存储硬件性能的提升、存储虚拟化技术、重复数据删除技术以及其他存储技术都会极大地推动 RAID 技术的进一步创新和发展。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="RAID" scheme="https://zeozzz.github.com/categories/RAID/"/>
    
    
      <category term="RAID" scheme="https://zeozzz.github.com/tags/RAID/"/>
    
  </entry>
  
  <entry>
    <title>为什么你家里的网速慢？答案全在这里</title>
    <link href="https://zeozzz.github.com/2019/06/11/57/"/>
    <id>https://zeozzz.github.com/2019/06/11/57/</id>
    <published>2019-06-11T01:57:40.000Z</published>
    <updated>2019-06-11T02:00:04.290Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>“什么破网络？不是说好的100M吗？&amp;*￥#%……”</p><p>这样的投诉事件多次上演，科普一下“网速为什么慢”很必要。</p><p>1 你家的宽带是怎样访问互联网的？</p><p>如果把上网比喻为自来水供水，整个过程无非就是由三部分组成：水源、供水管道和茶壶。</p><p>水源就是你访问的互联网网站，供水管道就是运营商的网络，茶壶就是你家里电脑、平板等上网设备。</p><p>水要流到你的茶壶里，其实是一个非常复杂的过程。宽带网络是一个极其复杂的端到端系统，当你坐在家里上网时，数据要经流多个网络节点才能到达你的电脑或手机，如下图所示：</p><p><img src="https://n.sinaimg.cn/translate/483/w580h703/20180322/EaT3-fysnevk8046818.jpg" alt="img" loading="lazy"></p><p>图中蓝色和红色路径正是你访问互联网网站时的数据走向示意图。</p><p>首先你访问的网站托管在运营商的IDC机房</p><p><img src="https://n.sinaimg.cn/translate/471/w710h561/20180322/tO90-fysnevk8046886.jpg" alt="img" loading="lazy"></p><p>访问网站的数据由运营商的国家骨干网传送到省骨干网，若你访问的网站托管在另一家运营商的IDC机房，这中间还需要运营商之间的互联互通链路</p><p><img src="https://n.sinaimg.cn/translate/80/w720h960/20180322/PMnV-fysnevk8047324.jpg" alt="img" loading="lazy"></p><p>▲核心网路由器</p><p>数据经过各种国家骨干网、省骨干网、地市城域网的核心网路由器多跳转发后，再通过SR/BRAS来到接入网的OLT…</p><p><img src="https://n.sinaimg.cn/translate/80/w720h960/20180322/aIlB-fysnevk8047448.jpg" alt="img" loading="lazy"></p><p>▲OLT设备</p><p>再经过光分器连接到ONU，再连接到WiFi路由器，WiFi无线网络再将数据传送到你的电脑、平板或手机。</p><p>现在你终于可以上网了。这背后除了网络内无数的通信设备，还有一群苦逼的通信维护工程师…</p><p><img src="https://n.sinaimg.cn/translate/343/w588h555/20180322/ESEQ-fysnevk8047490.jpg" alt="img" loading="lazy"></p><p>现在，根据水流的路径，我们来看看是什么影响了你的网速。</p><p>简单的讲，影响用户上网网速主要涉及用户端、网络、网站三个环节，每个环节出现问题，都可能引起上网不畅。</p><p>2 用户端问题导致网速慢</p><p>用户端指的是从WiFi路由器到电脑、平板、手机等上网设备这一段。从用户投诉情况来看，“网速太慢”的投诉有90%以上是由用户端原因造成。</p><p>宽带运营商就像是自来水公司，他们将水输送到你家里，WiFi路由器就像是你家里的连接水龙头、淋浴花洒等的内部水管道。与自来水公司不同的是，即使你家里的“内部管道”出了问题，运营商的维护工程师们也会尽力帮你维修，但他们能做的也只有这些了，如果你家的水龙头、淋浴花洒等质量有问题，他们也无能为力，这需要你更换质量更好的设备。</p><p>这些问题主要包括：</p><p>1）终端上网设备硬件老旧、性能较低。如果电脑网卡性能差、内存不够等，将导致无法达到最高网速。比如，宽带升级到了200M，但是电脑网卡还是10-100M的，网速当然不达标。</p><p>2）终端设备软件问题，比如浏览器插件过多、电脑感染病毒、木马等都会影响网速。</p><p>3）配置不当，比如DNS配置错误，用户错误配置DNS可能会造成跨营运商、跨地区访问而导致上网慢，这种情况经常发生在用户更换运营商后。正确的方法是应该在电脑或路由器上使用本地运营商的DNS地址，如果不知道本地运营商的DNS地址，可采用自动获取DNS或者拨打宽带客服电话咨询。</p><p>4）线缆问题，如网线、水晶头损坏、老化或质量差等。</p><p>5）WiFi路由器问题</p><p>WiFi路由器问题是导致网速慢的常见原因，如何让你的WiFi运行良好，让网速飞起来，建议如下：</p><p>①选择正确的安装位置</p><p>如果你家的WiFi太慢，别激动，请深呼吸，再抬头看看你家的灯泡。如果你想让房间里的每个角落都被照亮，你会将灯泡安装在哪里？</p><p><img src="https://n.sinaimg.cn/translate/529/w209h320/20180322/STKG-fysnevk8047523.jpg" alt="img" loading="lazy"></p><p>Wi-Fi就像一个灯泡：如果你想要更好的信号覆盖，更快的网速，请尽可能把它安装在更好的位置。</p><p>这是一张WiFi信号的传播路径图…</p><p><img src="https://n.sinaimg.cn/translate/469/w300h169/20180322/WidU-fysnevk8047601.gif" alt="img" loading="lazy"></p><p>你可以看到WiFi信号不但要遭受墙壁的反射，还会因墙壁或其他障碍物阻挡而变得越来越弱，室内信号不能到达的覆盖盲区也是清晰可见的。</p><p>所以，如果你想上网速度快，尤其是要享受高清的IPTV电视，请多给WiFi路由器一点特权，就像你刚买了一幅漂亮的画，把它挂在客厅里最显眼的位置，而不是放在角落或隐藏在壁橱中。</p><p>此外，WiFi使用无线电波工作，任何可能发射无线电波的电子设备都可能会干扰你的WiFi连接，比如电视机、微波炉、无绳电话等，请让你的WiFi路由器尽可能远离这些设备。</p><p>②合理选择WiFi路由器</p><p>刚才说了，要想高速上网，你应该重视你家里的WiFi路由器，这包括选择一个质量更好的设备。</p><p>据统计，有80%以上的用户使用100元以下的WiFi路由器，而这个价格的路由器故障率普遍在15%以上，而100元以上的路由器故障率要低很多，在10%以下。</p><p>在购买WiFi路由器时，也请认准其支持的WiFi协议，不同的WiFi协议支持的最高网速是不一样的，可参考下表：</p><p><img src="https://n.sinaimg.cn/translate/20/w600h220/20180322/CPIz-fysnevk8047692.jpg" alt="img" loading="lazy"></p><p>另外，相对于2.4GHz，支持5GHz的路由器通常速率更高，但覆盖距离更短；更多的MIMO技术可支持更快的速率。</p><p>如今网络已经像水、电一样成为人们日常生活不可或缺的一部分，就像你家装修时通常会选择质量更好的水管、电线一样，选择质量更佳的路由器，把它安装在更合理的位置，我们认为网络时代的“内部水管”同样应该值得重视。</p><p>3 网络问题导致上网速度慢</p><p>网络部分是指从ONU到运营商IDC机房部分。通常的原因如下：</p><p>1）ONU光功率不达标等原因</p><p>ONU接收光功率范围为-8dBm~-24dBm，如果超出此范围的话就会导致设备无法上线。</p><p>OLT通过光纤、分光器、熔接头等设备连接到ONU，其间分光器损耗、熔接损耗、光纤传输损耗等将影响ONU的接收光功率，当ONU接收光功率小于-24dBm时，维护人员通常会检查ONU光纤头有无污损、入户光纤是否折损、ONU硬件是否有故障等。</p><p><img src="https://n.sinaimg.cn/translate/671/w445h226/20180322/HTQU-fysnevk8047745.png" alt="img" loading="lazy"></p><p>因此，光纤入户后请注意：</p><p>①不要弯折扭绞光纤，光纤曲率半径不能小于4cm，否则衰耗过大影响上网速率甚至不能连接网络。</p><p>②注意光猫的通风、防潮、勿摔，运行环境温度不能高于45度以上，建议避开大功率电气设备，如冰箱、空调等，以免干扰光猫设备正常运行。</p><p>③若无法上网时，请先查看光猫的POWER（电源指示灯）是否常亮，确认光猫电源开关是否打开，电源线是否连接。当LINK /LOS灯（链路状态指示灯）不亮时，可判断为运营商网络的光路故障。</p><p>2）网络拥塞、设备处理能力不足等原因</p><p>这包括PON口下挂用户超限、OLT设备上联带宽利用率和PTN环网利用率过高（超过70%）等造成流量拥塞、丢包，并导致网速下降，主要表现为白天闲时网速较快，而到晚间忙时，小区同时上网用户增加时，网速明显感觉下降，为此运营商通常会选择扩容的方式来解决。</p><p>3）互联互通、缓存、CDN、IDC等原因</p><p>运营商的网络就是通往互联网公司服务器（如百度、阿里、腾讯等）的管道，服务器托管在运营商的IDC机房，如果A运营商的IDC机房引入了XXX网站，而你家里用的是B运营商的宽带，现在你要访问XXX网站，就需要A运营商和B运营商网络之间互联互通，同时，B运营商还得向A运营商支付网间结算费用。受制于别人，B运营商一定会感觉很不爽。</p><p>这中间涉及到的运营商间的IDC出口带宽不足也会导致用户上网速度慢。</p><p>因此，B运营商采取的策略是：大力建设IDC，大力引入互联网内容，目标就是为了提升用户上网速率和感知。</p><p>另外，CDN（内容分发网络）的基本原则是将热门内容资源下沉到离用户最近的地方，节省主干网、核心网的传输带宽，使用户可就近取得所需内容，提高访问速率。CDN是视频时代、IPTV+宽带战略不可或缺的应用基础设施，在提升用户感知上发挥着重要的作用。</p><p>4 网站问题</p><p>网站问题包括：网站本身接入带宽不足、服务器处理能力不足，网站页面设计不合理，页面插件多等。</p><p>运营商根据互联网公司的接入带宽来连接网站或服务器，像自来水管一样，这个接入带宽决定了出水速度，若接入带宽过低，且有大量用户涌入时，你感受到的上网速率就会下降，同时服务器处理能力不足，也将导致反应速度慢，影响上网感知。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="TIPS" scheme="https://zeozzz.github.com/categories/TIPS/"/>
    
    
      <category term="知识" scheme="https://zeozzz.github.com/tags/%E7%9F%A5%E8%AF%86/"/>
    
  </entry>
  
</feed>
